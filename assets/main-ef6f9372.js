var qt=Object.defineProperty;var Ft=(S,t,n)=>t in S?qt(S,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):S[t]=n;var D=(S,t,n)=>(Ft(S,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var a=(S=>(S.NONE="NONE",S.WATER="WATER",S.GRASS="GRASS",S.FOREST="FOREST",S.BOG="BOG",S.HILLS="HILLS",S.MOUNTAIN="MOUNTAIN",S.IMPASSABLE="IMPASSABLE",S.CLOUD="CLOUD",S.TOWN1="TOWN1",S.TOWN2="TOWN2",S.TOWN3="TOWN3",S.HARBOR="HARBOR",S.SHIPS="SHIPS",S.LIGHTTOWER="LIGHTTOWER",S.TREE="TREE",S.MINE="MINE",S.CUSTOM="CUSTOM",S))(a||{});const Wt=new Set(["TOWN1","TOWN2","TOWN3","HARBOR","SHIPS","LIGHTTOWER","TREE","MINE"]),Nt=new Set(["TOWN1","TOWN2","TOWN3","LIGHTTOWER","TREE"]);class St{constructor(t,n,e){D(this,"hexSize");D(this,"width");D(this,"height");this.hexSize=t,this.width=n,this.height=e}calculateHexVertices(t){const n=[];for(let e=0;e<6;e++){const i=Math.PI/3*e;n.push({x:t.x+this.hexSize*Math.cos(i),y:t.y+this.hexSize*Math.sin(i)})}return n}generateGrid(t=0){const n=[],e=this.hexSize*2,i=this.hexSize*Math.sqrt(3),s=e*3/4,o=i,r=Math.floor(this.width/(this.hexSize*2*3/4)),m=Math.floor(this.height/(this.hexSize*Math.sqrt(3))),h=r*s,c=m*o,l=-h/2,g=-c/2;for(let f=0;f<r;f++){const p=(t%2===1?f+1:f)%2*(o/2);for(let d=0;d<m;d++){const b={x:l+f*s,y:g+d*o+p};n.push({coord:{q:f,r:d},terrain:a.NONE,center:b,vertices:this.calculateHexVertices(b)})}}return n}pixelToAxial(t,n){const e=(Math.sqrt(3)/3*t-n/3)/this.hexSize,i=n*2/3/this.hexSize;return{q:e,r:i}}axialToPixel(t){const n=this.hexSize*(Math.sqrt(3)*t.q+Math.sqrt(3)/2*t.r),e=this.hexSize*(3/2*t.r);return{x:n,y:e}}roundAxial(t){let n=Math.round(t.q),e=Math.round(t.r);const i=Math.abs(n-t.q),s=Math.abs(e-t.r);return i>s&&(n=-e),{q:n,r:e}}hexDistance(t,n){return Math.max(Math.abs(t.q-n.q),Math.abs(t.r-n.r))}lerpAxial(t,n,e){return{q:t.q*(1-e)+n.q*e,r:t.r*(1-e)+n.r*e}}getHexLine(t,n){const e=this.roundAxial(this.pixelToAxial(t.x,t.y)),i=this.roundAxial(this.pixelToAxial(n.x,n.y)),s=this.hexDistance(e,i),o=[];for(let r=0;r<=s;r++){const m=s===0?0:r/s,h=this.roundAxial(this.lerpAxial(e,i,m));o.push(this.axialToPixel(h))}return o}}function Ut(S,t,n=.1){if(t<1)throw new Error("Resolution must be at least 1");if(S.length<2)return S;const e=S[0],i=S[S.length-1],s={x:e.x-(S[1].x-e.x)*2,y:e.y-(S[1].y-e.y)*2},o={x:i.x+(i.x-S[S.length-2].x)*2,y:i.y+(i.y-S[S.length-2].y)*2},r=[s,...S,o],m=[];for(let h=0;h<r.length-3;h++){const c=r[h],l=r[h+1],g=r[h+2],f=r[h+3];if(h>0)for(let v=0;v<t;v++){const p=v/t,d=p*p,b=d*p,C=.5*(2*l.x+(-c.x+g.x)*n*p+(2*c.x-5*l.x+4*g.x-f.x)*n*d+(-c.x+3*l.x-3*g.x+f.x)*n*b),T=.5*(2*l.y+(-c.y+g.y)*n*p+(2*c.y-5*l.y+4*g.y-f.y)*n*d+(-c.y+3*l.y-3*g.y+f.y)*n*b);m.push({x:C,y:T})}}return m.push(S[S.length-1]),m}var Pt=(S=>(S.DRAG="DRAG",S.NONE="NONE",S.PATH="PATH",S.RIVER="RIVER",S.REMOVE="REMOVE",S))(Pt||{});class Ht{constructor(){D(this,"selectedTool","DRAG");D(this,"container");D(this,"currentPath",[]);D(this,"paths",[]);D(this,"isDrawing",!1);D(this,"onToolChange",null);D(this,"pathSize",5);D(this,"previewSize",96);D(this,"pathButton",null);D(this,"riverButton",null);this.container=document.createElement("div"),this.container.className="drawing-toolbar",this.initializeUI()}setToolChangeCallback(t){this.onToolChange=t}deselectAll(){this.selectedTool="NONE",this.updateUI()}selectDragTool(){this.selectedTool="DRAG",this.updateUI(),this.onToolChange&&this.onToolChange()}createPreviewCanvas(){const t=document.createElement("canvas");return t.width=this.previewSize,t.height=this.previewSize,t}drawRoutePreview(t,n){const e=t.getContext("2d");if(!e)return;e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";const i=this.previewSize,s=i*.45,o={x:i/2,y:i/2},r=[];for(let c=0;c<6;c++){const l=Math.PI/3*c;r.push({x:o.x+s*Math.cos(l),y:o.y+s*Math.sin(l)})}e.clearRect(0,0,i,i),e.beginPath(),e.moveTo(r[0].x,r[0].y);for(let c=1;c<r.length;c++)e.lineTo(r[c].x,r[c].y);e.closePath(),e.strokeStyle="#404040",e.lineWidth=1.5,e.stroke(),e.beginPath();const m=o.y-s*.6,h=o.y+s*.6;e.moveTo(o.x,m),e.lineTo(o.x,h),n?(e.strokeStyle="#4B9CD3",e.lineWidth=this.pathSize*1.5,e.lineCap="round",e.stroke(),e.beginPath(),e.moveTo(o.x,m),e.lineTo(o.x,h),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=this.pathSize*.8,e.stroke()):(e.strokeStyle="#8B4513",e.lineWidth=this.pathSize*1.5,e.lineCap="round",e.stroke(),e.beginPath(),e.moveTo(o.x,m),e.lineTo(o.x,h),e.strokeStyle="rgba(139, 69, 19, 0.3)",e.lineWidth=this.pathSize*.8,e.stroke())}updatePreviews(){if(this.pathButton){const t=this.createPreviewCanvas();for(this.drawRoutePreview(t,!1);this.pathButton.firstChild;)this.pathButton.removeChild(this.pathButton.firstChild);this.pathButton.appendChild(t)}if(this.riverButton){const t=this.createPreviewCanvas();for(this.drawRoutePreview(t,!0);this.riverButton.firstChild;)this.riverButton.removeChild(this.riverButton.firstChild);this.riverButton.appendChild(t)}}initializeUI(){const t=document.createElement("div");t.className="toolbar-section";const n=document.createElement("h2");n.textContent="Routes",t.appendChild(n);const e=document.createElement("div");e.className="size-control";const i=document.createElement("label");i.textContent="Size:",e.appendChild(i);const s=document.createElement("span");s.textContent=this.pathSize.toString(),s.className="size-value";const o=document.createElement("input");o.type="range",o.min="1",o.max="10",o.value=this.pathSize.toString(),o.className="size-slider",o.addEventListener("input",f=>{const v=parseInt(f.target.value);this.pathSize=v,s.textContent=v.toString(),this.updatePreviews()}),e.appendChild(o),e.appendChild(s),t.appendChild(e);const r=document.createElement("div");r.className="terrain-button-container";const m=document.createElement("button");m.className="terrain-button",m.title="Remove Route";const h=this.createPreviewCanvas(),c=new Image;c.onload=()=>{const f=h.getContext("2d");if(f){this.drawHexagonBackground(h);const v=this.previewSize,p=v*.45,d={x:v/2,y:v/2},b=[];for(let M=0;M<6;M++){const $=Math.PI/3*M;b.push({x:d.x+p*Math.cos($),y:d.y+p*Math.sin($)})}const C=Math.min(...b.map(M=>M.x)),T=Math.min(...b.map(M=>M.y)),K=Math.max(...b.map(M=>M.x)),U=Math.max(...b.map(M=>M.y)),B=K-C,V=U-T,y=Math.min(B/c.width,V/c.height),q=c.width*y,H=c.height*y;f.drawImage(c,d.x-q/2,d.y-H/2,q,H)}},c.onerror=()=>{c.src.startsWith("/src/")&&(c.src="./src/assets/noroute.png")},c.src="/src/assets/noroute.png",m.appendChild(h),m.addEventListener("click",()=>this.selectTool("REMOVE")),r.appendChild(m),this.pathButton=document.createElement("button"),this.pathButton.className="terrain-button",this.pathButton.title="Path";const l=this.createPreviewCanvas();this.drawRoutePreview(l,!1),this.pathButton.appendChild(l),this.pathButton.addEventListener("click",()=>this.selectTool("PATH")),r.appendChild(this.pathButton),this.riverButton=document.createElement("button"),this.riverButton.className="terrain-button",this.riverButton.title="River";const g=this.createPreviewCanvas();this.drawRoutePreview(g,!0),this.riverButton.appendChild(g),this.riverButton.addEventListener("click",()=>this.selectTool("RIVER")),r.appendChild(this.riverButton),t.appendChild(r),this.container.appendChild(t)}drawHexagonBackground(t){const n=t.getContext("2d");if(!n)return;const e=this.previewSize,i=e*.45,s={x:e/2,y:e/2},o=[];for(let r=0;r<6;r++){const m=Math.PI/3*r;o.push({x:s.x+i*Math.cos(m),y:s.y+i*Math.sin(m)})}n.clearRect(0,0,e,e),n.beginPath(),n.moveTo(o[0].x,o[0].y);for(let r=1;r<o.length;r++)n.lineTo(o[r].x,o[r].y);n.closePath(),n.strokeStyle="#404040",n.lineWidth=1.5,n.stroke()}selectTool(t){t!==this.selectedTool&&(this.selectedTool=t,this.updateUI(),this.onToolChange&&this.onToolChange())}updateUI(){this.container.querySelectorAll(".terrain-button").forEach(n=>{const e=n;e.classList.remove("selected"),(e.title==="Path"&&this.selectedTool==="PATH"||e.title==="River"&&this.selectedTool==="RIVER"||e.title==="Remove Route"&&this.selectedTool==="REMOVE")&&e.classList.add("selected")})}startPath(t){this.selectedTool!=="NONE"&&(this.isDrawing=!0,this.currentPath=[t])}updatePath(t){if(!this.isDrawing)return;const n=this.currentPath[this.currentPath.length-1];(!n||Math.hypot(n.x-t.x,n.y-t.y)>1)&&this.currentPath.push(t)}endPath(){if(!this.isDrawing||this.currentPath.length<2)return;const t=this.selectedTool==="RIVER",n={points:[...this.currentPath],type:this.selectedTool==="RIVER"?"RIVER":"PATH",width:this.pathSize,strokeStyle:t?"#4B9CD3":"#8B4513"};if(this.currentPath.length>=3){const e=Ut(this.currentPath,20,1);e[0]=this.currentPath[0],n.smoothPoints=e}this.paths.push(n),this.isDrawing=!1,this.currentPath=[]}getPaths(){return this.paths}getCurrentPath(){return this.currentPath}getCurrentTool(){return this.selectedTool}isDrawingMode(){return this.selectedTool==="PATH"||this.selectedTool==="RIVER"}isDragMode(){return this.selectedTool==="DRAG"}getPathSize(){return this.pathSize}getElement(){return this.container}setPaths(t){this.paths=t}}class Gt{constructor(t,n){D(this,"canvas");D(this,"ctx");D(this,"tiles",[]);D(this,"paths",[]);D(this,"currentPath",[]);D(this,"hoveredTile",null);D(this,"zoom",1);D(this,"minZoom",.5);D(this,"maxZoom",3);D(this,"panX",0);D(this,"panY",0);D(this,"drawingTools");D(this,"terrainTextures",new Map);D(this,"treeOverlayTextures",new Map);D(this,"onTextureLoadCallbacks",[]);D(this,"customTerrainImages",new Map);D(this,"showGridNumbers",!0);this.canvas=t,this.drawingTools=n;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D rendering context");this.ctx=e,this.centerMap(),this.loadTerrainTextures()}centerMap(){this.panX=this.canvas.width/2,this.panY=this.canvas.height/2,this.zoom=1}updateZoom(t,n,e){const i=this.zoom,s=t>0?1.1:1/1.1,o=Math.min(Math.max(i*s,this.minZoom),this.maxZoom);if(o!==i){const r=(n-this.panX)/i,m=(e-this.panY)/i;this.zoom=o,this.panX=n-r*o,this.panY=e-m*o,this.render()}}applyTransform(){this.ctx.save(),this.ctx.translate(this.panX,this.panY),this.ctx.scale(this.zoom,this.zoom)}setTiles(t){this.tiles=t,this.render()}addTextureLoadCallback(t){this.onTextureLoadCallbacks.push(t)}loadTerrainTextures(){const t={[a.GRASS]:"grass.png",[a.WATER]:"water.png",[a.FOREST]:"forest.png",[a.HILLS]:"hills.png",[a.MOUNTAIN]:"mountain.png",[a.IMPASSABLE]:"impassable.png",[a.CLOUD]:"cloud.png",[a.BOG]:"bog.png",[a.TOWN1]:"town1.png",[a.TOWN2]:"town2.png",[a.TOWN3]:"town3.png",[a.HARBOR]:"harbor.png",[a.SHIPS]:"ships.png",[a.LIGHTTOWER]:"lighttower.png",[a.TREE]:"tree.png",[a.MINE]:"mine.png"},n={forest:"foresttrees.png",bog:"bogtrees.png"},e=Object.keys(t).length+Object.keys(n).length;let i=0;const s=h=>window.location.hostname.includes("github.io")?`/${window.location.pathname.split("/")[1]}/src/assets/${h}`:`/src/assets/${h}`,o=()=>{i++,i===e&&(this.onTextureLoadCallbacks.forEach(h=>h()),this.render())},r=()=>{const h=Object.entries(n).map(([c,l])=>new Promise(g=>{const f=new Image;f.onload=()=>{this.treeOverlayTextures.set(c,f),o(),g()},f.onerror=()=>{console.error(`Failed to load tree overlay: ${l}`),o(),g()},f.src=s(l)}));return Promise.all(h)},m=()=>{Object.entries(t).forEach(([h,c])=>{const l=new Image;l.onload=()=>{this.terrainTextures.set(h,l),o()},l.onerror=()=>{console.error(`Failed to load texture: ${c}`),o()},l.src=s(c)})};r().then(()=>{m()})}getTerrainColor(t){switch(t){case a.WATER:return"#4B9CD3";case a.GRASS:return"#90EE90";case a.FOREST:return"#228B22";case a.BOG:return"#006400";case a.HILLS:return"#D2B48C";case a.MOUNTAIN:return"#808080";case a.IMPASSABLE:return"#4A4A4A";case a.CLOUD:return"rgba(200, 200, 200, 0.5)";case a.TOWN1:return"#DEB887";case a.TOWN2:return"#8B4513";case a.TOWN3:return"#A0522D";case a.HARBOR:return"#5DADE2";case a.SHIPS:return"#4682B4";case a.LIGHTTOWER:return"#F5DEB3";case a.TREE:return"#2E8B57";case a.MINE:return"#696969";case a.CUSTOM:return"#FFFFFF";default:return"#FFFFFF"}}renderPaths(t=!1){if(this.paths.forEach(n=>{if(n.points.length<2)return;const e=n.type==="RIVER",i=t?n.width:n.width/this.zoom;if(this.ctx.save(),e){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(41, 98, 155, 0.3)",this.ctx.lineWidth=i*1.8,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#3178b9",this.ctx.lineWidth=i*1.4,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#4B9CD3",this.ctx.lineWidth=i,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.2)",this.ctx.lineWidth=i*.6;const s=n.points.map((o,r)=>({x:o.x+Math.sin(r*.3)*(i*.1),y:o.y+Math.cos(r*.3)*(i*.1)}));this.drawPathWithPoints(s),this.ctx.stroke();for(let o=0;o<3;o++){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=i*.1;const r=n.points.map((m,h)=>({x:m.x+Math.sin((h+o)*.5)*(i*.3),y:m.y+Math.cos((h+o)*.5)*(i*.3)}));this.drawPathWithPoints(r),this.ctx.stroke()}}else{this.ctx.beginPath(),this.ctx.strokeStyle="rgba(84, 48, 18, 0.2)",this.ctx.lineWidth=i*1.6,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.6)",this.ctx.lineWidth=i*1.2,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=i*.9,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(159, 99, 43, 0.5)",this.ctx.lineWidth=i*.4,this.drawPathWithPoints(n.points),this.ctx.stroke();const s=8;for(let o=0;o<s;o++){const r=o/s;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.2)",this.ctx.lineWidth=i*.1;const m=n.points.map((h,c)=>({x:h.x+Math.sin((c+r)*2)*(i*.2),y:h.y+Math.cos((c+r)*2)*(i*.2)}));this.drawPathWithPoints(m),this.ctx.stroke()}}this.ctx.restore()}),!t&&this.currentPath.length>=2){const n=this.drawingTools.getCurrentTool()===Pt.RIVER,e=this.drawingTools.getPathSize()/this.zoom;if(this.ctx.save(),n){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(41, 98, 155, 0.3)",this.ctx.lineWidth=e*1.8,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#3178b9",this.ctx.lineWidth=e*1.4,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#4B9CD3",this.ctx.lineWidth=e,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.2)",this.ctx.lineWidth=e*.6;const i=this.currentPath.map((s,o)=>({x:s.x+Math.sin(o*.3)*(e*.1),y:s.y+Math.cos(o*.3)*(e*.1)}));this.drawPathWithPoints(i),this.ctx.stroke();for(let s=0;s<3;s++){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=e*.1;const o=this.currentPath.map((r,m)=>({x:r.x+Math.sin((m+s)*.5)*(e*.3),y:r.y+Math.cos((m+s)*.5)*(e*.3)}));this.drawPathWithPoints(o),this.ctx.stroke()}}else{this.ctx.beginPath(),this.ctx.strokeStyle="rgba(84, 48, 18, 0.2)",this.ctx.lineWidth=e*1.6,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.6)",this.ctx.lineWidth=e*1.2,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=e*.9,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(159, 99, 43, 0.5)",this.ctx.lineWidth=e*.4,this.drawPathWithPoints(this.currentPath),this.ctx.stroke();const i=8;for(let s=0;s<i;s++){const o=s/i;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.2)",this.ctx.lineWidth=e*.1;const r=this.currentPath.map((m,h)=>({x:m.x+Math.sin((h+o)*2)*(e*.2),y:m.y+Math.cos((h+o)*2)*(e*.2)}));this.drawPathWithPoints(r),this.ctx.stroke()}}this.ctx.restore()}}drawPathWithPoints(t){if(this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y),t.length>=3){const n=Ut(t,20,1);for(let e=1;e<n.length;e++)this.ctx.lineTo(n[e].x,n[e].y)}else this.ctx.lineTo(t[1].x,t[1].y)}setPaths(t){this.paths=t,this.render()}setCurrentPath(t){this.currentPath=t,t.length>0&&this.render()}render(){this.ctx.fillStyle="#1e1e1e",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.applyTransform();for(const t of this.tiles)t.terrain!==a.CUSTOM&&t.terrain!==a.WATER&&t.terrain!==a.CLOUD&&this.renderTileBase(t);this.renderPaths();for(const t of this.tiles)(t.terrain===a.WATER||t.terrain===a.CLOUD)&&this.renderTileBase(t);for(const t of this.tiles)t.specialTerrain&&!t.abovePaths&&!Nt.has(t.specialTerrain)&&this.renderSpecialTerrain(t);for(const t of this.tiles)t.treeOverlay&&!t.treeOverlay.abovePaths&&this.renderTreeOverlay(t);for(const t of this.tiles)t.specialTerrain&&t.abovePaths&&!Nt.has(t.specialTerrain)&&this.renderSpecialTerrain(t);for(const t of this.tiles)t.treeOverlay&&t.treeOverlay.abovePaths&&this.renderTreeOverlay(t);for(const t of this.tiles)t.specialTerrain&&Nt.has(t.specialTerrain)&&this.renderSpecialTerrain(t,!0),t.terrain===a.CUSTOM&&t.customTerrain&&this.renderCustomTerrain(t);this.renderGridNumbers(),this.ctx.restore()}renderCustomTerrain(t){if(!t.customTerrain)return;const{vertices:n}=t;this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++)this.ctx.lineTo(n[e].x,n[e].y);if(this.ctx.closePath(),t.customTerrain.type==="color")this.ctx.fillStyle=t.customTerrain.value,this.ctx.fill();else if(t.customTerrain.type==="image"){let e=this.customTerrainImages.get(t.customTerrain.value);if(!e){e=new Image,e.src=t.customTerrain.value,this.customTerrainImages.set(t.customTerrain.value,e),e.onload=()=>{this.render()},this.ctx.restore();return}if(e.complete){const i=Math.min(...n.map(f=>f.x)),s=Math.min(...n.map(f=>f.y)),o=Math.max(...n.map(f=>f.x)),r=Math.max(...n.map(f=>f.y)),m=o-i,h=r-s,c=i+m/2,l=s+h/2,g=Math.min(m,h)/2*1.9;this.ctx.clip();try{const f=e.width/e.height;let v,p;f>1?(v=g*2,p=v/f):(p=g*2,v=p*f),this.ctx.drawImage(e,c-v/2,l-p/2,v,p)}catch(f){console.error("Error drawing custom image terrain:",f)}}}t===this.hoveredTile&&(this.ctx.fillStyle="rgba(100, 149, 237, 0.3)",this.ctx.fill()),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1/this.zoom,this.ctx.stroke(),this.ctx.restore()}renderTileBase(t){if(t.terrain===a.CUSTOM)return;const{vertices:n}=t;this.ctx.beginPath(),this.ctx.moveTo(n[0].x,n[0].y);for(let i=1;i<n.length;i++)this.ctx.lineTo(n[i].x,n[i].y);this.ctx.closePath();const e=this.terrainTextures.get(t.terrain);if(e&&e.complete){this.ctx.save(),this.ctx.clip();const i=Math.min(...n.map(g=>g.x)),s=Math.min(...n.map(g=>g.y)),o=Math.max(...n.map(g=>g.x)),r=Math.max(...n.map(g=>g.y)),m=o-i,h=r-s,c=m/e.width,l=h/e.height;this.ctx.translate(i,s),this.ctx.scale(c,l),this.ctx.drawImage(e,0,0),this.ctx.restore()}else this.ctx.fillStyle=this.getTerrainColor(t.terrain),this.ctx.fill();t===this.hoveredTile&&(this.ctx.fillStyle="rgba(100, 149, 237, 0.3)",this.ctx.fill()),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1/this.zoom,this.ctx.stroke()}renderTreeOverlay(t){const{vertices:n}=t;if(!t.treeOverlay)return;const e=this.treeOverlayTextures.get(t.treeOverlay.type);if(e&&e.complete){this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(n[0].x,n[0].y);for(let g=1;g<n.length;g++)this.ctx.lineTo(n[g].x,n[g].y);this.ctx.closePath(),this.ctx.clip();const i=Math.min(...n.map(g=>g.x)),s=Math.min(...n.map(g=>g.y)),o=Math.max(...n.map(g=>g.x)),r=Math.max(...n.map(g=>g.y)),m=o-i,h=r-s,c=m/e.width,l=h/e.height;this.ctx.translate(i,s),this.ctx.scale(c,l),this.ctx.drawImage(e,0,0),this.ctx.restore()}}renderSpecialTerrain(t,n=!1){if(!t.specialTerrain)return;const e=this.terrainTextures.get(t.specialTerrain);if(!e||!e.complete)return;this.ctx.save();const{vertices:i}=t;if(!n){this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let f=1;f<i.length;f++)this.ctx.lineTo(i[f].x,i[f].y);this.ctx.closePath(),this.ctx.clip()}const s=Math.min(...i.map(f=>f.x)),o=Math.min(...i.map(f=>f.y)),r=Math.max(...i.map(f=>f.x)),m=Math.max(...i.map(f=>f.y)),h=r-s,c=m-o,l=h/e.width,g=c/e.height;this.ctx.translate(s,o),this.ctx.scale(l,g),this.ctx.drawImage(e,0,0),this.ctx.restore()}screenToMapCoordinates(t,n){return{x:(t-this.panX)/this.zoom,y:(n-this.panY)/this.zoom}}getZoom(){return this.zoom}getPanX(){return this.panX}getPanY(){return this.panY}getTiles(){return this.tiles}setZoom(t){this.zoom=t}setPanPosition(t,n){this.panX=t,this.panY=n}pan(t,n){this.panX+=t,this.panY+=n,this.render()}setHoveredTile(t){this.hoveredTile!==t&&(this.hoveredTile=t,this.render())}getPaths(){return this.paths}getTerrainTexture(t){return this.terrainTextures.get(t)}setTileTerrain(t,n,e){if(n===a.NONE){t.terrain=a.NONE,t.specialTerrain=void 0,t.customTerrain=void 0,delete t.treeOverlay,this.render();return}if(n===a.CUSTOM){t.terrain=n,t.customTerrain=e||{type:"color",value:"#FFFFFF"},t.specialTerrain=void 0,delete t.treeOverlay,this.render();return}if(Wt.has(n)){t.specialTerrain=n,delete t.treeOverlay,this.render();return}t.terrain=n,t.customTerrain=void 0,t.specialTerrain?delete t.treeOverlay:n===a.FOREST?t.treeOverlay={type:"forest",abovePaths:t.abovePaths??!1}:n===a.BOG?t.treeOverlay={type:"bog",abovePaths:t.abovePaths??!1}:delete t.treeOverlay,this.render()}getTreeOverlayTexture(t){return this.treeOverlayTextures.get(t)}preloadCustomTerrainImage(t){return new Promise((n,e)=>{if(this.customTerrainImages.has(t)){n();return}const i=new Image;i.onload=()=>{this.customTerrainImages.set(t,i),n()},i.onerror=s=>{console.error("Failed to load custom terrain image:",s),e(new Error("Failed to load custom terrain image"))},i.src=t})}setShowGridNumbers(t){this.showGridNumbers=t}renderGridNumbers(){if(!this.showGridNumbers)return;this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.font="14px Arial",this.ctx.fillStyle="#808080",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=this.tiles.map(r=>r.coord),n=Math.min(...t.map(r=>r.q)),e=Math.max(...t.map(r=>r.q)),i=Math.min(...t.map(r=>r.r)),s=Math.max(...t.map(r=>r.r)),o=this.tiles.filter(r=>r.coord.r===s);if(o.length>0){const m=(Math.max(...o.map(h=>h.center.y))+50)*this.zoom+this.panY;for(let h=n;h<=e;h++){const c=o.find(l=>l.coord.q===h);if(c){this.hoveredTile&&this.hoveredTile.coord.q===h?this.ctx.fillStyle="#ffffff":this.ctx.fillStyle="#808080";const l=c.center.x*this.zoom+this.panX;this.ctx.fillText(String(h+1),l,m)}}}for(let r=i;r<=s;r++){const m=this.tiles.find(h=>h.coord.r===r&&h.coord.q===n);if(m){this.hoveredTile&&this.hoveredTile.coord.r===r?this.ctx.fillStyle="#ffffff":this.ctx.fillStyle="#808080";const h=(m.center.x-60)*this.zoom+this.panX,c=m.center.y*this.zoom+this.panY;this.ctx.fillText(String(r+1),h,c)}}this.ctx.restore()}renderToContext(t,n=!1,e){const i=this.ctx;try{this.ctx=t,n||(this.ctx.fillStyle="#1e1e1e",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)),n||this.applyTransform();for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.terrain!==a.CUSTOM&&s.terrain!==a.WATER&&s.terrain!==a.CLOUD&&this.renderTileBase(s);this.renderPaths(n);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&(s.terrain===a.WATER||s.terrain===a.CLOUD)&&this.renderTileBase(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.specialTerrain&&!s.abovePaths&&!Nt.has(s.specialTerrain)&&this.renderSpecialTerrain(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.treeOverlay&&!s.treeOverlay.abovePaths&&this.renderTreeOverlay(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.specialTerrain&&s.abovePaths&&!Nt.has(s.specialTerrain)&&this.renderSpecialTerrain(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.treeOverlay&&s.treeOverlay.abovePaths&&this.renderTreeOverlay(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&(s.specialTerrain&&Nt.has(s.specialTerrain)&&this.renderSpecialTerrain(s,!0),s.terrain===a.CUSTOM&&s.customTerrain&&this.renderCustomTerrain(s));n||this.renderGridNumbers(),n||this.ctx.restore()}finally{this.ctx=i}}}class $t{constructor(t){D(this,"selectedTerrain",a.NONE);D(this,"container");D(this,"onTerrainSelect",null);D(this,"drawMode","DRAW");D(this,"hasActiveSelection",!1);D(this,"drawAbovePaths",!1);D(this,"terrainPreviews",new Map);D(this,"previewSize",96);D(this,"mapRenderer");D(this,"customTerrainData",null);D(this,"customTerrainModal",null);D(this,"customPreviewCanvas");D(this,"onGridSizeChange",null);this.mapRenderer=t,this.container=document.createElement("div"),this.container.className="toolbar-section",this.customPreviewCanvas=this.createPreviewCanvas(),this.drawHexagonPreview(this.customPreviewCanvas,"#ffffff"),this.loadTerrainTextures(),this.initializeUI(),this.mapRenderer.addTextureLoadCallback(()=>{this.updatePreviews()})}loadTerrainTextures(){const t=new Image;t.onload=()=>{const e=this.createPreviewCanvas();this.drawHexagonPreview(e,void 0,t),this.terrainPreviews.set(a.NONE,e);const i=this.findButtonForTerrain(a.NONE);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}},t.onerror=()=>{const e=this.createPreviewCanvas();this.drawHexagonPreview(e,"#FFFFFF"),this.terrainPreviews.set(a.NONE,e);const i=this.findButtonForTerrain(a.NONE);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}t.src.startsWith("/src/")&&(t.src="./src/assets/noterrain.png")},t.src="/src/assets/noterrain.png";const n={[a.GRASS]:"grass.png",[a.WATER]:"water.png",[a.FOREST]:"forest.png",[a.HILLS]:"hills.png",[a.MOUNTAIN]:"mountain.png",[a.IMPASSABLE]:"impassable.png",[a.CLOUD]:"cloud.png",[a.BOG]:"bog.png",[a.TOWN1]:"town1.png",[a.TOWN2]:"town2.png",[a.TOWN3]:"town3.png",[a.HARBOR]:"harbor.png",[a.SHIPS]:"ships.png",[a.LIGHTTOWER]:"lighttower.png",[a.TREE]:"tree.png",[a.MINE]:"mine.png"};Object.entries(n).forEach(([e,i])=>{const s=new Image;s.onload=()=>{const o=this.createPreviewCanvas();this.drawHexagonPreview(o,void 0,s),this.terrainPreviews.set(e,o);const r=this.findButtonForTerrain(e);if(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(o)}},s.onerror=()=>{const o=this.createPreviewCanvas();this.drawHexagonPreview(o,this.getTerrainColor(e)),this.terrainPreviews.set(e,o);const r=this.findButtonForTerrain(e);if(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(o)}s.src.startsWith("/src/")&&(s.src=`./src/assets/${i}`)},s.src=`/src/assets/${i}`})}updatePreviews(){[a.GRASS,a.WATER,a.HILLS,a.MOUNTAIN,a.IMPASSABLE,a.CLOUD].forEach(s=>{const o=this.mapRenderer.getTerrainTexture(s);if(o){const r=this.createPreviewCanvas();this.drawHexagonPreview(r,void 0,o);const m=this.findButtonForTerrain(s);if(m){for(;m.firstChild;)m.removeChild(m.firstChild);m.appendChild(r)}this.terrainPreviews.set(s,r)}});const t=this.mapRenderer.getTerrainTexture(a.FOREST),n=this.mapRenderer.getTreeOverlayTexture("forest");if(t){const s=this.createPreviewCanvas();this.drawHexagonPreview(s,void 0,t,n);const o=this.findButtonForTerrain(a.FOREST);if(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(s)}this.terrainPreviews.set(a.FOREST,s)}const e=this.mapRenderer.getTerrainTexture(a.BOG),i=this.mapRenderer.getTreeOverlayTexture("bog");if(e){const s=this.createPreviewCanvas();this.drawHexagonPreview(s,void 0,e,i);const o=this.findButtonForTerrain(a.BOG);if(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(s)}this.terrainPreviews.set(a.BOG,s)}}findButtonForTerrain(t){const n=this.container.querySelectorAll(".terrain-button");for(const e of n){const i=e;if(i.title===this.getTerrainLabel(t))return i}return null}createPreviewCanvas(){const t=document.createElement("canvas");return t.width=this.previewSize,t.height=this.previewSize,t}drawHexagonPreview(t,n,e,i){const s=t.getContext("2d");if(!s)return;s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";const o=this.previewSize,r=o*.45,m={x:o/2,y:o/2},h=[];for(let c=0;c<6;c++){const l=Math.PI/3*c;h.push({x:m.x+r*Math.cos(l),y:m.y+r*Math.sin(l)})}s.beginPath(),s.moveTo(h[0].x,h[0].y);for(let c=1;c<h.length;c++)s.lineTo(h[c].x,h[c].y);if(s.closePath(),e){s.save(),s.clip();const c=Math.min(...h.map(T=>T.x)),l=Math.min(...h.map(T=>T.y)),g=Math.max(...h.map(T=>T.x)),f=Math.max(...h.map(T=>T.y)),v=g-c,p=f-l,d=Math.min(v/e.width,p/e.height),b=e.width*d,C=e.height*d;if(s.drawImage(e,m.x-b/2,m.y-C/2,b,C),i){const T=Math.min(v/i.width,p/i.height),K=i.width*T,U=i.height*T;s.drawImage(i,m.x-K/2,m.y-U/2,K,U)}s.restore()}else n&&(s.fillStyle=n,s.fill());s.strokeStyle="#404040",s.lineWidth=1.5,s.stroke()}getElement(){return this.container}setTerrainSelectCallback(t){this.onTerrainSelect=t}deselectAll(){this.hasActiveSelection=!1,this.container.querySelectorAll(".terrain-button").forEach(n=>{n.classList.remove("selected")})}setGridSizeChangeCallback(t){this.onGridSizeChange=t}initializeUI(){const t=document.createElement("h2");t.textContent="Grid Size",this.container.appendChild(t);const n=document.createElement("div");n.className="toolbar-section";const e=document.createElement("div");e.style.display="grid",e.style.gridTemplateRows="auto auto auto",e.style.gap="4px",e.style.justifyContent="center";const i=$=>{const k=document.createElement("button");return k.style.width="24px",k.style.height="24px",k.style.padding="0",k.style.display="flex",k.style.alignItems="center",k.style.justifyContent="center",k.style.background="#2d2d2d",k.style.border="1px solid #404040",k.style.color=$.includes("+")?"#4CAF50":"#f44336",k.style.cursor="pointer",k.style.borderRadius="4px",k.style.fontSize="16px",k.style.lineHeight="1",k.style.transition="background-color 0.2s ease",k.addEventListener("mouseover",()=>{k.style.background="#3d3d3d"}),k.addEventListener("mouseout",()=>{k.style.background="#2d2d2d"}),k.innerHTML=$.includes("+")?"+":"-",k.addEventListener("click",()=>{this.onGridSizeChange&&this.onGridSizeChange($)}),k},s=document.createElement("div");s.className="grid-size-info",s.style.color="#e0e0e0",s.style.fontSize="14px",s.style.margin="0 4px",s.style.textAlign="center",s.textContent="35x20";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="center",o.style.gap="4px";const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="4px";const m=document.createElement("div");m.style.display="flex",m.style.justifyContent="center",m.style.gap="4px",o.appendChild(i("row-top")),o.appendChild(i("row+top")),r.appendChild(i("col-left")),r.appendChild(i("col+left")),r.appendChild(s),r.appendChild(i("col-right")),r.appendChild(i("col+right")),m.appendChild(i("row-bottom")),m.appendChild(i("row+bottom")),e.appendChild(o),e.appendChild(r),e.appendChild(m),n.appendChild(e),this.container.appendChild(n);const h=document.createElement("h2");h.textContent="Terrain",this.container.appendChild(h);const c=document.createElement("div");c.className="mode-selector";const l=document.createElement("button");l.textContent="Draw",l.className="mode-button selected",l.addEventListener("click",()=>this.setDrawMode("DRAW",l,g));const g=document.createElement("button");g.textContent="Fill",g.className="mode-button",g.addEventListener("click",()=>this.setDrawMode("FILL",l,g)),c.appendChild(l),c.appendChild(g),this.container.appendChild(c);const f=document.createElement("div");f.className="layer-control";const v=document.createElement("label");v.textContent="Above Routes",v.htmlFor="layer-toggle";const p=document.createElement("div");p.className="toggle-switch";const d=document.createElement("input");d.type="checkbox",d.id="layer-toggle",d.checked=this.drawAbovePaths;const b=document.createElement("span");b.className="toggle-slider";const C=()=>{this.drawAbovePaths=d.checked};d.addEventListener("change",C),p.addEventListener("click",$=>{$.preventDefault(),d.checked=!d.checked,C()}),v.addEventListener("click",$=>{$.preventDefault(),d.checked=!d.checked,C()}),p.appendChild(d),p.appendChild(b),f.appendChild(v),f.appendChild(p),this.container.appendChild(f);const T=[{type:a.NONE,tooltip:"Remove Terrain"},{type:a.WATER,tooltip:"Water"},{type:a.GRASS,tooltip:"Grass"},{type:a.FOREST,tooltip:"Forest"},{type:a.BOG,tooltip:"Bog"},{type:a.HILLS,tooltip:"Hills"},{type:a.MOUNTAIN,tooltip:"Mountain"},{type:a.IMPASSABLE,tooltip:"Impassable"},{type:a.CLOUD,tooltip:"Cloud"}],K=[{type:a.TOWN1,tooltip:"Town 1"},{type:a.TOWN2,tooltip:"Town 2"},{type:a.TOWN3,tooltip:"Town 3"},{type:a.HARBOR,tooltip:"Harbor"},{type:a.SHIPS,tooltip:"Ships"},{type:a.LIGHTTOWER,tooltip:"Lighttower"},{type:a.TREE,tooltip:"Tree"},{type:a.MINE,tooltip:"Cave / Mine"}],U=document.createElement("div");U.className="terrain-button-container",this.container.appendChild(U);const B=document.createElement("button");B.className="terrain-button",B.title="Remove Terrain";const V=this.terrainPreviews.get(a.NONE);V&&B.appendChild(V),B.addEventListener("click",()=>this.selectTerrain(a.NONE)),U.appendChild(B);const y=document.createElement("button");y.className="terrain-button custom-terrain",y.title="Custom Terrain",y.appendChild(this.customPreviewCanvas),y.addEventListener("click",()=>{this.selectTerrain(a.CUSTOM)}),U.appendChild(y);const q=document.createElement("button");q.className="custom-terrain-edit",q.textContent="Edit Custom",q.title="Edit Custom Terrain",q.addEventListener("click",$=>{$.stopPropagation(),this.showCustomTerrainModal()}),U.appendChild(q);const H=document.createElement("div");H.className="storage-divider",H.style.gridColumn="1 / -1",U.appendChild(H),T.slice(1).forEach($=>{const k=document.createElement("button");k.className="terrain-button",k.title=$.tooltip;const ut=this.terrainPreviews.get($.type);ut&&k.appendChild(ut),k.addEventListener("click",()=>this.selectTerrain($.type)),U.appendChild(k)});const M=document.createElement("div");M.className="storage-divider",M.style.gridColumn="1 / -1",U.appendChild(M),K.forEach($=>{const k=document.createElement("button");k.className="terrain-button",k.title=$.tooltip;const ut=this.terrainPreviews.get($.type);ut&&k.appendChild(ut),k.addEventListener("click",()=>this.selectTerrain($.type)),U.appendChild(k)})}selectTerrain(t){t===this.selectedTerrain&&this.hasActiveSelection?(this.selectedTerrain=a.NONE,this.hasActiveSelection=!1,this.onTerrainSelect&&this.onTerrainSelect()):(this.selectedTerrain=t,this.hasActiveSelection=!0,this.onTerrainSelect&&this.onTerrainSelect()),this.updateUI()}updateUI(){this.container.querySelectorAll(".terrain-button").forEach(n=>{const e=n;n.classList.toggle("selected",this.hasActiveSelection&&e.title===this.getTerrainLabel(this.selectedTerrain))})}getSelectedTerrain(){return this.selectedTerrain}getCustomTerrainData(){return this.selectedTerrain===a.CUSTOM?this.customTerrainData:null}isTerrainSelected(){return this.hasActiveSelection}getTerrainLabel(t){return{[a.NONE]:"Remove Terrain",[a.WATER]:"Water",[a.GRASS]:"Grass",[a.FOREST]:"Forest",[a.BOG]:"Bog",[a.HILLS]:"Hills",[a.MOUNTAIN]:"Mountain",[a.IMPASSABLE]:"Impassable",[a.CLOUD]:"Cloud",[a.TOWN1]:"Town 1",[a.TOWN2]:"Town 2",[a.TOWN3]:"Town 3",[a.HARBOR]:"Harbor",[a.SHIPS]:"Ships",[a.LIGHTTOWER]:"Lighttower",[a.TREE]:"Tree",[a.MINE]:"Cave / Mine",[a.CUSTOM]:"Custom Terrain"}[t]||t}setDrawMode(t,n,e){this.drawMode=t,n.classList.toggle("selected",t==="DRAW"),e.classList.toggle("selected",t==="FILL")}getDrawMode(){return this.drawMode}isDrawAbovePaths(){return this.drawAbovePaths}getTerrainColor(t){switch(t){case a.WATER:return"#4B9CD3";case a.GRASS:return"#90EE90";case a.FOREST:return"#228B22";case a.BOG:return"#006400";case a.HILLS:return"#D2B48C";case a.MOUNTAIN:return"#808080";case a.IMPASSABLE:return"#4A4A4A";case a.CLOUD:return"rgba(200, 200, 200, 0.5)";case a.TOWN1:return"#DEB887";case a.TOWN2:return"#8B4513";case a.TOWN3:return"#A0522D";case a.HARBOR:return"#5DADE2";case a.SHIPS:return"#4682B4";case a.LIGHTTOWER:return"#F5DEB3";case a.TREE:return"#2E8B57";case a.MINE:return"#696969";default:return"#FFFFFF"}}showCustomTerrainModal(){var dt;this.customTerrainModal&&(document.body.removeChild(this.customTerrainModal),this.customTerrainModal=null);const t=document.createElement("div");t.className="modal-backdrop",document.body.appendChild(t);const n=document.createElement("div");n.className="custom-terrain-modal";const e=document.createElement("button");e.className="modal-close-button",e.innerHTML="×",n.appendChild(e);const i=document.createElement("h3");i.textContent="Custom Terrain",n.appendChild(i);const s=document.createElement("div");s.className="custom-terrain-tabs";const o=document.createElement("button");o.className="custom-terrain-tab active",o.textContent="Image";const r=document.createElement("button");r.className="custom-terrain-tab",r.textContent="Color",s.appendChild(o),s.appendChild(r),n.appendChild(s);const m=document.createElement("div");m.className="custom-terrain-content";const h=document.createElement("div");h.className="color-picker-section",h.style.display="none";const c=document.createElement("div");c.className="color-picker-container";const l=document.createElement("input");l.type="color",l.className="color-picker-input",l.value=((dt=this.customTerrainData)==null?void 0:dt.type)==="color"?this.customTerrainData.value:"#ffffff";const g=document.createElement("canvas");g.className="color-hex-preview",g.width=200,g.height=200;const f=()=>{const w=g.getContext("2d");if(!w)return;w.clearRect(0,0,g.width,g.height);const G=g.width/2,Y=g.height/2,rt=Math.min(g.width,g.height)*.45;w.beginPath();for(let nt=0;nt<6;nt++){const it=Math.PI/3*nt,Z=G+rt*Math.cos(it),j=Y+rt*Math.sin(it);nt===0?w.moveTo(Z,j):w.lineTo(Z,j)}w.closePath(),w.fillStyle=l.value,w.fill(),w.strokeStyle="#404040",w.lineWidth=2,w.stroke()};l.addEventListener("input",f),f();const v=document.createElement("div");v.className="color-picker-tooltip",v.textContent="Click on the hexagon to change color",c.appendChild(g),c.appendChild(v),c.appendChild(l),h.appendChild(c);const p=document.createElement("div");p.className="image-upload-section",p.style.display="flex";const d=document.createElement("div");d.className="image-upload-area",d.innerHTML=`
            <div class="upload-icon">📁</div>
            <div class="upload-text">Click or drag an image here</div>
            <input type="file" accept="image/*" style="display: none;">
        `;const b=document.createElement("div");b.className="image-preview-container",b.style.display="none";const C=document.createElement("img");C.className="preview-image";const T=document.createElement("canvas");T.className="preview-hexagon-overlay",T.width=b.clientWidth||400,T.height=b.clientHeight||240,b.appendChild(C),b.appendChild(T);const K=document.createElement("div");K.className="image-controls",K.style.display="none";const U=document.createElement("button");U.className="image-control-button",U.textContent="Zoom In";const B=document.createElement("button");B.className="image-control-button",B.textContent="Zoom Out";const V=document.createElement("button");V.className="image-control-button",V.textContent="Reset",K.appendChild(U),K.appendChild(B),K.appendChild(V);let y={x:0,y:0,scale:1};d.addEventListener("click",()=>{q==null||q.click()}),d.addEventListener("dragover",w=>{w.preventDefault(),w.stopPropagation(),d.classList.add("drag-over")}),d.addEventListener("dragleave",w=>{w.preventDefault(),w.stopPropagation(),d.classList.remove("drag-over")}),d.addEventListener("drop",w=>{var G;if(w.preventDefault(),w.stopPropagation(),d.classList.remove("drag-over"),(G=w.dataTransfer)!=null&&G.files&&w.dataTransfer.files.length>0){const Y=w.dataTransfer.files[0];if(Y.type.startsWith("image/")){const rt=new FileReader;rt.onload=nt=>{var it;(it=nt.target)!=null&&it.result&&(C.src=nt.target.result,C.onload=()=>{y={x:0,y:0,scale:1},mt()},b.style.display="block",K.style.display="flex")},rt.readAsDataURL(Y)}}});const q=d.querySelector("input");q&&q.addEventListener("change",w=>{const G=w.target;if(G.files&&G.files[0]){const Y=new FileReader;Y.onload=rt=>{var nt;(nt=rt.target)!=null&&nt.result&&(C.src=rt.target.result,C.onload=()=>{y={x:0,y:0,scale:1},mt()},b.style.display="block",K.style.display="flex")},Y.readAsDataURL(G.files[0])}}),p.appendChild(d),p.appendChild(b),p.appendChild(K),m.appendChild(h),m.appendChild(p),n.appendChild(m);const H=document.createElement("div");H.className="modal-buttons";const M=document.createElement("button");M.className="modal-button primary",M.textContent="Apply";const $=document.createElement("button");$.className="modal-button secondary",$.textContent="Cancel",H.appendChild(M),H.appendChild($),n.appendChild(H),o.addEventListener("click",()=>{o.classList.add("active"),r.classList.remove("active"),p.style.display="flex",h.style.display="none"}),r.addEventListener("click",()=>{r.classList.add("active"),o.classList.remove("active"),h.style.display="flex",p.style.display="none"});let k=!1,ut=0,yt=0;b.addEventListener("mousedown",w=>{k=!0,ut=w.clientX-y.x,yt=w.clientY-y.y,b.style.cursor="grabbing"}),document.addEventListener("mousemove",w=>{k&&(y.x=w.clientX-ut,y.y=w.clientY-yt,mt())}),document.addEventListener("mouseup",()=>{k=!1,b.style.cursor="grab"}),U.addEventListener("click",()=>{y.scale*=1.1,mt()}),B.addEventListener("click",()=>{y.scale*=.9,mt()}),V.addEventListener("click",()=>{y={x:0,y:0,scale:1},mt()});function mt(){const w=T.getContext("2d");if(!w)return;const G=b.getBoundingClientRect();(T.width!==G.width||T.height!==G.height)&&(T.width=G.width,T.height=G.height),w.clearRect(0,0,T.width,T.height);const Y=T.width/2,rt=T.height/2,nt=Math.min(T.width,T.height)*.45,it=document.createElement("canvas");it.width=T.width,it.height=T.height;const Z=it.getContext("2d");if(Z){Z.beginPath();for(let j=0;j<6;j++){const at=Math.PI/3*j,lt=Y+nt*Math.cos(at),tt=rt+nt*Math.sin(at);j===0?Z.moveTo(lt,tt):Z.lineTo(lt,tt)}if(Z.closePath(),Z.save(),Z.clip(),C.complete){const j=y.scale,at=y.x,lt=y.y,tt=C.naturalWidth/C.naturalHeight;let gt,z;const st=nt*1.6;tt>1?(gt=st*2,z=gt/tt):(z=st*2,gt=z*tt),Z.translate(Y,rt),Z.scale(j,j),Z.translate(at/j,lt/j),Z.drawImage(C,-gt/2,-z/2,gt,z),Z.restore()}w.drawImage(it,0,0),w.beginPath();for(let j=0;j<6;j++){const at=Math.PI/3*j,lt=Y+nt*Math.cos(at),tt=rt+nt*Math.sin(at);j===0?w.moveTo(lt,tt):w.lineTo(lt,tt)}w.closePath(),w.strokeStyle="rgba(255, 255, 255, 0.8)",w.lineWidth=2,w.stroke()}}const pt=()=>{document.body.removeChild(t),document.body.removeChild(n),this.customTerrainModal=null};$.addEventListener("click",pt),e.addEventListener("click",pt),t.addEventListener("click",w=>{w.target===t&&pt()}),b.addEventListener("wheel",w=>{w.preventDefault();const G=w.deltaY>0?.9:1.1;y.scale*=G,mt()}),M.addEventListener("click",()=>{if(r.classList.contains("active"))this.customTerrainData={type:"color",value:l.value};else if(C.src){const w=document.createElement("canvas"),G=b.getBoundingClientRect();w.width=G.width,w.height=G.height;const Y=w.getContext("2d");if(!Y)return;const rt=w.width/2,nt=w.height/2,it=Math.min(w.width,w.height)*.45;Y.beginPath();for(let tt=0;tt<6;tt++){const gt=Math.PI/3*tt,z=rt+it*Math.cos(gt),st=nt+it*Math.sin(gt);tt===0?Y.moveTo(z,st):Y.lineTo(z,st)}Y.closePath(),Y.clip();const Z=C.naturalWidth/C.naturalHeight;let j,at;const lt=it*1.6;Z>1?(j=lt*2,at=j/Z):(at=lt*2,j=at*Z),Y.translate(rt,nt),Y.scale(y.scale,y.scale),Y.translate(y.x/y.scale,y.y/y.scale),Y.drawImage(C,-j/2,-at/2,j,at),this.customTerrainData={type:"image",value:w.toDataURL(),imagePosition:{x:0,y:0,scale:1}}}this.updateCustomPreview(),pt(),this.selectedTerrain=a.CUSTOM,this.hasActiveSelection=!0,this.updateUI(),this.onTerrainSelect&&this.onTerrainSelect()}),document.body.appendChild(n),this.customTerrainModal=n}updateCustomPreview(){if(!this.customTerrainData)return;const t=this.createPreviewCanvas(),n=t.getContext("2d");if(!n)return;n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high";const e=t.width/2,i=t.height/2,s=t.width*.45;n.beginPath();for(let r=0;r<6;r++){const m=Math.PI/3*r,h=e+s*Math.cos(m),c=i+s*Math.sin(m);r===0?n.moveTo(h,c):n.lineTo(h,c)}if(n.closePath(),this.customTerrainData.type==="color")n.fillStyle=this.customTerrainData.value,n.fill();else if(this.customTerrainData.type==="image"){n.save(),n.clip();const r=new Image;r.onload=()=>{try{const m=r.width/r.height;let h,c;const l=s*1.6;m>1?(h=l*2,c=h/m):(c=l*2,h=c*m),n.drawImage(r,e-h/2,i-c/2,h,c),n.restore(),n.strokeStyle="#404040",n.lineWidth=1.5,n.stroke();const g=this.findButtonForTerrain(a.CUSTOM);if(g){for(;g.firstChild;)g.removeChild(g.firstChild);g.appendChild(t)}this.terrainPreviews.set(a.CUSTOM,t),this.customPreviewCanvas=t}catch(m){console.error("Error drawing custom image preview:",m),n.restore()}},r.src=this.customTerrainData.value;return}n.strokeStyle="#404040",n.lineWidth=1.5,n.stroke();const o=this.findButtonForTerrain(a.CUSTOM);if(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(t)}this.terrainPreviews.set(a.CUSTOM,t),this.customPreviewCanvas=t}updateGridDimensions(t,n){const e=this.container.querySelector(".grid-size-info");e&&(e.textContent=`${t}x${n}`)}}const Lt={MAJOR:1,MINOR:0},zt="RQM2";class Yt{constructor(t){D(this,"renderer");this.renderer=t}createExportCanvas(){let t=1/0,n=-1/0,e=1/0,i=-1/0;const s=new Set;if(this.renderer.getTiles().forEach(b=>{(b.terrain!==a.NONE||b.specialTerrain!==void 0)&&s.add(`${b.coord.q},${b.coord.r}`)}),this.renderer.getPaths().forEach(b=>{b.points.forEach(C=>{const T=this.renderer.getTiles().find(K=>{const U=K.vertices;let B=!1;for(let V=0,y=U.length-1;V<U.length;y=V++){const q=U[V].x,H=U[V].y,M=U[y].x,$=U[y].y;H>C.y!=$>C.y&&C.x<(M-q)*(C.y-H)/($-H)+q&&(B=!B)}return B});T&&s.add(`${T.coord.q},${T.coord.r}`)})}),s.forEach(b=>{const[C,T]=b.split(",").map(Number);t=Math.min(t,C),n=Math.max(n,C),e=Math.min(e,T),i=Math.max(i,T)}),t===1/0||s.size===0)throw new Error("No content to export!");this.renderer.getTiles().forEach(b=>{b.coord.q>=t&&b.coord.q<=n&&b.coord.r>=e&&b.coord.r<=i&&s.add(`${b.coord.q},${b.coord.r}`)});let r=1/0,m=1/0,h=-1/0,c=-1/0;this.renderer.getTiles().forEach(b=>{s.has(`${b.coord.q},${b.coord.r}`)&&b.vertices.forEach(C=>{r=Math.min(r,C.x),m=Math.min(m,C.y),h=Math.max(h,C.x),c=Math.max(c,C.y)})});const l=document.createElement("canvas"),g=4;l.width=(h-r)*g,l.height=(c-m)*g;const f=l.getContext("2d",{alpha:!0});if(!f)throw new Error("Failed to get export canvas context");f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",f.clearRect(0,0,l.width,l.height);const v=this.renderer.getZoom(),p=this.renderer.getPanX(),d=this.renderer.getPanY();try{f.scale(g,g),f.translate(-r,-m),this.renderer.setZoom(1),this.renderer.setPanPosition(0,0),this.renderer.renderToContext(f,!0,s)}finally{this.renderer.setZoom(v),this.renderer.setPanPosition(p,d)}return l}createExportButtons(){const t=document.createElement("div");t.className="export-buttons-container";const n=document.createElement("h2");n.textContent="Map Data",t.appendChild(n);const e=document.createElement("div");e.className="button-group storage-buttons";const i=document.createElement("div");i.className="export-buttons-row storage-buttons-row";const s=document.createElement("button");s.className="export-button png-export-button",s.textContent="Save PNG",s.addEventListener("click",()=>this.exportToPNG()),i.appendChild(s);const o=document.createElement("button");o.className="export-button dat-export-button",o.textContent="Save DAT",o.addEventListener("click",()=>this.saveToBinary()),i.appendChild(o);const r=document.createElement("button");r.className="export-button",r.textContent="Load DAT",r.addEventListener("click",()=>this.loadFromBinary()),i.appendChild(r),e.appendChild(i);const m=document.createElement("div");m.className="storage-divider";const h=document.createElement("div");h.className="export-buttons-row storage-buttons-row";const c=document.createElement("button");return c.className="export-button reset-button",c.textContent="Reset Map",c.addEventListener("click",()=>this.showResetConfirmation()),h.appendChild(c),e.appendChild(m),e.appendChild(h),t.appendChild(e),t}showExportPreview(t){const n=document.createElement("div");n.className="modal-backdrop",document.body.appendChild(n);const e=document.createElement("div");e.className="export-preview-modal";const i=document.createElement("button");i.className="modal-close-button",i.innerHTML="×",e.appendChild(i);const s=document.createElement("h3");s.textContent="Preview",e.appendChild(s);const o=document.createElement("div");o.className="export-preview-container";const r=document.createElement("canvas"),m=800,h=600,c=m/t.width,l=h/t.height,g=Math.min(c,l,1);r.width=t.width*g,r.height=t.height*g;const f=r.getContext("2d");f&&(f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",f.drawImage(t,0,0,r.width,r.height)),o.appendChild(r),e.appendChild(o);const v=document.createElement("div");v.className="export-controls-container";const p=document.createElement("div");p.className="compass-control";const d=document.createElement("label");d.textContent="Add Compass",d.htmlFor="compass-toggle",d.style.cursor="pointer";const b=document.createElement("div");b.className="toggle-switch",b.style.cursor="pointer";const C=document.createElement("input");C.type="checkbox",C.id="compass-toggle";const T=document.createElement("span");T.className="toggle-slider",b.appendChild(C),b.appendChild(T);const K=document.createElement("div");K.className="compass-size-control",K.style.display="none";const U=document.createElement("label");U.textContent="Change Size",U.style.marginLeft="24px",U.style.marginRight="8px";const B=document.createElement("input");B.type="range",B.min="5",B.max="50",B.value="25",B.className="size-slider",B.style.width="100px",K.appendChild(U),K.appendChild(B);const V=document.createElement("div");V.className="compass-tooltip",V.textContent="Click and drag to move the compass";const y=document.createElement("div");y.className="timer";const q=document.createElementNS("http://www.w3.org/2000/svg","svg");q.setAttribute("class","timer-circle"),q.setAttribute("viewBox","0 0 24 24");const H=document.createElementNS("http://www.w3.org/2000/svg","circle");H.setAttribute("cx","12"),H.setAttribute("cy","12"),H.setAttribute("r","10");const M=document.createElementNS("http://www.w3.org/2000/svg","circle");M.setAttribute("class","progress"),M.setAttribute("cx","12"),M.setAttribute("cy","12"),M.setAttribute("r","10"),q.appendChild(H),q.appendChild(M);const $=document.createElement("div");$.className="timer-text",y.appendChild(q),y.appendChild($);const k=document.createElement("button");k.className="close-tooltip",k.innerHTML="×",k.addEventListener("click",z=>{z.stopPropagation(),ut()}),V.appendChild(y),V.appendChild(k);function ut(){V.parentNode&&V.parentNode.removeChild(V)}function yt(z,st){const ht=2*Math.PI*10,xt=ht-z/st*ht;M.style.strokeDashoffset=`${xt}`,$.textContent=`${z}`}function mt(z){let st=z;y.style.display="flex",yt(st,z);const ht=setInterval(()=>{st--,yt(st,z),st<=0&&(clearInterval(ht),ut())},1e3);return ht}[d,b,T].forEach(z=>{z.addEventListener("click",st=>{st.stopPropagation(),C.checked=!C.checked,C.dispatchEvent(new Event("change"))})}),p.appendChild(d),p.appendChild(b),p.appendChild(K);const pt=document.createElement("div");pt.className="export-dimensions-info",pt.textContent=`Image dimensions: ${t.width}×${t.height} pixels`,v.appendChild(p),v.appendChild(pt),e.appendChild(v);const dt=new Image;dt.src="./src/assets/compass.png";let w=0,G=0,Y=!1,rt=0,nt=0;dt.onload=()=>{C.disabled=!1},dt.onerror=()=>{dt.src="/src/assets/compass.png"};let it=!1,Z=null;C.addEventListener("change",()=>{if(it=C.checked,K.style.display=it?"flex":"none",r.classList.toggle("compass-active",it),it){if(w===0&&G===0){const z=Math.min(r.width,r.height)*(parseInt(B.value)/100);w=r.width-z-r.width*.2,G=r.height*.2}o.appendChild(V),V.classList.add("visible"),Z&&clearInterval(Z),Z=mt(5)}else ut(),Z&&(clearInterval(Z),Z=null);j()}),B.addEventListener("input",()=>{j()}),r.addEventListener("mousedown",z=>{if(!it)return;const st=r.getBoundingClientRect(),ht=z.clientX-st.left,xt=z.clientY-st.top,wt=Math.min(r.width,r.height)*(parseInt(B.value)/100);ht>=w&&ht<=w+wt&&xt>=G&&xt<=G+wt&&(Y=!0,rt=ht-w,nt=xt-G,r.style.cursor="grabbing")}),r.addEventListener("mousemove",z=>{if(!Y)return;const st=r.getBoundingClientRect(),ht=z.clientX-st.left,xt=z.clientY-st.top;w=ht-rt,G=xt-nt;const wt=Math.min(r.width,r.height)*(parseInt(B.value)/100);w=Math.max(0,Math.min(r.width-wt,w)),G=Math.max(0,Math.min(r.height-wt,G)),j()}),r.addEventListener("mouseup",()=>{Y=!1,r.style.cursor=it?"grab":"default"}),r.addEventListener("mouseleave",()=>{Y=!1,r.style.cursor=it?"grab":"default"});function j(){const z=r.getContext("2d");if(z&&(z.clearRect(0,0,r.width,r.height),z.drawImage(t,0,0,r.width,r.height),it&&dt.complete)){const st=Math.min(r.width,r.height)*(parseInt(B.value)/100);z.drawImage(dt,w,G,st,st)}}const at=document.createElement("div");at.className="modal-buttons";const lt=document.createElement("button");lt.className="modal-button primary",lt.textContent="Save PNG";const tt=document.createElement("button");tt.className="modal-button secondary",tt.textContent="Cancel",at.appendChild(lt),at.appendChild(tt),e.appendChild(at);const gt=()=>{document.body.removeChild(n),document.body.removeChild(e)};tt.addEventListener("click",gt),i.addEventListener("click",gt),n.addEventListener("click",z=>{z.target===n&&gt()}),lt.addEventListener("click",()=>{gt();const z=document.createElement("canvas");z.width=t.width,z.height=t.height;const st=z.getContext("2d");if(!st)return;if(st.drawImage(t,0,0),it&&dt.complete){const xt=t.width/r.width,wt=Math.min(z.width,z.height)*(parseInt(B.value)/100);st.drawImage(dt,w*xt,G*xt,wt,wt)}const ht=document.createElement("a");ht.download="reconquest-map.png",ht.href=z.toDataURL("image/png",1),ht.click()}),document.body.appendChild(e)}showResetConfirmation(){const t=document.createElement("div");t.className="modal-backdrop",document.body.appendChild(t);const n=document.createElement("div");n.className="custom-terrain-modal";const e=document.createElement("button");e.className="modal-close-button",e.innerHTML="×",n.appendChild(e);const i=document.createElement("h3");i.textContent="Reset Map",n.appendChild(i);const s=document.createElement("div");s.style.textAlign="center",s.style.marginTop="20px",s.style.marginBottom="30px",s.textContent=`Are you sure you want to reset the map?
This action cannot be undone.`,s.style.whiteSpace="pre-line",n.appendChild(s);const o=document.createElement("div");o.className="modal-buttons";const r=document.createElement("button");r.className="modal-button reset-button",r.textContent="Reset";const m=document.createElement("button");m.className="modal-button secondary",m.textContent="Cancel",o.appendChild(r),o.appendChild(m),n.appendChild(o);const h=()=>{document.body.removeChild(t),document.body.removeChild(n)};m.addEventListener("click",h),e.addEventListener("click",h),t.addEventListener("click",c=>{c.target===t&&h()}),r.addEventListener("click",()=>{const c=new CustomEvent("maploaded",{detail:{dimensions:{columns:35,rows:20},totalLeftOperations:0,tiles:[],paths:[]}});document.dispatchEvent(c),h()}),document.body.appendChild(n)}exportToPNG(){const t=this.createExportCanvas();this.showExportPreview(t)}async saveToBinary(){try{const t=this.renderer.getTiles(),n=this.renderer.getPaths(),e=this.serializeMapToBinary(t,n),i=new Blob([e],{type:"application/octet-stream"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download="map.dat",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}catch(t){console.error("Failed to save binary map:",t),alert("Failed to save map. See console for details.")}}async loadFromBinary(){try{const t=document.createElement("input");t.type="file",t.accept=".dat",t.onchange=async n=>{var s;const e=(s=n.target.files)==null?void 0:s[0];if(!e)return;const i=await e.arrayBuffer();try{console.log("Starting map load process...");const o=this.deserializeMapFromBinary(i);console.log("Loaded map data:",{dimensions:o.dimensions,totalLeftOperations:o.totalLeftOperations,tileCount:o.tiles.length,pathCount:o.paths.length});const r=30;console.log("Using hex size:",r);const m=r*2*3/4,h=r*Math.sqrt(3),c=Math.ceil(o.dimensions.columns*m),l=Math.ceil(o.dimensions.rows*h);console.log("Calculated grid dimensions:",{width:c,height:l});const g=new St(r,c,l);console.log("Generating base grid with totalLeftOperations:",o.totalLeftOperations);const f=g.generateGrid(o.totalLeftOperations);console.log("Base grid generated:",{tileCount:f.length,sampleTile:f[0],bounds:this.calculateGridBounds(f)});const v=new Map,p=new Map;o.tiles.forEach(y=>{v.set(`${y.coord.q},${y.coord.r}`,y)}),f.forEach(y=>{p.set(`${y.coord.q},${y.coord.r}`,y)}),console.log("Created lookup maps:",{loadedTiles:v.size,baseGridTiles:p.size}),console.log("Starting tile reconstruction...");const d=f.map(y=>{const q=`${y.coord.q},${y.coord.r}`,H=v.get(q);if(!H)return y;const M={...y,terrain:H.terrain,specialTerrain:H.specialTerrain,customTerrain:H.customTerrain,treeOverlay:H.treeOverlay,abovePaths:H.abovePaths};return y.coord.q<2&&y.coord.r<2&&console.log(`Tile at (${y.coord.q}, ${y.coord.r}):`,{baseGeometry:{center:y.center,vertexCount:y.vertices.length},newGeometry:{center:M.center,vertexCount:M.vertices.length},terrain:M.terrain,specialTerrain:M.specialTerrain}),M});console.log("Tiles reconstructed:",{count:d.length,bounds:this.calculateGridBounds(d)});const b=-c/2,C=c/2,T=-l/2,K=l/2,U=new Map;d.forEach(y=>{U.set(`${Math.round(y.center.x)},${Math.round(y.center.y)}`,y.center)}),console.log("Starting path adjustment...");const B=o.paths.map((y,q)=>{const H={...y,points:y.points.map((M,$)=>{let k=M,ut=Number.MAX_VALUE;const yt=r*2,mt=Math.round(M.x-yt),pt=Math.round(M.x+yt),dt=Math.round(M.y-yt),w=Math.round(M.y+yt);for(let rt=mt;rt<=pt;rt+=r)for(let nt=dt;nt<=w;nt+=r){const it=`${rt},${nt}`,Z=U.get(it);if(Z){const j=Z.x-M.x,at=Z.y-M.y,lt=j*j+at*at;lt<ut&&(ut=lt,k=Z)}}let G=.5;$===0||$===y.points.length-1?G=.75:ut>r*r/4&&(G=.65);const Y={x:M.x+(k.x-M.x)*G,y:M.y+(k.y-M.y)*G};return Y.x=Math.max(b,Math.min(C,Y.x)),Y.y=Math.max(T,Math.min(K,Y.y)),q===0&&console.log(`Path point ${$} adjustment:`,{original:M,closest:k,adjusted:Y,distance:Math.sqrt(ut),factor:G}),Y}),smoothPoints:void 0};return q===0&&console.log("First path adjustment:",{originalPoints:y.points.length,adjustedPoints:H.points.length,type:y.type,width:y.width}),H});console.log("Paths adjusted:",{count:B.length,totalPoints:B.reduce((y,q)=>y+q.points.length,0)}),console.log("Updating renderer..."),this.renderer.setTiles(d),this.renderer.setPaths(B),console.log("Forcing render..."),this.renderer.render(),console.log("Dispatching maploaded event...");const V=new CustomEvent("maploaded",{detail:{dimensions:o.dimensions,totalLeftOperations:o.totalLeftOperations,tiles:d,paths:B}});document.dispatchEvent(V),console.log("Map load process completed.")}catch(o){console.error("Failed to parse binary map:",o),alert("Invalid or corrupted map file. See console for details.")}},t.click()}catch(t){console.error("Failed to load binary map:",t),alert("Failed to load map. See console for details.")}}createUniqueImageMap(t){var s;const n=new Set,e=new Map;for(const o of t)((s=o.customTerrain)==null?void 0:s.type)==="image"&&n.add(o.customTerrain.value);const i=Array.from(n);return i.forEach((o,r)=>{e.set(o,r)}),{imageMap:i,imageToIndex:e}}serializeMapToBinary(t,n){const{imageMap:e,imageToIndex:i}=this.createUniqueImageMap(t),s=new Map;t.forEach(d=>{if(d.customTerrain){const b={type:d.customTerrain.type,value:d.customTerrain.value};s.set(`${d.coord.q},${d.coord.r}`,b)}});let o=12+8+4,r=4;for(const d of e)r+=4+d.length;o+=r;let m=4;for(const d of t)m+=8+1+1,d.specialTerrain!==void 0&&(m+=1),d.customTerrain&&(m+=1,d.customTerrain.type==="color"?m+=4+d.customTerrain.value.length:m+=4),d.treeOverlay&&(m+=2);o+=m+this.calculatePathsSize(n);const h=new ArrayBuffer(o),c=new DataView(h);let l=0;const g=new TextEncoder,f=g.encode(zt);for(let d=0;d<4;d++)c.setUint8(l++,f[d]);c.setUint16(l,Lt.MAJOR),l+=2,c.setUint16(l,Lt.MINOR),l+=2,c.setUint32(l,o),l+=4;const v=this.calculateGridDimensions(t);c.setUint32(l,v.rows),l+=4,c.setUint32(l,v.columns),l+=4;const p=this.calculateTotalLeftOperations(t);c.setUint32(l,p),l+=4,c.setUint32(l,e.length),l+=4;for(const d of e){const b=g.encode(d);c.setUint32(l,b.length),l+=4,new Uint8Array(h,l,b.length).set(b),l+=b.length}c.setUint32(l,t.length),l+=4;for(const d of t){c.setInt32(l,d.coord.q),l+=4,c.setInt32(l,d.coord.r),l+=4,c.setUint8(l,this.terrainTypeToNumber(d.terrain)),l+=1;const b=(d.specialTerrain!==void 0?1:0)|(d.customTerrain!==void 0?2:0)|(d.treeOverlay!==void 0?4:0)|(d.abovePaths?8:0);if(c.setUint8(l,b),l+=1,d.specialTerrain!==void 0&&(c.setUint8(l,this.terrainTypeToNumber(d.specialTerrain)),l+=1),d.customTerrain)if(c.setUint8(l,d.customTerrain.type==="color"?0:1),l+=1,d.customTerrain.type==="color"){const C=g.encode(d.customTerrain.value);c.setUint32(l,C.length),l+=4,new Uint8Array(h,l,C.length).set(C),l+=C.length}else{const C=i.get(d.customTerrain.value)??0;c.setUint32(l,C),l+=4}d.treeOverlay&&(c.setUint8(l,d.treeOverlay.type==="forest"?0:1),l+=1,c.setUint8(l,d.treeOverlay.abovePaths?1:0),l+=1)}return this.writePathsToBuffer(c,l,n),h}deserializeMapFromBinary(t){const n=new DataView(t);let e=0;const i=new TextDecoder,s=new Uint8Array(t,0,4);if(i.decode(s)!==zt)throw new Error("Invalid map file format");e+=4;const r=n.getUint16(e);e+=2;const m=n.getUint16(e);if(e+=2,r>Lt.MAJOR||r===Lt.MAJOR&&m>Lt.MINOR)throw new Error("Unsupported map file version");const h=n.getUint32(e);if(e+=4,h!==t.byteLength)throw new Error("Corrupted map file");const c=n.getUint32(e);e+=4;const l=n.getUint32(e);e+=4;const g=n.getUint32(e);e+=4;const f=n.getUint32(e);e+=4;const v=[];for(let C=0;C<f;C++){const T=n.getUint32(e);e+=4;const K=new Uint8Array(t,e,T);v.push(i.decode(K)),e+=T}const p=[],d=n.getUint32(e);e+=4;for(let C=0;C<d;C++){const T=n.getInt32(e);e+=4;const K=n.getInt32(e);e+=4;const U=this.numberToTerrainType(n.getUint8(e));e+=1;const B=n.getUint8(e);e+=1;const V={coord:{q:T,r:K},terrain:U,center:{x:0,y:0},vertices:[]};if(B&1&&(V.specialTerrain=this.numberToTerrainType(n.getUint8(e)),e+=1),B&2){const y=n.getUint8(e)===0?"color":"image";if(e+=1,y==="color"){const q=n.getUint32(e);e+=4;const H=new Uint8Array(t,e,q);V.customTerrain={type:"color",value:i.decode(H)},e+=q}else{const q=n.getUint32(e);e+=4,V.customTerrain={type:"image",value:v[q]}}}B&4&&(V.treeOverlay={type:n.getUint8(e)===0?"forest":"bog",abovePaths:n.getUint8(e+1)===1},e+=2),B&8&&(V.abovePaths=!0),p.push(V)}const b=this.readPathsFromBuffer(n,e);return{tiles:p,paths:b,dimensions:{rows:c,columns:l},totalLeftOperations:g}}calculatePathsSize(t){let n=4;for(const e of t)n+=1+4+4+4+e.points.length*8;return n}writePathsToBuffer(t,n,e){let i=n;t.setUint32(i,e.length),i+=4;for(const s of e){t.setUint8(i,s.type==="PATH"?0:1),i+=1,t.setFloat32(i,s.width),i+=4,t.setUint32(i,this.parseColor(s.strokeStyle)),i+=4,t.setUint32(i,s.points.length),i+=4;for(const o of s.points)t.setFloat32(i,o.x),i+=4,t.setFloat32(i,o.y),i+=4}}readPathsFromBuffer(t,n){let e=n;const i=[],s=t.getUint32(e);e+=4;for(let o=0;o<s;o++){const r=t.getUint8(e)===0?"PATH":"RIVER";e+=1;const m=t.getFloat32(e);e+=4;const h=this.formatColor(t.getUint32(e));e+=4;const c=t.getUint32(e);e+=4;const l=[];for(let g=0;g<c;g++)l.push({x:t.getFloat32(e),y:t.getFloat32(e+4)}),e+=8;i.push({type:r,width:m,strokeStyle:h,points:l})}return i}calculateTotalLeftOperations(t){const n=t.filter(i=>i.coord.q===0),e=t.filter(i=>i.coord.q===1);if(n.length>0&&e.length>0){const i=n[0].center.y,s=e[0].center.y;return i>s?1:0}return 0}calculateGridDimensions(t){let n=1/0,e=-1/0,i=1/0,s=-1/0;for(const o of t)n=Math.min(n,o.coord.q),e=Math.max(e,o.coord.q),i=Math.min(i,o.coord.r),s=Math.max(s,o.coord.r);return{rows:s-i+1,columns:e-n+1}}terrainTypeToNumber(t){return Object.values(a).indexOf(t)}numberToTerrainType(t){return Object.values(a)[t]}parseColor(t){let n=0,e=0,i=0,s=255;if(t.startsWith("#")){const o=t.substring(1);n=parseInt(o.substring(0,2),16),e=parseInt(o.substring(2,4),16),i=parseInt(o.substring(4,6),16),o.length===8&&(s=parseInt(o.substring(6,8),16))}else if(t.startsWith("rgba")){const o=t.substring(5,t.length-1).split(",");n=parseInt(o[0]),e=parseInt(o[1]),i=parseInt(o[2]),s=Math.round(parseFloat(o[3])*255)}else if(t.startsWith("rgb")){const o=t.substring(4,t.length-1).split(",");n=parseInt(o[0]),e=parseInt(o[1]),i=parseInt(o[2])}return n<<24|e<<16|i<<8|s}formatColor(t){const n=t>>24&255,e=t>>16&255,i=t>>8&255,s=(t&255)/255;return`rgba(${n},${e},${i},${s})`}calculateGridBounds(t){const n={x:{min:1/0,max:-1/0},y:{min:1/0,max:-1/0},q:{min:1/0,max:-1/0},r:{min:1/0,max:-1/0}};return t.forEach(e=>{n.x.min=Math.min(n.x.min,e.center.x),n.x.max=Math.max(n.x.max,e.center.x),n.y.min=Math.min(n.y.min,e.center.y),n.y.max=Math.max(n.y.max,e.center.y),n.q.min=Math.min(n.q.min,e.coord.q),n.q.max=Math.max(n.q.max,e.coord.q),n.r.min=Math.min(n.r.min,e.coord.r),n.r.max=Math.max(n.r.max,e.coord.r)}),n}}function Xt(){const S=document.getElementById("app"),t=document.querySelector(".map-container");if(!S||!t)return;const n=document.createElement("canvas");function e(){if(!t)return{width:0,height:0};const x=t.getBoundingClientRect(),P=window.devicePixelRatio||1;n.style.width=`${x.width}px`,n.style.height=`${x.height}px`,n.width=x.width*P,n.height=x.height*P;const u=n.getContext("2d");return u&&u.scale(P,P),{width:x.width,height:x.height}}const i=e();t.appendChild(n);const s=document.createElement("button");s.className="map-control-button",s.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1v22M8 18l4 4 4-4M8 6l4-4 4 4"/>
        <path d="M1 12h22M18 8l4 4-4 4M6 8l-4 4 4 4"/>
    </svg>`,s.title="Drag Mode",s.addEventListener("click",()=>v.selectDragTool()),s.style.outline="2px solid #4B9CD3",s.style.outlineOffset="-2px",t.appendChild(s);const o=document.createElement("button");o.className="map-control-button",o.style.left="60px",o.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="11" y1="8" x2="11" y2="14"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
    </svg>`,o.title="Zoom In",o.addEventListener("click",()=>p.updateZoom(100,n.width/2,n.height/2)),t.appendChild(o);const r=document.createElement("button");r.className="map-control-button",r.style.left="110px",r.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
    </svg>`,r.title="Zoom Out",r.addEventListener("click",()=>p.updateZoom(-100,n.width/2,n.height/2)),t.appendChild(r);const m=document.createElement("button");m.className="map-control-button",m.style.left="160px",m.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v4M12 18v4M4 12H2M22 12h-4"/>
        <circle cx="12" cy="12" r="6"/>
    </svg>`,m.title="Recenter Map",m.addEventListener("click",()=>{const{zoom:x,centerX:P,centerY:u}=U();p.setZoom(x),p.setPanPosition(P,u),p.render()}),t.appendChild(m);const h=30;let c=35,l=20,g=0,f=new St(h,Math.ceil(c*h*2*3/4),Math.ceil(l*h*Math.sqrt(3)));const v=new Ht,p=new Gt(n,v),d=new $t(p),b=new Yt(p);p.setZoom(.7);const C=250;p.setPanPosition((i.width-C)/2,i.height/2),document.addEventListener("maploaded",x=>{const{dimensions:P,totalLeftOperations:u,tiles:R,paths:F}=x.detail;c=P.columns,l=P.rows,g=u;const O=h*2*3/4,Q=h*Math.sqrt(3),L=Math.ceil(c*O),X=Math.ceil(l*Q);f=new St(h,L,X);const W=f.generateGrid(g),A=new Map;R.forEach(E=>{A.set(`${E.coord.q},${E.coord.r}`,E)});const N=W.map(E=>{const ct=`${E.coord.q},${E.coord.r}`,_=A.get(ct);return _?{...E,terrain:_.terrain,specialTerrain:_.specialTerrain,customTerrain:_.customTerrain,treeOverlay:_.treeOverlay,abovePaths:_.abovePaths}:E}),I=document.querySelector(".dimensions");I&&(I.textContent=`${c}×${l}`),T=N,p.setTiles(N),p.setPaths(F),v.setPaths(F),v.deselectAll(),v.selectDragTool(),d.updateGridDimensions(c,l),d.deselectAll(),p.render();const{zoom:et,centerX:ot,centerY:J}=U();p.setZoom(et),p.setPanPosition(ot,J)}),d.setTerrainSelectCallback(()=>{v.deselectAll(),s.style.outline="none",s.style.outlineOffset="0"}),d.setGridSizeChangeCallback(x=>{let P=!1;switch(x){case"col+left":case"col+right":P=c<50;break;case"col-left":case"col-right":P=c>5;break;case"row+top":case"row+bottom":P=l<30;break;case"row-top":case"row-bottom":P=l>5;break}if(!P)return;switch(M(),x){case"col+left":c++,g++;break;case"col+right":c++;break;case"col-left":c--,g++;break;case"col-right":c--;break;case"row+top":case"row+bottom":l++;break;case"row-top":case"row-bottom":l--;break}let u=0,R=0;(x==="col+left"||x==="col-left")&&(u=x==="col+left"?1:-1),(x==="row+top"||x==="row-top")&&(R=x==="row+top"?1:-1);const F=h*2*3/4,O=h*Math.sqrt(3),Q=Math.ceil(c*F),L=Math.ceil(l*O);f=new St(h,Q,L);const X=f.generateGrid(g),W=new Map;T.forEach(I=>{W.set(`${I.coord.q},${I.coord.r}`,I)});for(const I of X){const et=I.coord.q-u,ot=I.coord.r-R,J=`${et},${ot}`,E=W.get(J);E&&(I.terrain=E.terrain,I.specialTerrain=E.specialTerrain,I.customTerrain=E.customTerrain,I.treeOverlay=E.treeOverlay,I.abovePaths=E.abovePaths)}let A=0,N=0;switch(x){case"col+left":case"col-left":A=x==="col+left"?1:-1;break;case"col+right":case"col-right":A=x==="col+right"?-1:1;break;case"row+top":case"row-top":N=x==="row+top"?1:-1;break;case"row+bottom":case"row-bottom":N=x==="row+bottom"?-1:1;break}if(A!==0||N!==0){const I=p.getPaths(),et=h*2*3/4,ot=h*Math.sqrt(3),J=I.map(Et=>{var Tt;return{...Et,points:Et.points.map(bt=>({x:bt.x+A*et/2,y:bt.y+N*ot/2})),smoothPoints:(Tt=Et.smoothPoints)==null?void 0:Tt.map(bt=>({x:bt.x+A*et/2,y:bt.y+N*ot/2}))}}),E=c*et,ct=l*ot,_=h*2,ft=-E/2-_/4,vt=E/2-_/4,Mt=-ct/2,It=ct/2,kt=[];J.forEach(Et=>{let Tt=[],bt=!1;Et.points.forEach(Ot=>{const Dt=Ot.x>=ft&&Ot.x<=vt&&Ot.y>=Mt&&Ot.y<=It;Dt?(Tt.push(Ot),!bt&&Tt.length>1&&(Tt=[Ot])):bt&&Tt.length>=2&&(kt.push({...Et,points:[...Tt],smoothPoints:void 0}),Tt=[]),bt=Dt}),Tt.length>=2&&kt.push({...Et,points:Tt,smoothPoints:void 0})}),v.setPaths(kt),p.setPaths(kt)}T=X,p.setTiles(T),d.updateGridDimensions(c,l),p.render()}),v.setToolChangeCallback(()=>{d.deselectAll(),v.isDragMode()?(s.style.outline="2px solid #4B9CD3",s.style.outlineOffset="-2px"):(s.style.outline="none",s.style.outlineOffset="0")});let T=f.generateGrid();p.setTiles(T);let K=null;const U=()=>{const x=t.getBoundingClientRect(),P=250,u=60,R=h*2*3/4,F=h*Math.sqrt(3),O=c*R+u*2,Q=l*F+50,L=(x.width-P)/O,X=x.height/Q,W=Math.min(L,X)*.9;return{zoom:Math.max(.5,Math.min(W,3)),centerX:(x.width-P)/2,centerY:x.height/2}};window.addEventListener("resize",()=>{K&&window.clearTimeout(K),K=window.setTimeout(()=>{e();const{zoom:x,centerX:P,centerY:u}=U();p.setZoom(x),p.setPanPosition(P,u),p.render()},250)});const B=document.createElement("div");B.className="toolbar";const V=document.createElement("div");V.className="undo-redo-container";const y=[],q=[];let H=!1;function M(){const x={tiles:T.map(u=>({coord:{...u.coord},terrain:u.terrain,specialTerrain:u.specialTerrain,customTerrain:u.customTerrain?{...u.customTerrain}:void 0,center:{...u.center},vertices:[...u.vertices],abovePaths:u.abovePaths,treeOverlay:u.treeOverlay?{...u.treeOverlay}:void 0})),paths:p.getPaths().map(u=>({...u,points:[...u.points],smoothPoints:u.smoothPoints?[...u.smoothPoints]:void 0})),cols:c,rows:l,leftOperations:g},P=y[y.length-1];(!P||!$(P,x))&&(y.push(x),q.length=0)}function $(x,P){if(x.cols!==P.cols||x.rows!==P.rows||x.leftOperations!==P.leftOperations||x.paths.length!==P.paths.length||x.tiles.length!==P.tiles.length)return!1;for(let u=0;u<x.tiles.length;u++){const R=x.tiles[u],F=P.tiles[u];if(R.terrain!==F.terrain||R.specialTerrain!==F.specialTerrain||R.abovePaths!==F.abovePaths||JSON.stringify(R.customTerrain)!==JSON.stringify(F.customTerrain)||JSON.stringify(R.treeOverlay)!==JSON.stringify(F.treeOverlay))return!1}for(let u=0;u<x.paths.length;u++){const R=x.paths[u],F=P.paths[u];if(R.type!==F.type||R.width!==F.width||R.points.length!==F.points.length)return!1;for(let O=0;O<R.points.length;O++)if(R.points[O].x!==F.points[O].x||R.points[O].y!==F.points[O].y)return!1}return!0}const k=()=>{if(!(H||y.length===0)){H=!0;try{const x=y.pop();if(x){const P={tiles:T.map(u=>({coord:{...u.coord},terrain:u.terrain,specialTerrain:u.specialTerrain,customTerrain:u.customTerrain?{...u.customTerrain}:void 0,center:{...u.center},vertices:[...u.vertices],abovePaths:u.abovePaths,treeOverlay:u.treeOverlay?{...u.treeOverlay}:void 0})),paths:v.getPaths().map(u=>({...u,points:[...u.points],smoothPoints:u.smoothPoints?[...u.smoothPoints]:void 0})),cols:c,rows:l,leftOperations:g};q.push(P),yt(x)}}finally{H=!1}}},ut=()=>{if(!(H||q.length===0)){H=!0;try{const x=q.pop();if(x){const P={tiles:T.map(u=>({coord:{...u.coord},terrain:u.terrain,specialTerrain:u.specialTerrain,customTerrain:u.customTerrain?{...u.customTerrain}:void 0,center:{...u.center},vertices:[...u.vertices],abovePaths:u.abovePaths,treeOverlay:u.treeOverlay?{...u.treeOverlay}:void 0})),paths:v.getPaths().map(u=>({...u,points:[...u.points],smoothPoints:u.smoothPoints?[...u.smoothPoints]:void 0})),cols:c,rows:l,leftOperations:g};y.push(P),yt(x)}}finally{H=!1}}};function yt(x){c=x.cols,l=x.rows,g=x.leftOperations,f=new St(h,Math.ceil(c*h*2*3/4),Math.ceil(l*h*Math.sqrt(3))),T=x.tiles.map(u=>({coord:{...u.coord},terrain:u.terrain,specialTerrain:u.specialTerrain,customTerrain:u.customTerrain?{...u.customTerrain}:void 0,center:{...u.center},vertices:[...u.vertices],abovePaths:u.abovePaths,treeOverlay:u.treeOverlay?{...u.treeOverlay}:void 0}));const P=x.paths.map(u=>({...u,points:[...u.points],smoothPoints:u.smoothPoints?[...u.smoothPoints]:void 0}));p.setTiles(T),p.setPaths(P),v.setPaths(P),d.updateGridDimensions(c,l),p.render()}n.addEventListener("wheel",x=>{x.preventDefault();const P=n.getBoundingClientRect(),u=x.clientX-P.left,R=x.clientY-P.top;p.updateZoom(-x.deltaY,u,R)},{passive:!1});let mt=!1,pt=!1,dt=!1,w=null,G=0,Y=0,rt=0,nt=0;function it(x,P,u,R){const F=[],O=Math.hypot(u-x,R-P);if(O<5){const L=p.screenToMapCoordinates(u,R),X=T.find(W=>Rt(L,W.vertices));return X&&F.push(X),F}const Q=Math.max(2,Math.ceil(O/10));for(let L=0;L<=Q;L++){const X=L/Q,W=x+(u-x)*X,A=P+(R-P)*X,N=p.screenToMapCoordinates(W,A),I=T.find(et=>Rt(N,et.vertices));I&&!F.some(et=>et.coord.q===I.coord.q&&et.coord.r===I.coord.r)&&F.push(I)}return F}n.addEventListener("mousedown",x=>{const P=n.getBoundingClientRect(),u=x.clientX-P.left,R=x.clientY-P.top;if(rt=u,nt=R,v.isDragMode())dt=!0,n.style.cursor="grabbing",G=u,Y=R;else if(v.getCurrentTool()===Pt.PATH||v.getCurrentTool()===Pt.RIVER){const F=p.screenToMapCoordinates(u,R),O=T.find(Q=>Rt(F,Q.vertices));O&&(M(),mt=!0,v.startPath(O.center),p.setCurrentPath(v.getCurrentPath()))}else if(d.isTerrainSelected()){const F=p.screenToMapCoordinates(u,R),O=T.find(Q=>Rt(F,Q.vertices));if(O){const Q=d.getSelectedTerrain();if(d.getDrawMode()==="FILL"){pt=!0;return}if(M(),pt=!0,Q===a.NONE){if(d.getDrawMode()==="FILL")if(M(),O.terrain===a.NONE&&O.specialTerrain!==void 0){const X=O.specialTerrain,W=new Set,A=[O];for(;A.length>0;){const N=A.shift(),I=`${N.coord.q},${N.coord.r}`;if(!W.has(I)&&(W.add(I),N.terrain===a.NONE&&N.specialTerrain===X)){p.setTileTerrain(N,a.NONE),N.abovePaths=d.isDrawAbovePaths();const et=At(N);for(const ot of et){const J=T.find(E=>E.coord.q===ot.q&&E.coord.r===ot.r);J&&A.push(J)}}}p.render()}else Z(O,O.terrain,Q);else p.setTileTerrain(O,a.NONE),O.abovePaths=d.isDrawAbovePaths(),p.render();return}const L=d.getCustomTerrainData();p.setTileTerrain(O,Q,L||void 0),O.abovePaths=d.isDrawAbovePaths(),w=`${O.coord.q},${O.coord.r}`,p.render()}}else v.getCurrentTool()===Pt.REMOVE&&(M(),pt=!0)}),n.addEventListener("mousemove",x=>{const P=n.getBoundingClientRect(),u=x.clientX-P.left,R=x.clientY-P.top,F=p.screenToMapCoordinates(u,R),O=T.find(Q=>Rt(F,Q.vertices));if(dt||p.setHoveredTile(O||null),dt){const Q=u-G,L=R-Y;p.pan(Q,L),G=u,Y=R}else if(mt&&O)it(rt,nt,u,R).forEach(L=>{v.updatePath(L.center)}),p.setCurrentPath(v.getCurrentPath());else if(pt&&O&&d.getDrawMode()==="DRAW"&&d.isTerrainSelected()){const Q=it(rt,nt,u,R);Q.forEach(L=>{const X=`${L.coord.q},${L.coord.r}`;if(X!==w){const W=d.getSelectedTerrain();if(W===a.NONE){p.setTileTerrain(L,a.NONE),L.abovePaths=d.isDrawAbovePaths(),w=X;return}const A=d.getCustomTerrainData();p.setTileTerrain(L,W,A||void 0),L.abovePaths=d.isDrawAbovePaths(),w=X}}),Q.length>0&&p.render()}else if(pt&&O&&v.getCurrentTool()===Pt.REMOVE){const Q=it(rt,nt,u,R);if(Q.length>0){const L=[];let X=!1;v.getPaths().forEach(W=>{let A=[],N=!0;W.points.forEach(I=>{const et=Q.some(ot=>{let J=!1;const E=ot.vertices;for(let ct=0,_=E.length-1;ct<E.length;_=ct++){const ft=E[ct].x,vt=E[ct].y,Mt=E[_].x,It=E[_].y;vt>I.y!=It>I.y&&I.x<(Mt-ft)*(I.y-vt)/(It-vt)+ft&&(J=!J)}return J});et?N&&A.length>=2&&(L.push({points:[...A],type:W.type,width:W.width,strokeStyle:W.strokeStyle}),X=!0,A=[]):(A.push(I),!N&&A.length>=2&&(L.push({points:[...A],type:W.type,width:W.width,strokeStyle:W.strokeStyle}),X=!0,A=[I])),N=!et}),A.length>=2&&(L.push({points:[...A],type:W.type,width:W.width,strokeStyle:W.strokeStyle}),X=!0)}),X&&(v.setPaths(L),p.setPaths(L),p.render())}}rt=u,nt=R}),n.addEventListener("mouseup",()=>{dt?(dt=!1,n.style.cursor="grab"):mt&&(mt=!1,v.endPath(),p.setCurrentPath([]),p.setPaths(v.getPaths())),pt=!1,w=null}),n.addEventListener("mouseover",()=>{v.isDragMode()?n.style.cursor="grab":v.isDrawingMode()||d.isTerrainSelected()||v.getCurrentTool()===Pt.REMOVE?n.style.cursor="crosshair":n.style.cursor="default"}),n.addEventListener("mouseleave",()=>{dt&&(dt=!1,n.style.cursor="grab"),mt&&(mt=!1,v.endPath(),p.setPaths(v.getPaths())),pt=!1,w=null});function Z(x,P,u){if(P===u)return;const R=new Set,F=[],O=[x],Q=d.isDrawAbovePaths(),L=d.getCustomTerrainData(),X=Wt.has(u),W=x.specialTerrain,A=P===a.NONE&&W!==void 0,N=document.createElement("div");N.style.position="fixed",N.style.top="50%",N.style.left="50%",N.style.transform="translate(-50%, -50%)",N.style.padding="20px",N.style.backgroundColor="rgba(0, 0, 0, 0.7)",N.style.color="white",N.style.borderRadius="5px",N.style.zIndex="1000",N.textContent="Processing terrain...",document.body.appendChild(N);const I=100;function et(E){if(u===a.NONE){if(A)return E.terrain===a.NONE&&E.specialTerrain===W;const ct=E.terrain===P,_=W===void 0&&E.specialTerrain===void 0||W!==void 0&&E.specialTerrain===W;return ct&&_}return X?W?E.specialTerrain===W:E.specialTerrain===void 0:E.terrain===P}function ot(){for(;O.length>0;){const E=O.shift(),ct=`${E.coord.q},${E.coord.r}`;if(R.has(ct)||(R.add(ct),!et(E)))continue;F.push(E);const _=At(E);for(const ft of _){const vt=T.find(Mt=>Mt.coord.q===ft.q&&Mt.coord.r===ft.r);vt&&O.push(vt)}}J(0)}function J(E){const ct=Math.min(100,Math.round(E/F.length*100));if(N.textContent=`Processing terrain... ${ct}%`,E>=F.length){document.body.removeChild(N),p.render();return}const _=Math.min(E+I,F.length);for(let ft=E;ft<_;ft++){const vt=F[ft];u===a.NONE?p.setTileTerrain(vt,a.NONE):X?(vt.specialTerrain=u,delete vt.treeOverlay):u===a.CUSTOM&&L?p.setTileTerrain(vt,u,L):p.setTileTerrain(vt,u),vt.abovePaths=Q}requestAnimationFrame(()=>J(_))}ot()}n.addEventListener("click",x=>{if(!v.isDrawingMode()){const P=n.getBoundingClientRect(),u=x.clientX-P.left,R=x.clientY-P.top,F=p.screenToMapCoordinates(u,R),O=T.find(Q=>Rt(F,Q.vertices));if(O){if(v.getCurrentTool()===Pt.REMOVE){M();const L=O.vertices,X=A=>{let N=!1;for(let I=0,et=L.length-1;I<L.length;et=I++){const ot=L[I].x,J=L[I].y,E=L[et].x,ct=L[et].y;J>A.y!=ct>A.y&&A.x<(E-ot)*(A.y-J)/(ct-J)+ot&&(N=!N)}return N},W=[];v.getPaths().forEach(A=>{const N=[];let I=[];A.points.forEach((et,ot)=>{X(et)?I.length>0&&(N.push([...I]),I=[]):I.push(et),ot===A.points.length-1&&I.length>0&&N.push([...I])}),N.forEach(et=>{if(et.length>=2){const ot={points:et,type:A.type,width:A.width,strokeStyle:A.strokeStyle};W.push(ot)}})}),v.setPaths(W),p.setPaths(W),p.render()}else if(d.isTerrainSelected()){const L=d.getSelectedTerrain();if(L===a.NONE){if(d.getDrawMode()==="FILL")if(M(),O.terrain===a.NONE&&O.specialTerrain!==void 0){const X=O.specialTerrain,W=new Set,A=[O];for(;A.length>0;){const N=A.shift(),I=`${N.coord.q},${N.coord.r}`;if(!W.has(I)&&(W.add(I),N.terrain===a.NONE&&N.specialTerrain===X)){p.setTileTerrain(N,a.NONE),N.abovePaths=d.isDrawAbovePaths();const et=At(N);for(const ot of et){const J=T.find(E=>E.coord.q===ot.q&&E.coord.r===ot.r);J&&A.push(J)}}}p.render()}else Z(O,O.terrain,L);else p.setTileTerrain(O,a.NONE),O.abovePaths=d.isDrawAbovePaths(),p.render();return}if(d.getDrawMode()==="FILL"){const X=O.terrain;(Wt.has(L)||X!==L)&&(M(),Z(O,X,L))}else{const X=d.getCustomTerrainData();p.setTileTerrain(O,L,X||void 0),O.abovePaths=d.isDrawAbovePaths(),p.render()}}}}});const j=document.createElement("button");j.className="map-control-button",j.style.left="210px",j.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7v6h6"/>
        <path d="M3 13c0-4.97 4.03-9 9-9 4.97 0 9 4.03 9 9s-4.03 9-9 9c-2.49 0-4.74-1.01-6.36-2.64"/>
    </svg>`,j.title="Undo",j.addEventListener("click",k),t.appendChild(j);const at=document.createElement("button");at.className="map-control-button",at.style.left="260px",at.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 7v6h-6"/>
        <path d="M21 13c0-4.97-4.03-9-9-9-4.97 0-9 4.03-9 9s4.03 9 9 9c2.49 0 4.74-1.01 6.36-2.64"/>
    </svg>`,at.title="Redo",at.addEventListener("click",ut),t.appendChild(at);const lt=document.createElement("div");lt.className="grid-size-controls";const tt=document.createElement("button");tt.className="map-control-button",tt.style.cssText=`
        position: absolute;
        left: 310px;
        top: 10px;
        padding: 6px 12px;
        background: rgba(32, 32, 32, 0.8);
        border: 1px solid rgba(64, 64, 64, 0.6);
        border-radius: 6px;
        color: currentColor;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
        min-width: 130px;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    `,tt.textContent="Grid Numbers: On",tt.title="Toggle Grid Numbers";let gt=!0;tt.addEventListener("mouseover",()=>{tt.style.background="rgba(42, 42, 42, 0.9)",tt.style.borderColor="rgba(80, 80, 80, 0.8)"}),tt.addEventListener("mouseout",()=>{tt.style.background="rgba(32, 32, 32, 0.8)",tt.style.borderColor="rgba(64, 64, 64, 0.6)"}),tt.addEventListener("click",()=>{gt=!gt,tt.textContent=`Grid Numbers: ${gt?"On":"Off"}`,p.setShowGridNumbers(gt),p.render()}),t.appendChild(tt);const z=x=>{M();let P=0,u=0;switch(x){case"col+left":P=1;break;case"col-left":P=-1;break;case"row+top":u=1;break;case"row-top":u=-1;break}f=new St(h,Math.ceil(c*h*2*3/4),Math.ceil(l*h*Math.sqrt(3)));const R=f.generateGrid(g);for(const J of R){let E=J.coord.q,ct=J.coord.r;x.includes("col")&&(E-=P),x.includes("row")&&(ct-=u);const _=T.find(ft=>ft.coord.q===E&&ft.coord.r===ct);_&&(J.terrain=_.terrain,J.specialTerrain=_.specialTerrain,J.customTerrain=_.customTerrain,J.abovePaths=_.abovePaths,J.treeOverlay=_.treeOverlay)}const F=h*2*3/4,O=h*Math.sqrt(3),Q=c*F,L=l*O,X=h*2,W=-Q/2-X/4,A=Q/2-X/4,N=-L/2,I=L/2,et=v.getPaths(),ot=[];et.forEach(J=>{let E=[],ct=!1;J.points.forEach(_=>{const ft=_.x>=W&&_.x<=A&&_.y>=N&&_.y<=I;ft?(E.push(_),!ct&&E.length>1&&(E=[_])):ct&&E.length>=2&&(ot.push({...J,points:[...E],smoothPoints:void 0}),E=[]),ct=ft}),E.length>=2&&ot.push({...J,points:E,smoothPoints:void 0})}),v.setPaths(ot),p.setPaths(ot),T=R,p.setTiles(T),p.render()},st=document.createElement("div");st.className="grid-control top";const ht=document.createElement("div");ht.className="middle-controls";const xt=document.createElement("div");xt.className="grid-control bottom";const wt=()=>{const x=ht.querySelector(".dimensions");x&&(x.textContent=`${c}×${l}`)},Ct=(x,P)=>{const u=document.createElement("button");u.textContent=x.includes("+")?"+":"-",u.title=x,u.className=x.includes("+")?"plus":"minus",u.addEventListener("click",()=>{let R=!1;switch(x){case"col+left":case"col+right":c<50&&(c++,R=!0);break;case"col-left":case"col-right":c>5&&(c--,R=!0);break;case"row+top":case"row+bottom":l<30&&(l++,R=!0);break;case"row-top":case"row-bottom":l>5&&(l--,R=!0);break}R&&(wt(),f=new St(h,Math.ceil(c*h*2*3/4),Math.ceil(l*h*Math.sqrt(3))),z(x))}),P.appendChild(u)};Ct("row-top",st),Ct("row+top",st),Ct("col-left",ht),Ct("col+left",ht);const Bt=document.createElement("div");Bt.className="dimensions",Bt.textContent=`${c}×${l}`,ht.appendChild(Bt),Ct("col-right",ht),Ct("col+right",ht),Ct("row-bottom",xt),Ct("row+bottom",xt),lt.appendChild(st),lt.appendChild(ht),lt.appendChild(xt),t.appendChild(lt),B.appendChild(d.getElement()),B.appendChild(v.getElement()),B.appendChild(b.createExportButtons()),S.insertBefore(B,t)}function Rt(S,t){let n=!1;for(let e=0,i=t.length-1;e<t.length;i=e++){const s=t[e].x,o=t[e].y,r=t[i].x,m=t[i].y;o>S.y!=m>S.y&&S.x<(r-s)*(S.y-o)/(m-o)+s&&(n=!n)}return n}function At(S){const t=S.coord.q,n=S.coord.r,e=t%2===1;return[{q:t,r:n-1},{q:t+1,r:e?n:n-1},{q:t+1,r:e?n+1:n},{q:t,r:n+1},{q:t-1,r:e?n+1:n},{q:t-1,r:e?n:n-1}]}document.addEventListener("DOMContentLoaded",Xt);
