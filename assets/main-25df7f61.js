var Ft=Object.defineProperty;var $t=(E,t,s)=>t in E?Ft(E,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):E[t]=s;var W=(E,t,s)=>($t(E,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(i){if(i.ep)return;i.ep=!0;const n=s(i);fetch(i.href,n)}})();var a=(E=>(E.NONE="NONE",E.WATER="WATER",E.GRASS="GRASS",E.FOREST="FOREST",E.BOG="BOG",E.HILLS="HILLS",E.MOUNTAIN="MOUNTAIN",E.IMPASSABLE="IMPASSABLE",E.CLOUD="CLOUD",E.TOWN1="TOWN1",E.TOWN2="TOWN2",E.TOWN3="TOWN3",E.HARBOR="HARBOR",E.SHIPS="SHIPS",E.LIGHTTOWER="LIGHTTOWER",E.TREE="TREE",E.MINE="MINE",E.CUSTOM="CUSTOM",E))(a||{});const Dt=new Set(["TOWN1","TOWN2","TOWN3","HARBOR","SHIPS","LIGHTTOWER","TREE","MINE"]),It=new Set(["TOWN1","TOWN2","TOWN3","LIGHTTOWER","TREE"]);class Ot{constructor(t,s,e){W(this,"hexSize");W(this,"width");W(this,"height");this.hexSize=t,this.width=s,this.height=e}calculateHexVertices(t){const s=[];for(let e=0;e<6;e++){const i=Math.PI/3*e;s.push({x:t.x+this.hexSize*Math.cos(i),y:t.y+this.hexSize*Math.sin(i)})}return s}generateGrid(t=0){const s=[],e=this.hexSize*2,i=this.hexSize*Math.sqrt(3),n=e*3/4,o=i,r=Math.floor(this.width/(this.hexSize*2*3/4)),c=Math.floor(this.height/(this.hexSize*Math.sqrt(3))),h=r*n,l=c*o,d=-h/2,g=-l/2;for(let v=0;v<r;v++){const p=(t%2===1?v+1:v)%2*(o/2);for(let u=0;u<c;u++){const O={x:d+v*n,y:g+u*o+p};s.push({coord:{q:v,r:u},terrain:a.NONE,center:O,vertices:this.calculateHexVertices(O)})}}return s}pixelToAxial(t,s){const e=(Math.sqrt(3)/3*t-s/3)/this.hexSize,i=s*2/3/this.hexSize;return{q:e,r:i}}axialToPixel(t){const s=this.hexSize*(Math.sqrt(3)*t.q+Math.sqrt(3)/2*t.r),e=this.hexSize*(3/2*t.r);return{x:s,y:e}}roundAxial(t){let s=Math.round(t.q),e=Math.round(t.r);const i=Math.abs(s-t.q),n=Math.abs(e-t.r);return i>n&&(s=-e),{q:s,r:e}}hexDistance(t,s){return Math.max(Math.abs(t.q-s.q),Math.abs(t.r-s.r))}lerpAxial(t,s,e){return{q:t.q*(1-e)+s.q*e,r:t.r*(1-e)+s.r*e}}getHexLine(t,s){const e=this.roundAxial(this.pixelToAxial(t.x,t.y)),i=this.roundAxial(this.pixelToAxial(s.x,s.y)),n=this.hexDistance(e,i),o=[];for(let r=0;r<=n;r++){const c=n===0?0:r/n,h=this.roundAxial(this.lerpAxial(e,i,c));o.push(this.axialToPixel(h))}return o}}function Ht(E,t,s=.1){if(t<1)throw new Error("Resolution must be at least 1");if(E.length<2)return E;const e=E[0],i=E[E.length-1],n={x:e.x-(E[1].x-e.x)*2,y:e.y-(E[1].y-e.y)*2},o={x:i.x+(i.x-E[E.length-2].x)*2,y:i.y+(i.y-E[E.length-2].y)*2},r=[n,...E,o],c=[];for(let h=0;h<r.length-3;h++){const l=r[h],d=r[h+1],g=r[h+2],v=r[h+3];if(h>0)for(let x=0;x<t;x++){const p=x/t,u=p*p,O=u*p,b=.5*(2*d.x+(-l.x+g.x)*s*p+(2*l.x-5*d.x+4*g.x-v.x)*s*u+(-l.x+3*d.x-3*g.x+v.x)*s*O),y=.5*(2*d.y+(-l.y+g.y)*s*p+(2*l.y-5*d.y+4*g.y-v.y)*s*u+(-l.y+3*d.y-3*g.y+v.y)*s*O);c.push({x:b,y})}}return c.push(E[E.length-1]),c}var St=(E=>(E.DRAG="DRAG",E.NONE="NONE",E.PATH="PATH",E.RIVER="RIVER",E.REMOVE="REMOVE",E))(St||{});class Gt{constructor(){W(this,"selectedTool","DRAG");W(this,"container");W(this,"currentPath",[]);W(this,"paths",[]);W(this,"isDrawing",!1);W(this,"onToolChange",null);W(this,"pathSize",5);W(this,"previewSize",96);W(this,"pathButton",null);W(this,"riverButton",null);this.container=document.createElement("div"),this.container.className="drawing-toolbar",this.initializeUI()}setToolChangeCallback(t){this.onToolChange=t}deselectAll(){this.selectedTool="NONE",this.updateUI()}selectDragTool(){this.selectedTool="DRAG",this.updateUI(),this.onToolChange&&this.onToolChange()}createPreviewCanvas(){const t=document.createElement("canvas");return t.width=this.previewSize,t.height=this.previewSize,t}drawRoutePreview(t,s){const e=t.getContext("2d");if(!e)return;e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";const i=this.previewSize,n=i*.45,o={x:i/2,y:i/2},r=[];for(let l=0;l<6;l++){const d=Math.PI/3*l;r.push({x:o.x+n*Math.cos(d),y:o.y+n*Math.sin(d)})}e.clearRect(0,0,i,i),e.beginPath(),e.moveTo(r[0].x,r[0].y);for(let l=1;l<r.length;l++)e.lineTo(r[l].x,r[l].y);e.closePath(),e.strokeStyle="#404040",e.lineWidth=1.5,e.stroke(),e.beginPath();const c=o.y-n*.6,h=o.y+n*.6;e.moveTo(o.x,c),e.lineTo(o.x,h),s?(e.strokeStyle="#4B9CD3",e.lineWidth=this.pathSize*1.5,e.lineCap="round",e.stroke(),e.beginPath(),e.moveTo(o.x,c),e.lineTo(o.x,h),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=this.pathSize*.8,e.stroke()):(e.strokeStyle="#8B4513",e.lineWidth=this.pathSize*1.5,e.lineCap="round",e.stroke(),e.beginPath(),e.moveTo(o.x,c),e.lineTo(o.x,h),e.strokeStyle="rgba(139, 69, 19, 0.3)",e.lineWidth=this.pathSize*.8,e.stroke())}updatePreviews(){if(this.pathButton){const t=this.createPreviewCanvas();for(this.drawRoutePreview(t,!1);this.pathButton.firstChild;)this.pathButton.removeChild(this.pathButton.firstChild);this.pathButton.appendChild(t)}if(this.riverButton){const t=this.createPreviewCanvas();for(this.drawRoutePreview(t,!0);this.riverButton.firstChild;)this.riverButton.removeChild(this.riverButton.firstChild);this.riverButton.appendChild(t)}}initializeUI(){const t=document.createElement("div");t.className="toolbar-section";const s=document.createElement("h2");s.textContent="Routes",t.appendChild(s);const e=document.createElement("div");e.className="size-control";const i=document.createElement("label");i.textContent="Size:",e.appendChild(i);const n=document.createElement("span");n.textContent=this.pathSize.toString(),n.className="size-value";const o=document.createElement("input");o.type="range",o.min="1",o.max="10",o.value=this.pathSize.toString(),o.className="size-slider",o.addEventListener("input",v=>{const x=parseInt(v.target.value);this.pathSize=x,n.textContent=x.toString(),this.updatePreviews()}),e.appendChild(o),e.appendChild(n),t.appendChild(e);const r=document.createElement("div");r.className="terrain-button-container";const c=document.createElement("button");c.className="terrain-button",c.title="Remove Route";const h=this.createPreviewCanvas(),l=new Image;l.onload=()=>{const v=h.getContext("2d");if(v){this.drawHexagonBackground(h);const x=this.previewSize,p=x*.45,u={x:x/2,y:x/2},O=[];for(let S=0;S<6;S++){const X=Math.PI/3*S;O.push({x:u.x+p*Math.cos(X),y:u.y+p*Math.sin(X)})}const b=Math.min(...O.map(S=>S.x)),y=Math.min(...O.map(S=>S.y)),F=Math.max(...O.map(S=>S.x)),Q=Math.max(...O.map(S=>S.y)),R=F-b,et=Q-y,T=Math.min(R/l.width,et/l.height),U=l.width*T,$=l.height*T;v.drawImage(l,u.x-U/2,u.y-$/2,U,$)}},l.onerror=()=>{l.src.startsWith("/src/")&&(l.src="./src/assets/noroute.png")},l.src="/src/assets/noroute.png",c.appendChild(h),c.addEventListener("click",()=>this.selectTool("REMOVE")),r.appendChild(c),this.pathButton=document.createElement("button"),this.pathButton.className="terrain-button",this.pathButton.title="Path";const d=this.createPreviewCanvas();this.drawRoutePreview(d,!1),this.pathButton.appendChild(d),this.pathButton.addEventListener("click",()=>this.selectTool("PATH")),r.appendChild(this.pathButton),this.riverButton=document.createElement("button"),this.riverButton.className="terrain-button",this.riverButton.title="River";const g=this.createPreviewCanvas();this.drawRoutePreview(g,!0),this.riverButton.appendChild(g),this.riverButton.addEventListener("click",()=>this.selectTool("RIVER")),r.appendChild(this.riverButton),t.appendChild(r),this.container.appendChild(t)}drawHexagonBackground(t){const s=t.getContext("2d");if(!s)return;const e=this.previewSize,i=e*.45,n={x:e/2,y:e/2},o=[];for(let r=0;r<6;r++){const c=Math.PI/3*r;o.push({x:n.x+i*Math.cos(c),y:n.y+i*Math.sin(c)})}s.clearRect(0,0,e,e),s.beginPath(),s.moveTo(o[0].x,o[0].y);for(let r=1;r<o.length;r++)s.lineTo(o[r].x,o[r].y);s.closePath(),s.strokeStyle="#404040",s.lineWidth=1.5,s.stroke()}selectTool(t){t!==this.selectedTool&&(this.selectedTool=t,this.updateUI(),this.onToolChange&&this.onToolChange())}updateUI(){this.container.querySelectorAll(".terrain-button").forEach(s=>{const e=s;e.classList.remove("selected"),(e.title==="Path"&&this.selectedTool==="PATH"||e.title==="River"&&this.selectedTool==="RIVER"||e.title==="Remove Route"&&this.selectedTool==="REMOVE")&&e.classList.add("selected")})}startPath(t){this.selectedTool!=="NONE"&&(this.isDrawing=!0,this.currentPath=[t])}updatePath(t){if(!this.isDrawing)return;const s=this.currentPath[this.currentPath.length-1];(!s||Math.hypot(s.x-t.x,s.y-t.y)>1)&&this.currentPath.push(t)}endPath(){if(!this.isDrawing||this.currentPath.length<2)return;const t=this.selectedTool==="RIVER",s={points:[...this.currentPath],type:this.selectedTool==="RIVER"?"RIVER":"PATH",width:this.pathSize,strokeStyle:t?"#4B9CD3":"#8B4513"};if(this.currentPath.length>=3){const e=Ht(this.currentPath,20,1);e[0]=this.currentPath[0],s.smoothPoints=e}this.paths.push(s),this.isDrawing=!1,this.currentPath=[]}getPaths(){return this.paths}getCurrentPath(){return this.currentPath}getCurrentTool(){return this.selectedTool}isDrawingMode(){return this.selectedTool==="PATH"||this.selectedTool==="RIVER"}isDragMode(){return this.selectedTool==="DRAG"}getPathSize(){return this.pathSize}getElement(){return this.container}setPaths(t){this.paths=t}}class Yt{constructor(t,s){W(this,"canvas");W(this,"ctx");W(this,"tiles",[]);W(this,"paths",[]);W(this,"currentPath",[]);W(this,"hoveredTile",null);W(this,"zoom",1);W(this,"minZoom",.5);W(this,"maxZoom",3);W(this,"panX",0);W(this,"panY",0);W(this,"drawingTools");W(this,"terrainTextures",new Map);W(this,"treeOverlayTextures",new Map);W(this,"onTextureLoadCallbacks",[]);W(this,"customTerrainImages",new Map);W(this,"showGridNumbers",!0);this.canvas=t,this.drawingTools=s;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D rendering context");this.ctx=e,this.centerMap(),this.loadTerrainTextures()}centerMap(){this.panX=this.canvas.width/2,this.panY=this.canvas.height/2,this.zoom=1}updateZoom(t,s,e){const i=this.zoom,n=t>0?1.1:1/1.1,o=Math.min(Math.max(i*n,this.minZoom),this.maxZoom);if(o!==i){const r=(s-this.panX)/i,c=(e-this.panY)/i;this.zoom=o,this.panX=s-r*o,this.panY=e-c*o,this.render()}}applyTransform(){this.ctx.save(),this.ctx.translate(this.panX,this.panY),this.ctx.scale(this.zoom,this.zoom)}setTiles(t){this.tiles=t,this.render()}addTextureLoadCallback(t){this.onTextureLoadCallbacks.push(t)}loadTerrainTextures(){const t={[a.GRASS]:"grass.png",[a.WATER]:"water.png",[a.FOREST]:"forest.png",[a.HILLS]:"hills.png",[a.MOUNTAIN]:"mountain.png",[a.IMPASSABLE]:"impassable.png",[a.CLOUD]:"cloud.png",[a.BOG]:"bog.png",[a.TOWN1]:"town1.png",[a.TOWN2]:"town2.png",[a.TOWN3]:"town3.png",[a.HARBOR]:"harbor.png",[a.SHIPS]:"ships.png",[a.LIGHTTOWER]:"lighttower.png",[a.TREE]:"tree.png",[a.MINE]:"mine.png"},s={forest:"foresttrees.png",bog:"bogtrees.png"},e=[],i=o=>`/src/assets/${o}`,n=o=>new Promise((r,c)=>{const h=new Image;h.onload=()=>r(h),h.onerror=()=>{o.startsWith("/src/")?h.src=`./src/assets/${o.split("/").pop()}`:c(new Error(`Failed to load image: ${o}`))},h.src=o});Object.entries(t).forEach(([o,r])=>{const c=n(i(r)).then(h=>{this.terrainTextures.set(o,h)}).catch(()=>{});e.push(c)}),Object.entries(s).forEach(([o,r])=>{const c=n(i(r)).then(h=>{this.treeOverlayTextures.set(o,h)}).catch(()=>{});e.push(c)}),Promise.all(e).then(()=>{this.onTextureLoadCallbacks.forEach(o=>o()),this.render()}).catch(()=>{this.onTextureLoadCallbacks.forEach(o=>o()),this.render()})}getTerrainColor(t){switch(t){case a.WATER:return"#4B9CD3";case a.GRASS:return"#90EE90";case a.FOREST:return"#228B22";case a.BOG:return"#006400";case a.HILLS:return"#D2B48C";case a.MOUNTAIN:return"#808080";case a.IMPASSABLE:return"#4A4A4A";case a.CLOUD:return"rgba(200, 200, 200, 0.5)";case a.TOWN1:return"#DEB887";case a.TOWN2:return"#8B4513";case a.TOWN3:return"#A0522D";case a.HARBOR:return"#5DADE2";case a.SHIPS:return"#4682B4";case a.LIGHTTOWER:return"#F5DEB3";case a.TREE:return"#2E8B57";case a.MINE:return"#696969";case a.CUSTOM:return"#FFFFFF";default:return"#FFFFFF"}}renderPaths(t=!1){if(this.paths.forEach(s=>{if(s.points.length<2)return;const e=s.type==="RIVER",i=t?s.width:s.width/this.zoom;if(this.ctx.save(),e){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(41, 98, 155, 0.3)",this.ctx.lineWidth=i*1.8,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(s.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#3178b9",this.ctx.lineWidth=i*1.4,this.drawPathWithPoints(s.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#4B9CD3",this.ctx.lineWidth=i,this.drawPathWithPoints(s.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.2)",this.ctx.lineWidth=i*.6;const n=s.points.map((o,r)=>({x:o.x+Math.sin(r*.3)*(i*.1),y:o.y+Math.cos(r*.3)*(i*.1)}));this.drawPathWithPoints(n),this.ctx.stroke();for(let o=0;o<3;o++){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=i*.1;const r=s.points.map((c,h)=>({x:c.x+Math.sin((h+o)*.5)*(i*.3),y:c.y+Math.cos((h+o)*.5)*(i*.3)}));this.drawPathWithPoints(r),this.ctx.stroke()}}else{this.ctx.beginPath(),this.ctx.strokeStyle="rgba(84, 48, 18, 0.2)",this.ctx.lineWidth=i*1.6,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(s.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.6)",this.ctx.lineWidth=i*1.2,this.drawPathWithPoints(s.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=i*.9,this.drawPathWithPoints(s.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(159, 99, 43, 0.5)",this.ctx.lineWidth=i*.4,this.drawPathWithPoints(s.points),this.ctx.stroke();const n=8;for(let o=0;o<n;o++){const r=o/n;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.2)",this.ctx.lineWidth=i*.1;const c=s.points.map((h,l)=>({x:h.x+Math.sin((l+r)*2)*(i*.2),y:h.y+Math.cos((l+r)*2)*(i*.2)}));this.drawPathWithPoints(c),this.ctx.stroke()}}this.ctx.restore()}),!t&&this.currentPath.length>=2){const s=this.drawingTools.getCurrentTool()===St.RIVER,e=this.drawingTools.getPathSize()/this.zoom;if(this.ctx.save(),s){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(41, 98, 155, 0.3)",this.ctx.lineWidth=e*1.8,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#3178b9",this.ctx.lineWidth=e*1.4,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#4B9CD3",this.ctx.lineWidth=e,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.2)",this.ctx.lineWidth=e*.6;const i=this.currentPath.map((n,o)=>({x:n.x+Math.sin(o*.3)*(e*.1),y:n.y+Math.cos(o*.3)*(e*.1)}));this.drawPathWithPoints(i),this.ctx.stroke();for(let n=0;n<3;n++){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=e*.1;const o=this.currentPath.map((r,c)=>({x:r.x+Math.sin((c+n)*.5)*(e*.3),y:r.y+Math.cos((c+n)*.5)*(e*.3)}));this.drawPathWithPoints(o),this.ctx.stroke()}}else{this.ctx.beginPath(),this.ctx.strokeStyle="rgba(84, 48, 18, 0.2)",this.ctx.lineWidth=e*1.6,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.6)",this.ctx.lineWidth=e*1.2,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=e*.9,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(159, 99, 43, 0.5)",this.ctx.lineWidth=e*.4,this.drawPathWithPoints(this.currentPath),this.ctx.stroke();const i=8;for(let n=0;n<i;n++){const o=n/i;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.2)",this.ctx.lineWidth=e*.1;const r=this.currentPath.map((c,h)=>({x:c.x+Math.sin((h+o)*2)*(e*.2),y:c.y+Math.cos((h+o)*2)*(e*.2)}));this.drawPathWithPoints(r),this.ctx.stroke()}}this.ctx.restore()}for(const s of this.tiles){let e=!1;for(const i of this.paths){for(const n of i.points)if(this.isPointInHexagon(n,s.vertices)){e=!0;break}if(e)break}if(!t&&!e&&this.currentPath.length>=2){for(const i of this.currentPath)if(this.isPointInHexagon(i,s.vertices)){e=!0;break}}if(e){const{vertices:i}=s;this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let n=1;n<i.length;n++)this.ctx.lineTo(i[n].x,i[n].y);this.ctx.closePath(),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1.5,this.ctx.stroke()}}}drawPathWithPoints(t){if(this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y),t.length>=3){const s=Ht(t,20,1);for(let e=1;e<s.length;e++)this.ctx.lineTo(s[e].x,s[e].y)}else this.ctx.lineTo(t[1].x,t[1].y)}setPaths(t){this.paths=t,this.render()}setCurrentPath(t){this.currentPath=t,t.length>0&&this.render()}render(){this.ctx.fillStyle="#1e1e1e",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.strokeStyle="#252525",this.ctx.lineWidth=1;const t=60,s=t*2,e=t*Math.sqrt(3),i=s*3/4,n=e,o=Math.ceil(this.canvas.width/i)+1,r=Math.ceil(this.canvas.height/n)+1;for(let c=-1;c<o;c++){const h=c%2*(n/2);for(let l=-1;l<r;l++){const d={x:c*i,y:l*n+h};this.ctx.beginPath();for(let g=0;g<6;g++){const v=Math.PI/3*g,x=d.x+t*Math.cos(v),p=d.y+t*Math.sin(v);g===0?this.ctx.moveTo(x,p):this.ctx.lineTo(x,p)}this.ctx.closePath(),this.ctx.stroke()}}this.ctx.strokeStyle="#191919",this.ctx.lineWidth=6,this.ctx.strokeRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.applyTransform();for(const c of this.tiles)c.terrain!==a.CUSTOM&&c.terrain!==a.WATER&&c.terrain!==a.CLOUD&&this.renderTileBase(c);this.renderPaths();for(const c of this.tiles)(c.terrain===a.WATER||c.terrain===a.CLOUD)&&this.renderTileBase(c);for(const c of this.tiles)c.specialTerrain&&!c.abovePaths&&!It.has(c.specialTerrain)&&this.renderSpecialTerrain(c);for(const c of this.tiles)c.treeOverlay&&!c.treeOverlay.abovePaths&&this.renderTreeOverlay(c);for(const c of this.tiles)c.specialTerrain&&c.abovePaths&&!It.has(c.specialTerrain)&&this.renderSpecialTerrain(c);for(const c of this.tiles)c.treeOverlay&&c.treeOverlay.abovePaths&&this.renderTreeOverlay(c);for(const c of this.tiles)c.specialTerrain&&It.has(c.specialTerrain)&&this.renderSpecialTerrain(c,!0),c.terrain===a.CUSTOM&&c.customTerrain&&this.renderCustomTerrain(c);this.renderGridNumbers(),this.ctx.restore()}renderCustomTerrain(t){if(!t.customTerrain)return;const{vertices:s}=t;this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(s[0].x,s[0].y);for(let e=1;e<s.length;e++)this.ctx.lineTo(s[e].x,s[e].y);if(this.ctx.closePath(),t.customTerrain.type==="color")this.ctx.fillStyle=t.customTerrain.value,this.ctx.fill();else if(t.customTerrain.type==="image"){let e=this.customTerrainImages.get(t.customTerrain.value);if(!e){e=new Image,e.src=t.customTerrain.value,this.customTerrainImages.set(t.customTerrain.value,e),e.onload=()=>{this.render()},this.ctx.restore();return}if(e.complete){const i=Math.min(...s.map(v=>v.x)),n=Math.min(...s.map(v=>v.y)),o=Math.max(...s.map(v=>v.x)),r=Math.max(...s.map(v=>v.y)),c=o-i,h=r-n,l=i+c/2,d=n+h/2,g=Math.min(c,h)/2*1.9;this.ctx.clip();try{const v=e.width/e.height;let x,p;v>1?(x=g*2,p=x/v):(p=g*2,x=p*v),this.ctx.drawImage(e,l-x/2,d-p/2,x,p)}catch(v){console.error("Error drawing custom image terrain:",v)}}}t===this.hoveredTile&&(this.ctx.fillStyle="rgba(100, 149, 237, 0.3)",this.ctx.fill()),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1.5,this.ctx.stroke(),this.ctx.restore()}renderTileBase(t){if(t.terrain===a.CUSTOM)return;const{vertices:s}=t;this.ctx.beginPath(),this.ctx.moveTo(s[0].x,s[0].y);for(let i=1;i<s.length;i++)this.ctx.lineTo(s[i].x,s[i].y);this.ctx.closePath();const e=this.terrainTextures.get(t.terrain);if(e&&e.complete){this.ctx.save(),this.ctx.clip();const i=Math.min(...s.map(g=>g.x)),n=Math.min(...s.map(g=>g.y)),o=Math.max(...s.map(g=>g.x)),r=Math.max(...s.map(g=>g.y)),c=o-i,h=r-n,l=c/e.width,d=h/e.height;this.ctx.translate(i,n),this.ctx.scale(l,d),this.ctx.drawImage(e,0,0),this.ctx.restore()}else this.ctx.fillStyle=this.getTerrainColor(t.terrain),this.ctx.fill();t===this.hoveredTile&&(this.ctx.fillStyle="rgba(100, 149, 237, 0.3)",this.ctx.fill()),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1.5,this.ctx.stroke()}renderTreeOverlay(t){const{vertices:s}=t;if(!t.treeOverlay)return;const e=this.treeOverlayTextures.get(t.treeOverlay.type);if(e&&e.complete){this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(s[0].x,s[0].y);for(let g=1;g<s.length;g++)this.ctx.lineTo(s[g].x,s[g].y);this.ctx.closePath(),this.ctx.clip();const i=Math.min(...s.map(g=>g.x)),n=Math.min(...s.map(g=>g.y)),o=Math.max(...s.map(g=>g.x)),r=Math.max(...s.map(g=>g.y)),c=o-i,h=r-n,l=c/e.width,d=h/e.height;this.ctx.translate(i,n),this.ctx.scale(l,d),this.ctx.drawImage(e,0,0),this.ctx.restore()}}renderSpecialTerrain(t,s=!1){if(!t.specialTerrain)return;const e=this.terrainTextures.get(t.specialTerrain);if(!e||!e.complete)return;this.ctx.save();const{vertices:i}=t;if(!s){this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let v=1;v<i.length;v++)this.ctx.lineTo(i[v].x,i[v].y);this.ctx.closePath(),this.ctx.clip()}const n=Math.min(...i.map(v=>v.x)),o=Math.min(...i.map(v=>v.y)),r=Math.max(...i.map(v=>v.x)),c=Math.max(...i.map(v=>v.y)),h=r-n,l=c-o,d=h/e.width,g=l/e.height;this.ctx.translate(n,o),this.ctx.scale(d,g),this.ctx.drawImage(e,0,0),this.ctx.restore(),this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let v=1;v<i.length;v++)this.ctx.lineTo(i[v].x,i[v].y);this.ctx.closePath(),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1.5,this.ctx.stroke()}screenToMapCoordinates(t,s){return{x:(t-this.panX)/this.zoom,y:(s-this.panY)/this.zoom}}getZoom(){return this.zoom}getPanX(){return this.panX}getPanY(){return this.panY}getTiles(){return this.tiles}setZoom(t){this.zoom=t}setPanPosition(t,s){this.panX=t,this.panY=s}pan(t,s){this.panX+=t,this.panY+=s,this.render()}setHoveredTile(t){this.hoveredTile!==t&&(this.hoveredTile=t,this.render())}getPaths(){return this.paths}getTerrainTexture(t){return this.terrainTextures.get(t)}setTileTerrain(t,s,e){if(s===a.NONE){t.terrain=a.NONE,t.specialTerrain=void 0,t.customTerrain=void 0,delete t.treeOverlay,this.render();return}if(s===a.CUSTOM){t.terrain=s,t.customTerrain=e||{type:"color",value:"#FFFFFF"},t.specialTerrain=void 0,delete t.treeOverlay,this.render();return}if(Dt.has(s)){t.specialTerrain=s,delete t.treeOverlay,this.render();return}t.terrain=s,t.customTerrain=void 0,t.specialTerrain?delete t.treeOverlay:s===a.FOREST?t.treeOverlay={type:"forest",abovePaths:t.abovePaths??!1}:s===a.BOG?t.treeOverlay={type:"bog",abovePaths:t.abovePaths??!1}:delete t.treeOverlay,this.render()}getTreeOverlayTexture(t){return this.treeOverlayTextures.get(t)}preloadCustomTerrainImage(t){return new Promise((s,e)=>{if(this.customTerrainImages.has(t)){s();return}const i=new Image;i.onload=()=>{this.customTerrainImages.set(t,i),s()},i.onerror=n=>{console.error("Failed to load custom terrain image:",n),e(new Error("Failed to load custom terrain image"))},i.src=t})}setShowGridNumbers(t){this.showGridNumbers=t}renderGridNumbers(){if(!this.showGridNumbers)return;this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.font="14px Arial",this.ctx.fillStyle="#808080",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=this.tiles.map(r=>r.coord),s=Math.min(...t.map(r=>r.q)),e=Math.max(...t.map(r=>r.q)),i=Math.min(...t.map(r=>r.r)),n=Math.max(...t.map(r=>r.r)),o=this.tiles.filter(r=>r.coord.r===n);if(o.length>0){const c=(Math.max(...o.map(h=>h.center.y))+50)*this.zoom+this.panY;for(let h=s;h<=e;h++){const l=o.find(d=>d.coord.q===h);if(l){this.hoveredTile&&this.hoveredTile.coord.q===h?this.ctx.fillStyle="#ffffff":this.ctx.fillStyle="#808080";const d=l.center.x*this.zoom+this.panX;this.ctx.fillText(String(h+1),d,c)}}}for(let r=i;r<=n;r++){const c=this.tiles.find(h=>h.coord.r===r&&h.coord.q===s);if(c){this.hoveredTile&&this.hoveredTile.coord.r===r?this.ctx.fillStyle="#ffffff":this.ctx.fillStyle="#808080";const h=(c.center.x-60)*this.zoom+this.panX,l=c.center.y*this.zoom+this.panY;this.ctx.fillText(String(r+1),h,l)}}this.ctx.restore()}renderToContext(t,s=!1,e){const i=this.ctx;try{this.ctx=t,s||(this.ctx.fillStyle="#1e1e1e",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)),s||this.applyTransform();for(const n of this.tiles)(!e||e.has(`${n.coord.q},${n.coord.r}`))&&n.terrain!==a.CUSTOM&&n.terrain!==a.WATER&&n.terrain!==a.CLOUD&&this.renderTileBase(n);this.renderPaths(s);for(const n of this.tiles)(!e||e.has(`${n.coord.q},${n.coord.r}`))&&(n.terrain===a.WATER||n.terrain===a.CLOUD)&&this.renderTileBase(n);for(const n of this.tiles)(!e||e.has(`${n.coord.q},${n.coord.r}`))&&n.specialTerrain&&!n.abovePaths&&!It.has(n.specialTerrain)&&this.renderSpecialTerrain(n);for(const n of this.tiles)(!e||e.has(`${n.coord.q},${n.coord.r}`))&&n.treeOverlay&&!n.treeOverlay.abovePaths&&this.renderTreeOverlay(n);for(const n of this.tiles)(!e||e.has(`${n.coord.q},${n.coord.r}`))&&n.specialTerrain&&n.abovePaths&&!It.has(n.specialTerrain)&&this.renderSpecialTerrain(n);for(const n of this.tiles)(!e||e.has(`${n.coord.q},${n.coord.r}`))&&n.treeOverlay&&n.treeOverlay.abovePaths&&this.renderTreeOverlay(n);for(const n of this.tiles)(!e||e.has(`${n.coord.q},${n.coord.r}`))&&(n.specialTerrain&&It.has(n.specialTerrain)&&this.renderSpecialTerrain(n,!0),n.terrain===a.CUSTOM&&n.customTerrain&&this.renderCustomTerrain(n));s||this.renderGridNumbers(),s||this.ctx.restore()}finally{this.ctx=i}}getHoveredTile(){return this.hoveredTile}isPointInHexagon(t,s){let e=!1;for(let i=0,n=s.length-1;i<s.length;n=i++){const o=s[i].x,r=s[i].y,c=s[n].x,h=s[n].y;r>t.y!=h>t.y&&t.x<(c-o)*(t.y-r)/(h-r)+o&&(e=!e)}return e}}class Xt{constructor(t){W(this,"selectedTerrain",a.NONE);W(this,"container");W(this,"onTerrainSelect",null);W(this,"drawMode","DRAW");W(this,"hasActiveSelection",!1);W(this,"drawAbovePaths",!1);W(this,"terrainPreviews",new Map);W(this,"previewSize",96);W(this,"mapRenderer");W(this,"customTerrainData",null);W(this,"customTerrainModal",null);W(this,"customPreviewCanvas");W(this,"onGridSizeChange",null);W(this,"cachedOverlays",new Map);this.mapRenderer=t,this.container=document.createElement("div"),this.container.className="toolbar-section",this.customPreviewCanvas=this.createPreviewCanvas(),this.drawHexagonPreview(this.customPreviewCanvas,"#ffffff"),this.loadTerrainTextures(),this.initializeUI(),this.preloadTreeOverlays(),this.mapRenderer.addTextureLoadCallback(()=>{this.updatePreviews()})}loadTerrainTextures(){const t=new Image;t.onload=()=>{const e=this.createPreviewCanvas();this.drawHexagonPreview(e,void 0,t),this.terrainPreviews.set(a.NONE,e);const i=this.findButtonForTerrain(a.NONE);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}},t.onerror=()=>{const e=this.createPreviewCanvas();this.drawHexagonPreview(e,"#FFFFFF"),this.terrainPreviews.set(a.NONE,e);const i=this.findButtonForTerrain(a.NONE);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}t.src.startsWith("/src/")&&(t.src="./src/assets/noterrain.png")},t.src="/src/assets/noterrain.png";const s={[a.GRASS]:"grass.png",[a.WATER]:"water.png",[a.FOREST]:"forest.png",[a.HILLS]:"hills.png",[a.MOUNTAIN]:"mountain.png",[a.IMPASSABLE]:"impassable.png",[a.CLOUD]:"cloud.png",[a.BOG]:"bog.png",[a.TOWN1]:"town1.png",[a.TOWN2]:"town2.png",[a.TOWN3]:"town3.png",[a.HARBOR]:"harbor.png",[a.SHIPS]:"ships.png",[a.LIGHTTOWER]:"lighttower.png",[a.TREE]:"tree.png",[a.MINE]:"mine.png"};Object.entries(s).forEach(([e,i])=>{const n=new Image;n.onload=()=>{const o=this.createPreviewCanvas();this.drawHexagonPreview(o,void 0,n),this.terrainPreviews.set(e,o);const r=this.findButtonForTerrain(e);if(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(o)}},n.onerror=()=>{const o=this.createPreviewCanvas();this.drawHexagonPreview(o,this.getTerrainColor(e)),this.terrainPreviews.set(e,o);const r=this.findButtonForTerrain(e);if(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(o)}n.src.startsWith("/src/")&&(n.src=`./src/assets/${i}`)},n.src=`/src/assets/${i}`})}updatePreviews(){[a.GRASS,a.WATER,a.HILLS,a.MOUNTAIN,a.IMPASSABLE,a.CLOUD].forEach(t=>{const s=this.mapRenderer.getTerrainTexture(t);if(s&&s.complete){const e=this.createPreviewCanvas();this.drawHexagonPreview(e,void 0,s);const i=this.findButtonForTerrain(t);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}this.terrainPreviews.set(t,e)}}),this.updateTerrainWithOverlay(a.FOREST,"forest"),this.updateTerrainWithOverlay(a.BOG,"bog")}preloadTreeOverlays(){const t=i=>{if(window.location.hostname.includes("github.io")){const o=window.location.pathname.split("/");return`/${o.length>1?o[1]:""}/src/assets/${i}`}else return`/src/assets/${i}`},s=new Image;s.onload=()=>{this.cachedOverlays.set("forest",s),this.updateTerrainWithOverlay(a.FOREST,"forest")},s.onerror=()=>{s.src.startsWith("/src/")&&(s.src="./src/assets/foresttrees.png")},s.src=t("foresttrees.png");const e=new Image;e.onload=()=>{this.cachedOverlays.set("bog",e),this.updateTerrainWithOverlay(a.BOG,"bog")},e.onerror=()=>{e.src.startsWith("/src/")&&(e.src="./src/assets/bogtrees.png")},e.src=t("bogtrees.png")}updateTerrainWithOverlay(t,s){const e=this.mapRenderer.getTerrainTexture(t);let i=this.cachedOverlays.get(s)||this.mapRenderer.getTreeOverlayTexture(s);if(e&&e.complete&&i&&i.complete){const n=this.createPreviewCanvas();this.drawHexagonPreview(n,void 0,e,i);const o=this.findButtonForTerrain(t);if(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(n)}this.terrainPreviews.set(t,n)}else if(e&&e.complete){const n=this.createPreviewCanvas();this.drawHexagonPreview(n,void 0,e);const o=this.findButtonForTerrain(t);o&&(o.firstChild||o.appendChild(n))}}findButtonForTerrain(t){const s=this.container.querySelectorAll(".terrain-button");for(const e of s){const i=e;if(i.title===this.getTerrainLabel(t))return i}return null}createPreviewCanvas(){const t=document.createElement("canvas");return t.width=this.previewSize,t.height=this.previewSize,t}drawHexagonPreview(t,s,e,i){const n=t.getContext("2d");if(!n)return;n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high";const o=this.previewSize,r=o*.45,c={x:o/2,y:o/2},h=[];for(let l=0;l<6;l++){const d=Math.PI/3*l;h.push({x:c.x+r*Math.cos(d),y:c.y+r*Math.sin(d)})}n.beginPath(),n.moveTo(h[0].x,h[0].y);for(let l=1;l<h.length;l++)n.lineTo(h[l].x,h[l].y);if(n.closePath(),e){n.save(),n.clip();const l=Math.min(...h.map(y=>y.x)),d=Math.min(...h.map(y=>y.y)),g=Math.max(...h.map(y=>y.x)),v=Math.max(...h.map(y=>y.y)),x=g-l,p=v-d,u=Math.min(x/e.width,p/e.height),O=e.width*u,b=e.height*u;if(n.drawImage(e,c.x-O/2,c.y-b/2,O,b),i){const y=Math.min(x/i.width,p/i.height),F=i.width*y,Q=i.height*y;n.drawImage(i,c.x-F/2,c.y-Q/2,F,Q)}n.restore()}else s&&(n.fillStyle=s,n.fill());n.strokeStyle="#404040",n.lineWidth=1.5,n.stroke()}getElement(){return this.container}setTerrainSelectCallback(t){this.onTerrainSelect=t}deselectAll(){this.hasActiveSelection=!1,this.container.querySelectorAll(".terrain-button").forEach(s=>{s.classList.remove("selected")})}setGridSizeChangeCallback(t){this.onGridSizeChange=t}initializeUI(){const t=document.createElement("h2");t.textContent="Grid Size",this.container.appendChild(t);const s=document.createElement("div");s.className="toolbar-section";const e=document.createElement("div");e.style.display="grid",e.style.gridTemplateRows="auto auto auto",e.style.gap="4px",e.style.justifyContent="center";const i=X=>{const k=document.createElement("button");return k.style.width="24px",k.style.height="24px",k.style.padding="0",k.style.display="flex",k.style.alignItems="center",k.style.justifyContent="center",k.style.background="#2d2d2d",k.style.border="1px solid #404040",k.style.color=X.includes("+")?"#4CAF50":"#f44336",k.style.cursor="pointer",k.style.borderRadius="4px",k.style.fontSize="16px",k.style.lineHeight="1",k.style.transition="background-color 0.2s ease",k.addEventListener("mouseover",()=>{k.style.background="#3d3d3d"}),k.addEventListener("mouseout",()=>{k.style.background="#2d2d2d"}),k.innerHTML=X.includes("+")?"+":"-",k.addEventListener("click",()=>{this.onGridSizeChange&&this.onGridSizeChange(X)}),k},n=document.createElement("div");n.className="grid-size-info",n.style.color="#e0e0e0",n.style.fontSize="14px",n.style.margin="0 4px",n.style.textAlign="center",n.textContent="35x20";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="center",o.style.gap="4px";const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="4px";const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="center",c.style.gap="4px",o.appendChild(i("row-top")),o.appendChild(i("row+top")),r.appendChild(i("col-left")),r.appendChild(i("col+left")),r.appendChild(n),r.appendChild(i("col-right")),r.appendChild(i("col+right")),c.appendChild(i("row-bottom")),c.appendChild(i("row+bottom")),e.appendChild(o),e.appendChild(r),e.appendChild(c),s.appendChild(e),this.container.appendChild(s);const h=document.createElement("h2");h.textContent="Terrain",this.container.appendChild(h);const l=document.createElement("div");l.className="mode-selector";const d=document.createElement("button");d.textContent="Draw",d.className="mode-button selected",d.addEventListener("click",()=>this.setDrawMode("DRAW",d,g));const g=document.createElement("button");g.textContent="Fill",g.className="mode-button",g.addEventListener("click",()=>this.setDrawMode("FILL",d,g)),l.appendChild(d),l.appendChild(g),this.container.appendChild(l);const v=document.createElement("div");v.className="layer-control";const x=document.createElement("label");x.textContent="Above Routes",x.htmlFor="layer-toggle";const p=document.createElement("div");p.className="toggle-switch";const u=document.createElement("input");u.type="checkbox",u.id="layer-toggle",u.checked=this.drawAbovePaths;const O=document.createElement("span");O.className="toggle-slider";const b=()=>{this.drawAbovePaths=u.checked};u.addEventListener("change",b),p.addEventListener("click",X=>{X.preventDefault(),u.checked=!u.checked,b()}),x.addEventListener("click",X=>{X.preventDefault(),u.checked=!u.checked,b()}),p.appendChild(u),p.appendChild(O),v.appendChild(x),v.appendChild(p),this.container.appendChild(v);const y=[{type:a.NONE,tooltip:"Remove Terrain"},{type:a.WATER,tooltip:"Water"},{type:a.GRASS,tooltip:"Grass"},{type:a.FOREST,tooltip:"Forest"},{type:a.BOG,tooltip:"Bog"},{type:a.HILLS,tooltip:"Hills"},{type:a.MOUNTAIN,tooltip:"Mountain"},{type:a.IMPASSABLE,tooltip:"Impassable"},{type:a.CLOUD,tooltip:"Cloud"}],F=[{type:a.TOWN1,tooltip:"Town 1"},{type:a.TOWN2,tooltip:"Town 2"},{type:a.TOWN3,tooltip:"Town 3"},{type:a.HARBOR,tooltip:"Harbor"},{type:a.SHIPS,tooltip:"Ships"},{type:a.LIGHTTOWER,tooltip:"Lighttower"},{type:a.TREE,tooltip:"Tree"},{type:a.MINE,tooltip:"Cave / Mine"}],Q=document.createElement("div");Q.className="terrain-button-container",this.container.appendChild(Q);const R=document.createElement("button");R.className="terrain-button",R.title="Remove Terrain";const et=this.terrainPreviews.get(a.NONE);et&&R.appendChild(et),R.addEventListener("click",()=>this.selectTerrain(a.NONE)),Q.appendChild(R);const T=document.createElement("button");T.className="terrain-button custom-terrain",T.title="Custom Terrain",T.appendChild(this.customPreviewCanvas),T.addEventListener("click",()=>{this.selectTerrain(a.CUSTOM)}),Q.appendChild(T);const U=document.createElement("button");U.className="custom-terrain-edit",U.textContent="Edit Custom",U.title="Edit Custom Terrain",U.addEventListener("click",X=>{X.stopPropagation(),this.showCustomTerrainModal()}),Q.appendChild(U);const $=document.createElement("div");$.className="storage-divider",$.style.gridColumn="1 / -1",Q.appendChild($),y.slice(1).forEach(X=>{const k=document.createElement("button");k.className="terrain-button",k.title=X.tooltip;const gt=this.terrainPreviews.get(X.type);gt&&k.appendChild(gt),k.addEventListener("click",()=>this.selectTerrain(X.type)),Q.appendChild(k)});const S=document.createElement("div");S.className="storage-divider",S.style.gridColumn="1 / -1",Q.appendChild(S),F.forEach(X=>{const k=document.createElement("button");k.className="terrain-button",k.title=X.tooltip;const gt=this.terrainPreviews.get(X.type);gt&&k.appendChild(gt),k.addEventListener("click",()=>this.selectTerrain(X.type)),Q.appendChild(k)})}selectTerrain(t){(t!==this.selectedTerrain||!this.hasActiveSelection)&&(this.selectedTerrain=t,this.hasActiveSelection=!0,this.onTerrainSelect&&this.onTerrainSelect(),this.updateUI())}updateUI(){this.container.querySelectorAll(".terrain-button").forEach(s=>{const e=s;s.classList.toggle("selected",this.hasActiveSelection&&e.title===this.getTerrainLabel(this.selectedTerrain))})}getSelectedTerrain(){return this.selectedTerrain}getCustomTerrainData(){return this.selectedTerrain===a.CUSTOM?this.customTerrainData:null}isTerrainSelected(){return this.hasActiveSelection}getTerrainLabel(t){return{[a.NONE]:"Remove Terrain",[a.WATER]:"Water",[a.GRASS]:"Grass",[a.FOREST]:"Forest",[a.BOG]:"Bog",[a.HILLS]:"Hills",[a.MOUNTAIN]:"Mountain",[a.IMPASSABLE]:"Impassable",[a.CLOUD]:"Cloud",[a.TOWN1]:"Town 1",[a.TOWN2]:"Town 2",[a.TOWN3]:"Town 3",[a.HARBOR]:"Harbor",[a.SHIPS]:"Ships",[a.LIGHTTOWER]:"Lighttower",[a.TREE]:"Tree",[a.MINE]:"Cave / Mine",[a.CUSTOM]:"Custom Terrain"}[t]||t}setDrawMode(t,s,e){this.drawMode=t,s.classList.toggle("selected",t==="DRAW"),e.classList.toggle("selected",t==="FILL")}getDrawMode(){return this.drawMode}isDrawAbovePaths(){return this.drawAbovePaths}getTerrainColor(t){switch(t){case a.WATER:return"#4B9CD3";case a.GRASS:return"#90EE90";case a.FOREST:return"#228B22";case a.BOG:return"#006400";case a.HILLS:return"#D2B48C";case a.MOUNTAIN:return"#808080";case a.IMPASSABLE:return"#4A4A4A";case a.CLOUD:return"rgba(200, 200, 200, 0.5)";case a.TOWN1:return"#DEB887";case a.TOWN2:return"#8B4513";case a.TOWN3:return"#A0522D";case a.HARBOR:return"#5DADE2";case a.SHIPS:return"#4682B4";case a.LIGHTTOWER:return"#F5DEB3";case a.TREE:return"#2E8B57";case a.MINE:return"#696969";default:return"#FFFFFF"}}showCustomTerrainModal(){var mt;this.customTerrainModal&&(document.body.removeChild(this.customTerrainModal),this.customTerrainModal=null);const t=document.createElement("div");t.className="modal-backdrop",document.body.appendChild(t);const s=document.createElement("div");s.className="custom-terrain-modal";const e=document.createElement("button");e.className="modal-close-button",e.innerHTML="√ó",s.appendChild(e);const i=document.createElement("h3");i.textContent="Custom Terrain",s.appendChild(i);const n=document.createElement("div");n.className="custom-terrain-tabs";const o=document.createElement("button");o.className="custom-terrain-tab active",o.textContent="Image";const r=document.createElement("button");r.className="custom-terrain-tab",r.textContent="Color",n.appendChild(o),n.appendChild(r),s.appendChild(n);const c=document.createElement("div");c.className="custom-terrain-content";const h=document.createElement("div");h.className="color-picker-section",h.style.display="none";const l=document.createElement("div");l.className="color-picker-container";const d=document.createElement("input");d.type="color",d.className="color-picker-input",d.value=((mt=this.customTerrainData)==null?void 0:mt.type)==="color"?this.customTerrainData.value:"#ffffff";const g=document.createElement("canvas");g.className="color-hex-preview",g.width=200,g.height=200;const v=()=>{const w=g.getContext("2d");if(!w)return;w.clearRect(0,0,g.width,g.height);const q=g.width/2,G=g.height/2,rt=Math.min(g.width,g.height)*.45;w.beginPath();for(let nt=0;nt<6;nt++){const it=Math.PI/3*nt,V=q+rt*Math.cos(it),j=G+rt*Math.sin(it);nt===0?w.moveTo(V,j):w.lineTo(V,j)}w.closePath(),w.fillStyle=d.value,w.fill(),w.strokeStyle="#404040",w.lineWidth=2,w.stroke()};d.addEventListener("input",v),v();const x=document.createElement("div");x.className="color-picker-tooltip",x.textContent="Click on the hexagon to change color",l.appendChild(g),l.appendChild(x),l.appendChild(d),h.appendChild(l);const p=document.createElement("div");p.className="image-upload-section",p.style.display="flex";const u=document.createElement("div");u.className="image-upload-area",u.innerHTML=`
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Click or drag an image here</div>
            <input type="file" accept="image/*" style="display: none;">
        `;const O=document.createElement("div");O.className="image-preview-container",O.style.display="none";const b=document.createElement("img");b.className="preview-image";const y=document.createElement("canvas");y.className="preview-hexagon-overlay",y.width=O.clientWidth||400,y.height=O.clientHeight||240,O.appendChild(b),O.appendChild(y);const F=document.createElement("div");F.className="image-controls",F.style.display="none";const Q=document.createElement("button");Q.className="image-control-button",Q.textContent="Zoom In";const R=document.createElement("button");R.className="image-control-button",R.textContent="Zoom Out";const et=document.createElement("button");et.className="image-control-button",et.textContent="Reset",F.appendChild(Q),F.appendChild(R),F.appendChild(et);let T={x:0,y:0,scale:1};u.addEventListener("click",()=>{U==null||U.click()}),u.addEventListener("dragover",w=>{w.preventDefault(),w.stopPropagation(),u.classList.add("drag-over")}),u.addEventListener("dragleave",w=>{w.preventDefault(),w.stopPropagation(),u.classList.remove("drag-over")}),u.addEventListener("drop",w=>{var q;if(w.preventDefault(),w.stopPropagation(),u.classList.remove("drag-over"),(q=w.dataTransfer)!=null&&q.files&&w.dataTransfer.files.length>0){const G=w.dataTransfer.files[0];if(G.type.startsWith("image/")){const rt=new FileReader;rt.onload=nt=>{var it;(it=nt.target)!=null&&it.result&&(b.src=nt.target.result,b.onload=()=>{T={x:0,y:0,scale:1},xt()},O.style.display="block",F.style.display="flex")},rt.readAsDataURL(G)}}});const U=u.querySelector("input");U&&U.addEventListener("change",w=>{const q=w.target;if(q.files&&q.files[0]){const G=new FileReader;G.onload=rt=>{var nt;(nt=rt.target)!=null&&nt.result&&(b.src=rt.target.result,b.onload=()=>{T={x:0,y:0,scale:1},xt()},O.style.display="block",F.style.display="flex")},G.readAsDataURL(q.files[0])}}),p.appendChild(u),p.appendChild(O),p.appendChild(F),c.appendChild(h),c.appendChild(p),s.appendChild(c);const $=document.createElement("div");$.className="modal-buttons";const S=document.createElement("button");S.className="modal-button primary",S.textContent="Apply";const X=document.createElement("button");X.className="modal-button secondary",X.textContent="Cancel",$.appendChild(S),$.appendChild(X),s.appendChild($),o.addEventListener("click",()=>{o.classList.add("active"),r.classList.remove("active"),p.style.display="flex",h.style.display="none"}),r.addEventListener("click",()=>{r.classList.add("active"),o.classList.remove("active"),h.style.display="flex",p.style.display="none"});let k=!1,gt=0,bt=0;O.addEventListener("mousedown",w=>{k=!0,gt=w.clientX-T.x,bt=w.clientY-T.y,O.style.cursor="grabbing"}),document.addEventListener("mousemove",w=>{k&&(T.x=w.clientX-gt,T.y=w.clientY-bt,xt())}),document.addEventListener("mouseup",()=>{k=!1,O.style.cursor="grab"}),Q.addEventListener("click",()=>{T.scale*=1.1,xt()}),R.addEventListener("click",()=>{T.scale*=.9,xt()}),et.addEventListener("click",()=>{T={x:0,y:0,scale:1},xt()});function xt(){const w=y.getContext("2d");if(!w)return;const q=O.getBoundingClientRect();(y.width!==q.width||y.height!==q.height)&&(y.width=q.width,y.height=q.height),w.clearRect(0,0,y.width,y.height);const G=y.width/2,rt=y.height/2,nt=Math.min(y.width,y.height)*.45,it=document.createElement("canvas");it.width=y.width,it.height=y.height;const V=it.getContext("2d");if(V){V.beginPath();for(let j=0;j<6;j++){const ht=Math.PI/3*j,dt=G+nt*Math.cos(ht),ct=rt+nt*Math.sin(ht);j===0?V.moveTo(dt,ct):V.lineTo(dt,ct)}if(V.closePath(),V.save(),V.clip(),b.complete){const j=T.scale,ht=T.x,dt=T.y,ct=b.naturalWidth/b.naturalHeight;let ft,at;const yt=nt*1.6;ct>1?(ft=yt*2,at=ft/ct):(at=yt*2,ft=at*ct),V.translate(G,rt),V.scale(j,j),V.translate(ht/j,dt/j),V.drawImage(b,-ft/2,-at/2,ft,at),V.restore()}w.drawImage(it,0,0),w.beginPath();for(let j=0;j<6;j++){const ht=Math.PI/3*j,dt=G+nt*Math.cos(ht),ct=rt+nt*Math.sin(ht);j===0?w.moveTo(dt,ct):w.lineTo(dt,ct)}w.closePath(),w.strokeStyle="rgba(255, 255, 255, 0.8)",w.lineWidth=2,w.stroke()}}const pt=()=>{document.body.removeChild(t),document.body.removeChild(s),this.customTerrainModal=null};X.addEventListener("click",pt),e.addEventListener("click",pt),t.addEventListener("click",w=>{w.target===t&&pt()}),O.addEventListener("wheel",w=>{w.preventDefault();const q=w.deltaY>0?.9:1.1;T.scale*=q,xt()}),S.addEventListener("click",()=>{if(r.classList.contains("active"))this.customTerrainData={type:"color",value:d.value};else if(b.src){const w=document.createElement("canvas"),q=O.getBoundingClientRect();w.width=q.width,w.height=q.height;const G=w.getContext("2d");if(!G)return;const rt=w.width/2,nt=w.height/2,it=Math.min(w.width,w.height)*.45;G.beginPath();for(let ct=0;ct<6;ct++){const ft=Math.PI/3*ct,at=rt+it*Math.cos(ft),yt=nt+it*Math.sin(ft);ct===0?G.moveTo(at,yt):G.lineTo(at,yt)}G.closePath(),G.clip();const V=b.naturalWidth/b.naturalHeight;let j,ht;const dt=it*1.6;V>1?(j=dt*2,ht=j/V):(ht=dt*2,j=ht*V),G.translate(rt,nt),G.scale(T.scale,T.scale),G.translate(T.x/T.scale,T.y/T.scale),G.drawImage(b,-j/2,-ht/2,j,ht),this.customTerrainData={type:"image",value:w.toDataURL(),imagePosition:{x:0,y:0,scale:1}}}this.updateCustomPreview(),pt(),this.selectedTerrain=a.CUSTOM,this.hasActiveSelection=!0,this.updateUI(),this.onTerrainSelect&&this.onTerrainSelect()}),document.body.appendChild(s),this.customTerrainModal=s}updateCustomPreview(){if(!this.customTerrainData)return;const t=this.createPreviewCanvas(),s=t.getContext("2d");if(!s)return;s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";const e=t.width/2,i=t.height/2,n=t.width*.45;s.beginPath();for(let r=0;r<6;r++){const c=Math.PI/3*r,h=e+n*Math.cos(c),l=i+n*Math.sin(c);r===0?s.moveTo(h,l):s.lineTo(h,l)}if(s.closePath(),this.customTerrainData.type==="color")s.fillStyle=this.customTerrainData.value,s.fill();else if(this.customTerrainData.type==="image"){s.save(),s.clip();const r=new Image;r.onload=()=>{try{const c=r.width/r.height;let h,l;const d=n*1.6;c>1?(h=d*2,l=h/c):(l=d*2,h=l*c),s.drawImage(r,e-h/2,i-l/2,h,l),s.restore(),s.strokeStyle="#404040",s.lineWidth=1.5,s.stroke();const g=this.findButtonForTerrain(a.CUSTOM);if(g){for(;g.firstChild;)g.removeChild(g.firstChild);g.appendChild(t)}this.terrainPreviews.set(a.CUSTOM,t),this.customPreviewCanvas=t}catch(c){console.error("Error drawing custom image preview:",c),s.restore()}},r.src=this.customTerrainData.value;return}s.strokeStyle="#404040",s.lineWidth=1.5,s.stroke();const o=this.findButtonForTerrain(a.CUSTOM);if(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(t)}this.terrainPreviews.set(a.CUSTOM,t),this.customPreviewCanvas=t}updateGridDimensions(t,s){const e=this.container.querySelector(".grid-size-info");e&&(e.textContent=`${t}x${s}`)}}const Bt={MAJOR:1,MINOR:0},qt="RQM2";class jt{constructor(t){W(this,"renderer");this.renderer=t}createExportCanvas(){let t=1/0,s=-1/0,e=1/0,i=-1/0;const n=new Set;if(this.renderer.getTiles().forEach(b=>{(b.terrain!==a.NONE||b.specialTerrain!==void 0)&&n.add(`${b.coord.q},${b.coord.r}`)}),this.renderer.getPaths().forEach(b=>{b.points.forEach(y=>{const F=this.renderer.getTiles().find(Q=>{const R=Q.vertices;let et=!1;for(let T=0,U=R.length-1;T<R.length;U=T++){const $=R[T].x,S=R[T].y,X=R[U].x,k=R[U].y;S>y.y!=k>y.y&&y.x<(X-$)*(y.y-S)/(k-S)+$&&(et=!et)}return et});F&&n.add(`${F.coord.q},${F.coord.r}`)})}),n.forEach(b=>{const[y,F]=b.split(",").map(Number);t=Math.min(t,y),s=Math.max(s,y),e=Math.min(e,F),i=Math.max(i,F)}),t===1/0||n.size===0)throw new Error("No content to export!");this.renderer.getTiles().forEach(b=>{b.coord.q>=t&&b.coord.q<=s&&b.coord.r>=e&&b.coord.r<=i&&n.add(`${b.coord.q},${b.coord.r}`)});let r=1/0,c=1/0,h=-1/0,l=-1/0;this.renderer.getTiles().forEach(b=>{n.has(`${b.coord.q},${b.coord.r}`)&&b.vertices.forEach(y=>{r=Math.min(r,y.x),c=Math.min(c,y.y),h=Math.max(h,y.x),l=Math.max(l,y.y)})});const d=1;r-=d,c-=d,h+=d,l+=d;const g=document.createElement("canvas"),v=4;g.width=(h-r)*v,g.height=(l-c)*v;const x=g.getContext("2d",{alpha:!0});if(!x)throw new Error("Failed to get export canvas context");x.imageSmoothingEnabled=!0,x.imageSmoothingQuality="high",x.clearRect(0,0,g.width,g.height);const p=this.renderer.getZoom(),u=this.renderer.getPanX(),O=this.renderer.getPanY();try{x.scale(v,v),x.translate(-r,-c),this.renderer.setZoom(1),this.renderer.setPanPosition(0,0),this.renderer.renderToContext(x,!0,n)}finally{this.renderer.setZoom(p),this.renderer.setPanPosition(u,O)}return g}createExportButtons(){const t=document.createElement("div");t.className="export-buttons-container";const s=document.createElement("h2");s.textContent="Map Data",t.appendChild(s);const e=document.createElement("div");e.className="button-group storage-buttons";const i=document.createElement("div");i.className="export-buttons-row storage-buttons-row";const n=document.createElement("button");n.className="export-button png-export-button",n.textContent="Save PNG",n.addEventListener("click",()=>this.exportToPNG()),i.appendChild(n);const o=document.createElement("button");o.className="export-button dat-export-button",o.textContent="Save DAT",o.addEventListener("click",()=>this.saveToBinary()),i.appendChild(o);const r=document.createElement("button");r.className="export-button",r.textContent="Load DAT",r.addEventListener("click",()=>this.loadFromBinary()),i.appendChild(r),e.appendChild(i);const c=document.createElement("div");c.className="storage-divider";const h=document.createElement("div");h.className="export-buttons-row storage-buttons-row";const l=document.createElement("button");return l.className="export-button reset-button",l.textContent="Reset Map",l.addEventListener("click",()=>this.showResetConfirmation()),h.appendChild(l),e.appendChild(c),e.appendChild(h),t.appendChild(e),t}showExportPreview(t){const s=document.createElement("div");s.className="modal-backdrop",document.body.appendChild(s);const e=document.createElement("div");e.className="export-preview-modal";const i=document.createElement("button");i.className="modal-close-button",i.innerHTML="√ó",e.appendChild(i);const n=document.createElement("h3");n.textContent="Preview",e.appendChild(n);const o=document.createElement("div");o.className="export-preview-container";const r=document.createElement("canvas"),c=800,h=600,l=c/t.width,d=h/t.height,g=Math.min(l,d,1);r.width=t.width*g,r.height=t.height*g;const v=r.getContext("2d");v&&(v.imageSmoothingEnabled=!0,v.imageSmoothingQuality="high",v.drawImage(t,0,0,r.width,r.height)),o.appendChild(r),e.appendChild(o);const x=document.createElement("div");x.className="export-controls-container";const p=document.createElement("div");p.className="compass-control";const u=document.createElement("label");u.textContent="Add Compass",u.htmlFor="compass-toggle",u.style.cursor="pointer";const O=document.createElement("div");O.className="toggle-switch",O.style.cursor="pointer";const b=document.createElement("input");b.type="checkbox",b.id="compass-toggle";const y=document.createElement("span");y.className="toggle-slider",O.appendChild(b),O.appendChild(y);const F=document.createElement("div");F.className="compass-size-control",F.style.display="none";const Q=document.createElement("label");Q.textContent="Change Size",Q.style.marginLeft="24px",Q.style.marginRight="8px";const R=document.createElement("input");R.type="range",R.min="5",R.max="50",R.value="25",R.className="size-slider",R.style.width="100px",F.appendChild(Q),F.appendChild(R);const et=document.createElement("div");et.className="compass-tooltip",et.textContent="Click and drag to move the compass";const T=document.createElement("div");T.className="timer";const U=document.createElementNS("http://www.w3.org/2000/svg","svg");U.setAttribute("class","timer-circle"),U.setAttribute("viewBox","0 0 24 24");const $=document.createElementNS("http://www.w3.org/2000/svg","circle");$.setAttribute("cx","12"),$.setAttribute("cy","12"),$.setAttribute("r","10");const S=document.createElementNS("http://www.w3.org/2000/svg","circle");S.setAttribute("class","progress"),S.setAttribute("cx","12"),S.setAttribute("cy","12"),S.setAttribute("r","10"),U.appendChild($),U.appendChild(S);const X=document.createElement("div");X.className="timer-text",T.appendChild(U),T.appendChild(X);const k=document.createElement("button");k.className="close-tooltip",k.innerHTML="√ó",k.addEventListener("click",D=>{D.stopPropagation(),gt()}),et.appendChild(T),et.appendChild(k);function gt(){et.parentNode&&et.parentNode.removeChild(et)}function bt(D,Z){const J=2*Math.PI*10,ut=J-D/Z*J;S.style.strokeDashoffset=`${ut}`,X.textContent=`${D}`}function xt(D){let Z=D;T.style.display="flex",bt(Z,D);const J=setInterval(()=>{Z--,bt(Z,D),Z<=0&&(clearInterval(J),gt())},1e3);return J}[u,O,y].forEach(D=>{D.addEventListener("click",Z=>{Z.stopPropagation(),b.checked=!b.checked,b.dispatchEvent(new Event("change"))})}),p.appendChild(u),p.appendChild(O),p.appendChild(F);const pt=document.createElement("div");pt.className="export-dimensions-info",pt.textContent=`Image dimensions: ${t.width}√ó${t.height} pixels | Calculating size...`,t.toBlob(D=>{if(D){const Z=D.size;let J;Z>1048576?J=(Z/1048576).toFixed(2)+" MB":Z>1024?J=(Z/1024).toFixed(1)+" KB":J=Z+" bytes",pt.textContent=`Image dimensions: ${t.width}√ó${t.height} pixels | Estimated size: ${J}`}else pt.textContent=`Image dimensions: ${t.width}√ó${t.height} pixels`},"image/png"),x.appendChild(p),x.appendChild(pt),e.appendChild(x);const mt=new Image;mt.src="./src/assets/compass.png";let w=0,q=0,G=!1,rt=0,nt=0;mt.onload=()=>{b.disabled=!1},mt.onerror=()=>{mt.src="/src/assets/compass.png"};let it=!1,V=null;b.addEventListener("change",()=>{if(it=b.checked,F.style.display=it?"flex":"none",r.classList.toggle("compass-active",it),it){if(w===0&&q===0){const D=Math.min(r.width,r.height)*(parseInt(R.value)/100);w=r.width-D-r.width*.2,q=r.height*.2}o.appendChild(et),et.classList.add("visible"),V&&clearInterval(V),V=xt(5)}else gt(),V&&(clearInterval(V),V=null);dt(),ht()});let j=null;R.addEventListener("input",()=>{dt(),j!==null&&clearTimeout(j),j=window.setTimeout(()=>{ht(),j=null},300)}),R.addEventListener("change",()=>{j!==null&&(clearTimeout(j),j=null),ht()});function ht(){const D=document.createElement("canvas");D.width=t.width,D.height=t.height;const Z=D.getContext("2d");if(Z){if(Z.drawImage(t,0,0),it&&mt.complete){const J=t.width/r.width,ut=Math.min(D.width,D.height)*(parseInt(R.value)/100);Z.drawImage(mt,w*J,q*J,ut,ut)}D.toBlob(J=>{if(J){const ut=J.size;let Tt;ut>1048576?Tt=(ut/1048576).toFixed(2)+" MB":ut>1024?Tt=(ut/1024).toFixed(1)+" KB":Tt=ut+" bytes",pt.textContent=`Image dimensions: ${t.width}√ó${t.height} pixels | Estimated size: ${Tt}`}},"image/png")}}pt.textContent=`Image dimensions: ${t.width}√ó${t.height} pixels | Calculating size...`,ht(),r.addEventListener("mousedown",D=>{if(!it)return;const Z=r.getBoundingClientRect(),J=D.clientX-Z.left,ut=D.clientY-Z.top,Tt=Math.min(r.width,r.height)*(parseInt(R.value)/100);J>=w&&J<=w+Tt&&ut>=q&&ut<=q+Tt&&(G=!0,rt=J-w,nt=ut-q,r.style.cursor="grabbing")}),r.addEventListener("mousemove",D=>{if(!G)return;const Z=r.getBoundingClientRect(),J=D.clientX-Z.left,ut=D.clientY-Z.top;w=J-rt,q=ut-nt;const Tt=Math.min(r.width,r.height)*(parseInt(R.value)/100);w=Math.max(0,Math.min(r.width-Tt,w)),q=Math.max(0,Math.min(r.height-Tt,q)),dt()}),r.addEventListener("mouseup",()=>{G=!1,r.style.cursor=it?"grab":"default"}),r.addEventListener("mouseleave",()=>{G=!1,r.style.cursor=it?"grab":"default"});function dt(){const D=r.getContext("2d");if(D&&(D.clearRect(0,0,r.width,r.height),D.drawImage(t,0,0,r.width,r.height),it&&mt.complete)){const Z=Math.min(r.width,r.height)*(parseInt(R.value)/100);D.drawImage(mt,w,q,Z,Z)}}const ct=document.createElement("div");ct.className="modal-buttons";const ft=document.createElement("button");ft.className="modal-button primary",ft.textContent="Save PNG";const at=document.createElement("button");at.className="modal-button secondary",at.textContent="Cancel",ct.appendChild(ft),ct.appendChild(at),e.appendChild(ct);const yt=()=>{document.body.removeChild(s),document.body.removeChild(e)};at.addEventListener("click",yt),i.addEventListener("click",yt),s.addEventListener("click",D=>{D.target===s&&yt()}),ft.addEventListener("click",()=>{yt();const D=document.createElement("canvas");D.width=t.width,D.height=t.height;const Z=D.getContext("2d");if(!Z)return;if(Z.drawImage(t,0,0),it&&mt.complete){const ut=t.width/r.width,Tt=Math.min(D.width,D.height)*(parseInt(R.value)/100);Z.drawImage(mt,w*ut,q*ut,Tt,Tt)}const J=document.createElement("a");J.download="map.png",J.href=D.toDataURL("image/png",1),J.click()}),document.body.appendChild(e)}showResetConfirmation(){const t=document.createElement("div");t.className="modal-backdrop",document.body.appendChild(t);const s=document.createElement("div");s.className="custom-terrain-modal";const e=document.createElement("button");e.className="modal-close-button",e.innerHTML="√ó",s.appendChild(e);const i=document.createElement("h3");i.textContent="Reset Map",s.appendChild(i);const n=document.createElement("div");n.style.textAlign="center",n.style.marginTop="20px",n.style.marginBottom="30px",n.textContent="Are you sure you want to reset the map?",n.style.whiteSpace="pre-line",s.appendChild(n);const o=document.createElement("div");o.className="modal-buttons";const r=document.createElement("button");r.className="modal-button reset-button",r.textContent="Reset";const c=document.createElement("button");c.className="modal-button secondary",c.textContent="Cancel",o.appendChild(r),o.appendChild(c),s.appendChild(o);const h=()=>{document.body.removeChild(t),document.body.removeChild(s)};c.addEventListener("click",h),e.addEventListener("click",h),t.addEventListener("click",l=>{l.target===t&&h()}),r.addEventListener("click",()=>{const l=new CustomEvent("maploaded",{detail:{dimensions:{columns:35,rows:20},totalLeftOperations:0,tiles:[],paths:[]}});document.dispatchEvent(l),h()}),document.body.appendChild(s)}exportToPNG(){const t=this.renderer.getHoveredTile();this.renderer.setHoveredTile(null);const s=this.createExportCanvas();this.showExportPreview(s),this.renderer.setHoveredTile(t)}async saveToBinary(){try{const t=this.renderer.getTiles(),s=this.renderer.getPaths(),e=this.serializeMapToBinary(t,s),i=new Blob([e],{type:"application/octet-stream"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download="map-data.dat",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}catch(t){console.error("Failed to save binary map:",t),alert("Failed to save map. See console for details.")}}async loadFromBinary(){try{const t=document.createElement("input");t.type="file",t.accept=".dat",t.onchange=async s=>{var n;const e=(n=s.target.files)==null?void 0:n[0];if(!e)return;const i=await e.arrayBuffer();try{console.log("Starting map load process...");const o=this.deserializeMapFromBinary(i);console.log("Loaded map data:",{dimensions:o.dimensions,totalLeftOperations:o.totalLeftOperations,tileCount:o.tiles.length,pathCount:o.paths.length});const r=30;console.log("Using hex size:",r);const c=r*2*3/4,h=r*Math.sqrt(3),l=Math.ceil(o.dimensions.columns*c),d=Math.ceil(o.dimensions.rows*h);console.log("Calculated grid dimensions:",{width:l,height:d});const g=new Ot(r,l,d);console.log("Generating base grid with totalLeftOperations:",o.totalLeftOperations);const v=g.generateGrid(o.totalLeftOperations);console.log("Base grid generated:",{tileCount:v.length,sampleTile:v[0],bounds:this.calculateGridBounds(v)});const x=new Map,p=new Map;o.tiles.forEach(T=>{x.set(`${T.coord.q},${T.coord.r}`,T)}),v.forEach(T=>{p.set(`${T.coord.q},${T.coord.r}`,T)}),console.log("Created lookup maps:",{loadedTiles:x.size,baseGridTiles:p.size}),console.log("Starting tile reconstruction...");const u=v.map(T=>{const U=`${T.coord.q},${T.coord.r}`,$=x.get(U);if(!$)return T;const S={...T,terrain:$.terrain,specialTerrain:$.specialTerrain,customTerrain:$.customTerrain,treeOverlay:$.treeOverlay,abovePaths:$.abovePaths};return T.coord.q<2&&T.coord.r<2&&console.log(`Tile at (${T.coord.q}, ${T.coord.r}):`,{baseGeometry:{center:T.center,vertexCount:T.vertices.length},newGeometry:{center:S.center,vertexCount:S.vertices.length},terrain:S.terrain,specialTerrain:S.specialTerrain}),S});console.log("Tiles reconstructed:",{count:u.length,bounds:this.calculateGridBounds(u)});const O=-l/2,b=l/2,y=-d/2,F=d/2,Q=new Map;u.forEach(T=>{Q.set(`${Math.round(T.center.x)},${Math.round(T.center.y)}`,T.center)}),console.log("Starting path adjustment...");const R=o.paths.map((T,U)=>{const $={...T,points:T.points.map((S,X)=>{let k=S,gt=Number.MAX_VALUE;const bt=r*2,xt=Math.round(S.x-bt),pt=Math.round(S.x+bt),mt=Math.round(S.y-bt),w=Math.round(S.y+bt);for(let rt=xt;rt<=pt;rt+=r)for(let nt=mt;nt<=w;nt+=r){const it=`${rt},${nt}`,V=Q.get(it);if(V){const j=V.x-S.x,ht=V.y-S.y,dt=j*j+ht*ht;dt<gt&&(gt=dt,k=V)}}let q=.5;X===0||X===T.points.length-1?q=.75:gt>r*r/4&&(q=.65);const G={x:S.x+(k.x-S.x)*q,y:S.y+(k.y-S.y)*q};return G.x=Math.max(O,Math.min(b,G.x)),G.y=Math.max(y,Math.min(F,G.y)),U===0&&console.log(`Path point ${X} adjustment:`,{original:S,closest:k,adjusted:G,distance:Math.sqrt(gt),factor:q}),G}),smoothPoints:void 0};return U===0&&console.log("First path adjustment:",{originalPoints:T.points.length,adjustedPoints:$.points.length,type:T.type,width:T.width}),$});console.log("Paths adjusted:",{count:R.length,totalPoints:R.reduce((T,U)=>T+U.points.length,0)}),console.log("Updating renderer..."),this.renderer.setTiles(u),this.renderer.setPaths(R),console.log("Forcing render..."),this.renderer.render(),console.log("Dispatching maploaded event...");const et=new CustomEvent("maploaded",{detail:{dimensions:o.dimensions,totalLeftOperations:o.totalLeftOperations,tiles:u,paths:R}});document.dispatchEvent(et),console.log("Map load process completed.")}catch(o){console.error("Failed to parse binary map:",o),alert("Invalid or corrupted map file. See console for details.")}},t.click()}catch(t){console.error("Failed to load binary map:",t),alert("Failed to load map. See console for details.")}}createUniqueImageMap(t){var n;const s=new Set,e=new Map;for(const o of t)((n=o.customTerrain)==null?void 0:n.type)==="image"&&s.add(o.customTerrain.value);const i=Array.from(s);return i.forEach((o,r)=>{e.set(o,r)}),{imageMap:i,imageToIndex:e}}serializeMapToBinary(t,s){const{imageMap:e,imageToIndex:i}=this.createUniqueImageMap(t),n=new Map;t.forEach(u=>{if(u.customTerrain){const O={type:u.customTerrain.type,value:u.customTerrain.value};n.set(`${u.coord.q},${u.coord.r}`,O)}});let o=12+8+4,r=4;for(const u of e)r+=4+u.length;o+=r;let c=4;for(const u of t)c+=8+1+1,u.specialTerrain!==void 0&&(c+=1),u.customTerrain&&(c+=1,u.customTerrain.type==="color"?c+=4+u.customTerrain.value.length:c+=4),u.treeOverlay&&(c+=2);o+=c+this.calculatePathsSize(s);const h=new ArrayBuffer(o),l=new DataView(h);let d=0;const g=new TextEncoder,v=g.encode(qt);for(let u=0;u<4;u++)l.setUint8(d++,v[u]);l.setUint16(d,Bt.MAJOR),d+=2,l.setUint16(d,Bt.MINOR),d+=2,l.setUint32(d,o),d+=4;const x=this.calculateGridDimensions(t);l.setUint32(d,x.rows),d+=4,l.setUint32(d,x.columns),d+=4;const p=this.calculateTotalLeftOperations(t);l.setUint32(d,p),d+=4,l.setUint32(d,e.length),d+=4;for(const u of e){const O=g.encode(u);l.setUint32(d,O.length),d+=4,new Uint8Array(h,d,O.length).set(O),d+=O.length}l.setUint32(d,t.length),d+=4;for(const u of t){l.setInt32(d,u.coord.q),d+=4,l.setInt32(d,u.coord.r),d+=4,l.setUint8(d,this.terrainTypeToNumber(u.terrain)),d+=1;const O=(u.specialTerrain!==void 0?1:0)|(u.customTerrain!==void 0?2:0)|(u.treeOverlay!==void 0?4:0)|(u.abovePaths?8:0);if(l.setUint8(d,O),d+=1,u.specialTerrain!==void 0&&(l.setUint8(d,this.terrainTypeToNumber(u.specialTerrain)),d+=1),u.customTerrain)if(l.setUint8(d,u.customTerrain.type==="color"?0:1),d+=1,u.customTerrain.type==="color"){const b=g.encode(u.customTerrain.value);l.setUint32(d,b.length),d+=4,new Uint8Array(h,d,b.length).set(b),d+=b.length}else{const b=i.get(u.customTerrain.value)??0;l.setUint32(d,b),d+=4}u.treeOverlay&&(l.setUint8(d,u.treeOverlay.type==="forest"?0:1),d+=1,l.setUint8(d,u.treeOverlay.abovePaths?1:0),d+=1)}return this.writePathsToBuffer(l,d,s),h}deserializeMapFromBinary(t){const s=new DataView(t);let e=0;const i=new TextDecoder,n=new Uint8Array(t,0,4);if(i.decode(n)!==qt)throw new Error("Invalid map file format");e+=4;const r=s.getUint16(e);e+=2;const c=s.getUint16(e);if(e+=2,r>Bt.MAJOR||r===Bt.MAJOR&&c>Bt.MINOR)throw new Error("Unsupported map file version");const h=s.getUint32(e);if(e+=4,h!==t.byteLength)throw new Error("Corrupted map file");const l=s.getUint32(e);e+=4;const d=s.getUint32(e);e+=4;const g=s.getUint32(e);e+=4;const v=s.getUint32(e);e+=4;const x=[];for(let b=0;b<v;b++){const y=s.getUint32(e);e+=4;const F=new Uint8Array(t,e,y);x.push(i.decode(F)),e+=y}const p=[],u=s.getUint32(e);e+=4;for(let b=0;b<u;b++){const y=s.getInt32(e);e+=4;const F=s.getInt32(e);e+=4;const Q=this.numberToTerrainType(s.getUint8(e));e+=1;const R=s.getUint8(e);e+=1;const et={coord:{q:y,r:F},terrain:Q,center:{x:0,y:0},vertices:[]};if(R&1&&(et.specialTerrain=this.numberToTerrainType(s.getUint8(e)),e+=1),R&2){const T=s.getUint8(e)===0?"color":"image";if(e+=1,T==="color"){const U=s.getUint32(e);e+=4;const $=new Uint8Array(t,e,U);et.customTerrain={type:"color",value:i.decode($)},e+=U}else{const U=s.getUint32(e);e+=4,et.customTerrain={type:"image",value:x[U]}}}R&4&&(et.treeOverlay={type:s.getUint8(e)===0?"forest":"bog",abovePaths:s.getUint8(e+1)===1},e+=2),R&8&&(et.abovePaths=!0),p.push(et)}const O=this.readPathsFromBuffer(s,e);return{tiles:p,paths:O,dimensions:{rows:l,columns:d},totalLeftOperations:g}}calculatePathsSize(t){let s=4;for(const e of t)s+=1+4+4+4+e.points.length*8;return s}writePathsToBuffer(t,s,e){let i=s;t.setUint32(i,e.length),i+=4;for(const n of e){t.setUint8(i,n.type==="PATH"?0:1),i+=1,t.setFloat32(i,n.width),i+=4,t.setUint32(i,this.parseColor(n.strokeStyle)),i+=4,t.setUint32(i,n.points.length),i+=4;for(const o of n.points)t.setFloat32(i,o.x),i+=4,t.setFloat32(i,o.y),i+=4}}readPathsFromBuffer(t,s){let e=s;const i=[],n=t.getUint32(e);e+=4;for(let o=0;o<n;o++){const r=t.getUint8(e)===0?"PATH":"RIVER";e+=1;const c=t.getFloat32(e);e+=4;const h=this.formatColor(t.getUint32(e));e+=4;const l=t.getUint32(e);e+=4;const d=[];for(let g=0;g<l;g++)d.push({x:t.getFloat32(e),y:t.getFloat32(e+4)}),e+=8;i.push({type:r,width:c,strokeStyle:h,points:d})}return i}calculateTotalLeftOperations(t){const s=t.filter(i=>i.coord.q===0),e=t.filter(i=>i.coord.q===1);if(s.length>0&&e.length>0){const i=s[0].center.y,n=e[0].center.y;return i>n?1:0}return 0}calculateGridDimensions(t){let s=1/0,e=-1/0,i=1/0,n=-1/0;for(const o of t)s=Math.min(s,o.coord.q),e=Math.max(e,o.coord.q),i=Math.min(i,o.coord.r),n=Math.max(n,o.coord.r);return{rows:n-i+1,columns:e-s+1}}terrainTypeToNumber(t){return Object.values(a).indexOf(t)}numberToTerrainType(t){return Object.values(a)[t]}parseColor(t){let s=0,e=0,i=0,n=255;if(t.startsWith("#")){const o=t.substring(1);s=parseInt(o.substring(0,2),16),e=parseInt(o.substring(2,4),16),i=parseInt(o.substring(4,6),16),o.length===8&&(n=parseInt(o.substring(6,8),16))}else if(t.startsWith("rgba")){const o=t.substring(5,t.length-1).split(",");s=parseInt(o[0]),e=parseInt(o[1]),i=parseInt(o[2]),n=Math.round(parseFloat(o[3])*255)}else if(t.startsWith("rgb")){const o=t.substring(4,t.length-1).split(",");s=parseInt(o[0]),e=parseInt(o[1]),i=parseInt(o[2])}return s<<24|e<<16|i<<8|n}formatColor(t){const s=t>>24&255,e=t>>16&255,i=t>>8&255,n=(t&255)/255;return`rgba(${s},${e},${i},${n})`}calculateGridBounds(t){const s={x:{min:1/0,max:-1/0},y:{min:1/0,max:-1/0},q:{min:1/0,max:-1/0},r:{min:1/0,max:-1/0}};return t.forEach(e=>{s.x.min=Math.min(s.x.min,e.center.x),s.x.max=Math.max(s.x.max,e.center.x),s.y.min=Math.min(s.y.min,e.center.y),s.y.max=Math.max(s.y.max,e.center.y),s.q.min=Math.min(s.q.min,e.coord.q),s.q.max=Math.max(s.q.max,e.coord.q),s.r.min=Math.min(s.r.min,e.coord.r),s.r.max=Math.max(s.r.max,e.coord.r)}),s}}function Vt(){const E=document.getElementById("app"),t=document.querySelector(".map-container");if(!E||!t)return;const s=document.createElement("canvas");function e(){if(!t)return{width:0,height:0};const f=t.getBoundingClientRect(),C=window.devicePixelRatio||1;s.style.width=`${f.width}px`,s.style.height=`${f.height}px`,s.width=f.width*C,s.height=f.height*C;const m=s.getContext("2d");return m&&m.scale(C,C),{width:f.width,height:f.height}}const i=e();t.appendChild(s);const n=document.createElement("button");n.className="map-control-button",n.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1v22M8 18l4 4 4-4M8 6l4-4 4 4"/>
        <path d="M1 12h22M18 8l4 4-4 4M6 8l-4 4 4 4"/>
    </svg>`,n.title="Drag Mode",n.addEventListener("click",()=>x.selectDragTool()),n.style.outline="2px solid #4B9CD3",n.style.outlineOffset="-2px",t.appendChild(n);const o=document.createElement("button");o.className="map-control-button",o.style.left="60px",o.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="11" y1="8" x2="11" y2="14"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
    </svg>`,o.title="Zoom In",o.addEventListener("click",()=>p.updateZoom(100,s.width/2,s.height/2)),t.appendChild(o);const r=document.createElement("button");r.className="map-control-button",r.style.left="110px",r.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
    </svg>`,r.title="Zoom Out",r.addEventListener("click",()=>p.updateZoom(-100,s.width/2,s.height/2)),t.appendChild(r);const c=document.createElement("button");c.className="map-control-button",c.style.left="160px",c.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v4M12 18v4M4 12H2M22 12h-4"/>
        <circle cx="12" cy="12" r="6"/>
    </svg>`,c.title="Recenter Map",c.addEventListener("click",()=>{const{zoom:f,centerX:C,centerY:m}=Q();p.setZoom(f),p.setPanPosition(C,m),p.render()}),t.appendChild(c);const h=30;let l=35,d=20,g=0,v=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3)));const x=new Gt,p=new Yt(s,x),u=new Xt(p),O=new jt(p);p.setZoom(.7);const b=250;p.setPanPosition((i.width-b)/2,i.height/2),document.addEventListener("maploaded",f=>{const{dimensions:C,totalLeftOperations:m,tiles:I,paths:H}=f.detail;l=C.columns,d=C.rows,g=m;const M=h*2*3/4,_=h*Math.sqrt(3),L=Math.ceil(l*M),Y=Math.ceil(d*_);v=new Ot(h,L,Y);const z=v.generateGrid(g),A=new Map;I.forEach(P=>{A.set(`${P.coord.q},${P.coord.r}`,P)});const N=z.map(P=>{const lt=`${P.coord.q},${P.coord.r}`,tt=A.get(lt);return tt?{...P,terrain:tt.terrain,specialTerrain:tt.specialTerrain,customTerrain:tt.customTerrain,treeOverlay:tt.treeOverlay,abovePaths:tt.abovePaths}:P}),B=document.querySelector(".dimensions");B&&(B.textContent=`${l}√ó${d}`),y=N,p.setTiles(N),p.setPaths(H),x.setPaths(H),x.deselectAll(),x.selectDragTool(),u.updateGridDimensions(l,d),u.deselectAll(),p.render();const{zoom:st,centerX:ot,centerY:K}=Q();p.setZoom(st),p.setPanPosition(ot,K)}),u.setTerrainSelectCallback(()=>{x.deselectAll(),n.style.outline="none",n.style.outlineOffset="0"}),u.setGridSizeChangeCallback(f=>{let C=!1;switch(f){case"col+left":case"col+right":C=l<50;break;case"col-left":case"col-right":C=l>5;break;case"row+top":case"row+bottom":C=d<30;break;case"row-top":case"row-bottom":C=d>5;break}if(!C)return;switch(S(),f){case"col+left":l++,g++;break;case"col+right":l++;break;case"col-left":l--,g++;break;case"col-right":l--;break;case"row+top":case"row+bottom":d++;break;case"row-top":case"row-bottom":d--;break}let m=0,I=0;(f==="col+left"||f==="col-left")&&(m=f==="col+left"?1:-1),(f==="row+top"||f==="row-top")&&(I=f==="row+top"?1:-1);const H=h*2*3/4,M=h*Math.sqrt(3),_=Math.ceil(l*H),L=Math.ceil(d*M);v=new Ot(h,_,L);const Y=v.generateGrid(g),z=new Map;y.forEach(B=>{z.set(`${B.coord.q},${B.coord.r}`,B)});for(const B of Y){const st=B.coord.q-m,ot=B.coord.r-I,K=`${st},${ot}`,P=z.get(K);P&&(B.terrain=P.terrain,B.specialTerrain=P.specialTerrain,B.customTerrain=P.customTerrain,B.treeOverlay=P.treeOverlay,B.abovePaths=P.abovePaths)}let A=0,N=0;switch(f){case"col+left":case"col-left":A=f==="col+left"?1:-1;break;case"col+right":case"col-right":A=f==="col+right"?-1:1;break;case"row+top":case"row-top":N=f==="row+top"?1:-1;break;case"row+bottom":case"row-bottom":N=f==="row+bottom"?-1:1;break}if(A!==0||N!==0){const B=p.getPaths(),st=h*2*3/4,ot=h*Math.sqrt(3),K=B.map(Mt=>{var Ct;return{...Mt,points:Mt.points.map(Pt=>({x:Pt.x+A*st/2,y:Pt.y+N*ot/2})),smoothPoints:(Ct=Mt.smoothPoints)==null?void 0:Ct.map(Pt=>({x:Pt.x+A*st/2,y:Pt.y+N*ot/2}))}}),P=l*st,lt=d*ot,tt=h*2,vt=-P/2-tt/4,wt=P/2-tt/4,Nt=-lt/2,At=lt/2,Lt=[];K.forEach(Mt=>{let Ct=[],Pt=!1;Mt.points.forEach(kt=>{const Ut=kt.x>=vt&&kt.x<=wt&&kt.y>=Nt&&kt.y<=At;Ut?(Ct.push(kt),!Pt&&Ct.length>1&&(Ct=[kt])):Pt&&Ct.length>=2&&(Lt.push({...Mt,points:[...Ct],smoothPoints:void 0}),Ct=[]),Pt=Ut}),Ct.length>=2&&Lt.push({...Mt,points:Ct,smoothPoints:void 0})}),x.setPaths(Lt),p.setPaths(Lt)}y=Y,p.setTiles(y),u.updateGridDimensions(l,d),p.render()}),x.setToolChangeCallback(()=>{u.deselectAll(),x.isDragMode()?(n.style.outline="2px solid #4B9CD3",n.style.outlineOffset="-2px"):(n.style.outline="none",n.style.outlineOffset="0")});let y=v.generateGrid();p.setTiles(y);let F=null;const Q=()=>{const f=t.getBoundingClientRect(),C=250,m=60,I=h*2*3/4,H=h*Math.sqrt(3),M=l*I+m*2,_=d*H+50,L=(f.width-C)/M,Y=f.height/_,z=Math.min(L,Y)*.9;return{zoom:Math.max(.5,Math.min(z,3)),centerX:(f.width-C)/2,centerY:f.height/2}};window.addEventListener("resize",()=>{F&&window.clearTimeout(F),F=window.setTimeout(()=>{e();const{zoom:f,centerX:C,centerY:m}=Q();p.setZoom(f),p.setPanPosition(C,m),p.render()},250)});const R=document.createElement("div");R.className="toolbar";const et=document.createElement("div");et.className="undo-redo-container";const T=[],U=[];let $=!1;function S(){const f={tiles:y.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0})),paths:p.getPaths().map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0})),cols:l,rows:d,leftOperations:g},C=T[T.length-1];(!C||!X(C,f))&&(T.push(f),U.length=0)}function X(f,C){if(f.cols!==C.cols||f.rows!==C.rows||f.leftOperations!==C.leftOperations||f.paths.length!==C.paths.length||f.tiles.length!==C.tiles.length)return!1;for(let m=0;m<f.tiles.length;m++){const I=f.tiles[m],H=C.tiles[m];if(I.terrain!==H.terrain||I.specialTerrain!==H.specialTerrain||I.abovePaths!==H.abovePaths||JSON.stringify(I.customTerrain)!==JSON.stringify(H.customTerrain)||JSON.stringify(I.treeOverlay)!==JSON.stringify(H.treeOverlay))return!1}for(let m=0;m<f.paths.length;m++){const I=f.paths[m],H=C.paths[m];if(I.type!==H.type||I.width!==H.width||I.points.length!==H.points.length)return!1;for(let M=0;M<I.points.length;M++)if(I.points[M].x!==H.points[M].x||I.points[M].y!==H.points[M].y)return!1}return!0}const k=()=>{if(!($||T.length===0)){$=!0;try{const f=T.pop();if(f){const C={tiles:y.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0})),paths:x.getPaths().map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0})),cols:l,rows:d,leftOperations:g};U.push(C),bt(f)}}finally{$=!1}}},gt=()=>{if(!($||U.length===0)){$=!0;try{const f=U.pop();if(f){const C={tiles:y.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0})),paths:x.getPaths().map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0})),cols:l,rows:d,leftOperations:g};T.push(C),bt(f)}}finally{$=!1}}};function bt(f){l=f.cols,d=f.rows,g=f.leftOperations,v=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3))),y=f.tiles.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0}));const C=f.paths.map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0}));p.setTiles(y),p.setPaths(C),x.setPaths(C),u.updateGridDimensions(l,d),p.render()}s.addEventListener("wheel",f=>{if(V){f.preventDefault();return}f.preventDefault();const C=s.getBoundingClientRect(),m=f.clientX-C.left,I=f.clientY-C.top;p.updateZoom(-f.deltaY,m,I)},{passive:!1});let xt=!1,pt=!1,mt=!1,w=null,q=0,G=0,rt=0,nt=0;function it(f,C,m,I){const H=[],M=Math.hypot(m-f,I-C);if(M<5){const L=p.screenToMapCoordinates(m,I),Y=y.find(z=>Rt(L,z.vertices));return Y&&H.push(Y),H}const _=Math.max(2,Math.ceil(M/10));for(let L=0;L<=_;L++){const Y=L/_,z=f+(m-f)*Y,A=C+(I-C)*Y,N=p.screenToMapCoordinates(z,A),B=y.find(st=>Rt(N,st.vertices));B&&!H.some(st=>st.coord.q===B.coord.q&&st.coord.r===B.coord.r)&&H.push(B)}return H}s.addEventListener("mousedown",f=>{if(V)return;const C=s.getBoundingClientRect(),m=f.clientX-C.left,I=f.clientY-C.top;if(rt=m,nt=I,x.isDragMode())mt=!0,s.style.cursor="grabbing",q=m,G=I;else if(x.getCurrentTool()===St.PATH||x.getCurrentTool()===St.RIVER){const H=p.screenToMapCoordinates(m,I),M=y.find(_=>Rt(H,_.vertices));M&&(S(),xt=!0,x.startPath(M.center),p.setCurrentPath(x.getCurrentPath()))}else if(u.isTerrainSelected()){const H=p.screenToMapCoordinates(m,I),M=y.find(_=>Rt(H,_.vertices));if(M){const _=u.getSelectedTerrain();if(u.getDrawMode()==="FILL"){pt=!0;return}if(S(),pt=!0,_===a.NONE){if(u.getDrawMode()==="FILL")if(S(),M.terrain===a.NONE&&M.specialTerrain!==void 0){const Y=M.specialTerrain,z=new Set,A=[M];for(;A.length>0;){const N=A.shift(),B=`${N.coord.q},${N.coord.r}`;if(!z.has(B)&&(z.add(B),N.terrain===a.NONE&&N.specialTerrain===Y)){p.setTileTerrain(N,a.NONE),N.abovePaths=u.isDrawAbovePaths();const st=zt(N);for(const ot of st){const K=y.find(P=>P.coord.q===ot.q&&P.coord.r===ot.r);K&&A.push(K)}}}p.render()}else ht(M,M.terrain,_);else p.setTileTerrain(M,a.NONE),M.abovePaths=u.isDrawAbovePaths(),p.render();return}const L=u.getCustomTerrainData();p.setTileTerrain(M,_,L||void 0),M.abovePaths=u.isDrawAbovePaths(),w=`${M.coord.q},${M.coord.r}`,p.render()}}else x.getCurrentTool()===St.REMOVE&&(S(),pt=!0)}),s.addEventListener("mousemove",f=>{const C=s.getBoundingClientRect(),m=f.clientX-C.left,I=f.clientY-C.top,H=p.screenToMapCoordinates(m,I),M=y.find(_=>Rt(H,_.vertices));if(mt||p.setHoveredTile(M||null),mt){const _=m-q,L=I-G;p.pan(_,L),q=m,G=I}else if(xt&&M)it(rt,nt,m,I).forEach(L=>{x.updatePath(L.center)}),p.setCurrentPath(x.getCurrentPath());else if(pt&&M&&u.getDrawMode()==="DRAW"&&u.isTerrainSelected()){const _=it(rt,nt,m,I);_.forEach(L=>{const Y=`${L.coord.q},${L.coord.r}`;if(Y!==w){const z=u.getSelectedTerrain();if(z===a.NONE){p.setTileTerrain(L,a.NONE),L.abovePaths=u.isDrawAbovePaths(),w=Y;return}const A=u.getCustomTerrainData();p.setTileTerrain(L,z,A||void 0),L.abovePaths=u.isDrawAbovePaths(),w=Y}}),_.length>0&&p.render()}else if(pt&&M&&x.getCurrentTool()===St.REMOVE){const _=it(rt,nt,m,I);if(_.length>0){const L=[];let Y=!1;x.getPaths().forEach(z=>{let A=[],N=!0;z.points.forEach(B=>{const st=_.some(ot=>{let K=!1;const P=ot.vertices;for(let lt=0,tt=P.length-1;lt<P.length;tt=lt++){const vt=P[lt].x,wt=P[lt].y,Nt=P[tt].x,At=P[tt].y;wt>B.y!=At>B.y&&B.x<(Nt-vt)*(B.y-wt)/(At-wt)+vt&&(K=!K)}return K});st?N&&A.length>=2&&(L.push({points:[...A],type:z.type,width:z.width,strokeStyle:z.strokeStyle}),Y=!0,A=[]):(A.push(B),!N&&A.length>=2&&(L.push({points:[...A],type:z.type,width:z.width,strokeStyle:z.strokeStyle}),Y=!0,A=[B])),N=!st}),A.length>=2&&(L.push({points:[...A],type:z.type,width:z.width,strokeStyle:z.strokeStyle}),Y=!0)}),Y&&(x.setPaths(L),p.setPaths(L),p.render())}}rt=m,nt=I}),s.addEventListener("mouseup",()=>{mt?(mt=!1,s.style.cursor="grab"):xt&&(xt=!1,x.endPath(),p.setCurrentPath([]),p.setPaths(x.getPaths())),pt=!1,w=null}),s.addEventListener("mouseover",()=>{x.isDragMode()?s.style.cursor="grab":x.isDrawingMode()||u.isTerrainSelected()||x.getCurrentTool()===St.REMOVE?s.style.cursor="crosshair":s.style.cursor="default"}),s.addEventListener("mouseleave",()=>{mt&&(mt=!1,s.style.cursor="grab"),xt&&(xt=!1,x.endPath(),p.setPaths(x.getPaths())),pt=!1,w=null});let V=!1;function j(f){V=f,s.style.cursor=f?"wait":"default",document.body.classList.toggle("app-loading",f)}function ht(f,C,m){if(C===m)return;j(!0);const I=new Set,H=[],M=[f],_=u.isDrawAbovePaths(),L=u.getCustomTerrainData(),Y=Dt.has(m),z=f.specialTerrain,A=C===a.NONE&&z!==void 0,N=document.createElement("div");N.style.position="fixed",N.style.top="50%",N.style.left="50%",N.style.transform="translate(-50%, -50%)",N.style.padding="20px",N.style.backgroundColor="rgba(0, 0, 0, 0.7)",N.style.color="white",N.style.borderRadius="5px",N.style.zIndex="1000",N.textContent="Processing terrain...",document.body.appendChild(N);const B=100;function st(P){if(m===a.NONE){if(A)return P.terrain===a.NONE&&P.specialTerrain===z;const lt=P.terrain===C,tt=z===void 0&&P.specialTerrain===void 0||z!==void 0&&P.specialTerrain===z;return lt&&tt}return Y?z?P.specialTerrain===z:P.specialTerrain===void 0:P.terrain===C}function ot(){for(;M.length>0;){const P=M.shift(),lt=`${P.coord.q},${P.coord.r}`;if(I.has(lt)||(I.add(lt),!st(P)))continue;H.push(P);const tt=zt(P);for(const vt of tt){const wt=y.find(Nt=>Nt.coord.q===vt.q&&Nt.coord.r===vt.r);wt&&M.push(wt)}}K(0)}function K(P){const lt=Math.min(100,Math.round(P/H.length*100));if(N.textContent=`Processing terrain... ${lt}%`,P>=H.length){document.body.removeChild(N),j(!1),p.render();return}const tt=Math.min(P+B,H.length);for(let vt=P;vt<tt;vt++){const wt=H[vt];m===a.NONE?p.setTileTerrain(wt,a.NONE):Y?(wt.specialTerrain=m,delete wt.treeOverlay):m===a.CUSTOM&&L?p.setTileTerrain(wt,m,L):p.setTileTerrain(wt,m),wt.abovePaths=_}requestAnimationFrame(()=>K(tt))}ot()}s.addEventListener("click",f=>{if(!V&&!x.isDrawingMode()){const C=s.getBoundingClientRect(),m=f.clientX-C.left,I=f.clientY-C.top,H=p.screenToMapCoordinates(m,I),M=y.find(_=>Rt(H,_.vertices));if(M){if(x.getCurrentTool()===St.REMOVE){S();const L=M.vertices,Y=A=>{let N=!1;for(let B=0,st=L.length-1;B<L.length;st=B++){const ot=L[B].x,K=L[B].y,P=L[st].x,lt=L[st].y;K>A.y!=lt>A.y&&A.x<(P-ot)*(A.y-K)/(lt-K)+ot&&(N=!N)}return N},z=[];x.getPaths().forEach(A=>{const N=[];let B=[];A.points.forEach((st,ot)=>{Y(st)?B.length>0&&(N.push([...B]),B=[]):B.push(st),ot===A.points.length-1&&B.length>0&&N.push([...B])}),N.forEach(st=>{if(st.length>=2){const ot={points:st,type:A.type,width:A.width,strokeStyle:A.strokeStyle};z.push(ot)}})}),x.setPaths(z),p.setPaths(z),p.render()}else if(u.isTerrainSelected()){const L=u.getSelectedTerrain();if(L===a.NONE){if(u.getDrawMode()==="FILL")if(S(),M.terrain===a.NONE&&M.specialTerrain!==void 0){const Y=M.specialTerrain,z=new Set,A=[M];for(;A.length>0;){const N=A.shift(),B=`${N.coord.q},${N.coord.r}`;if(!z.has(B)&&(z.add(B),N.terrain===a.NONE&&N.specialTerrain===Y)){p.setTileTerrain(N,a.NONE),N.abovePaths=u.isDrawAbovePaths();const st=zt(N);for(const ot of st){const K=y.find(P=>P.coord.q===ot.q&&P.coord.r===ot.r);K&&A.push(K)}}}p.render()}else ht(M,M.terrain,L);else p.setTileTerrain(M,a.NONE),M.abovePaths=u.isDrawAbovePaths(),p.render();return}if(u.getDrawMode()==="FILL"){const Y=M.terrain;(Dt.has(L)||Y!==L)&&(S(),ht(M,Y,L))}else{const Y=u.getCustomTerrainData();p.setTileTerrain(M,L,Y||void 0),M.abovePaths=u.isDrawAbovePaths(),p.render()}}}}});const dt=document.createElement("button");dt.className="map-control-button",dt.style.left="210px",dt.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7v6h6"/>
        <path d="M3 13c0-4.97 4.03-9 9-9 4.97 0 9 4.03 9 9s-4.03 9-9 9c-2.49 0-4.74-1.01-6.36-2.64"/>
    </svg>`,dt.title="Undo",dt.addEventListener("click",k),t.appendChild(dt);const ct=document.createElement("button");ct.className="map-control-button",ct.style.left="260px",ct.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 7v6h-6"/>
        <path d="M21 13c0-4.97-4.03-9-9-9-4.97 0-9 4.03-9 9s4.03 9 9 9c2.49 0 4.74-1.01 6.36-2.64"/>
    </svg>`,ct.title="Redo",ct.addEventListener("click",gt),t.appendChild(ct);const ft=document.createElement("div");ft.className="grid-size-controls";const at=document.createElement("button");at.className="map-control-button",at.style.cssText=`
        position: absolute;
        left: 310px;
        top: 10px;
        padding: 6px 12px;
        background: rgba(32, 32, 32, 0.8);
        border: 1px solid rgba(64, 64, 64, 0.6);
        border-radius: 6px;
        color: currentColor;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
        min-width: 130px;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    `,at.textContent="Grid Numbers: On",at.title="Toggle Grid Numbers";let yt=!0;at.addEventListener("mouseover",()=>{at.style.background="rgba(42, 42, 42, 0.9)",at.style.borderColor="rgba(80, 80, 80, 0.8)"}),at.addEventListener("mouseout",()=>{at.style.background="rgba(32, 32, 32, 0.8)",at.style.borderColor="rgba(64, 64, 64, 0.6)"}),at.addEventListener("click",()=>{yt=!yt,at.textContent=`Grid Numbers: ${yt?"On":"Off"}`,p.setShowGridNumbers(yt),p.render()}),t.appendChild(at);const D=f=>{S();let C=0,m=0;switch(f){case"col+left":C=1;break;case"col-left":C=-1;break;case"row+top":m=1;break;case"row-top":m=-1;break}v=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3)));const I=v.generateGrid(g);for(const K of I){let P=K.coord.q,lt=K.coord.r;f.includes("col")&&(P-=C),f.includes("row")&&(lt-=m);const tt=y.find(vt=>vt.coord.q===P&&vt.coord.r===lt);tt&&(K.terrain=tt.terrain,K.specialTerrain=tt.specialTerrain,K.customTerrain=tt.customTerrain,K.abovePaths=tt.abovePaths,K.treeOverlay=tt.treeOverlay)}const H=h*2*3/4,M=h*Math.sqrt(3),_=l*H,L=d*M,Y=h*2,z=-_/2-Y/4,A=_/2-Y/4,N=-L/2,B=L/2,st=x.getPaths(),ot=[];st.forEach(K=>{let P=[],lt=!1;K.points.forEach(tt=>{const vt=tt.x>=z&&tt.x<=A&&tt.y>=N&&tt.y<=B;vt?(P.push(tt),!lt&&P.length>1&&(P=[tt])):lt&&P.length>=2&&(ot.push({...K,points:[...P],smoothPoints:void 0}),P=[]),lt=vt}),P.length>=2&&ot.push({...K,points:P,smoothPoints:void 0})}),x.setPaths(ot),p.setPaths(ot),y=I,p.setTiles(y),p.render()},Z=document.createElement("div");Z.className="grid-control top";const J=document.createElement("div");J.className="middle-controls";const ut=document.createElement("div");ut.className="grid-control bottom";const Tt=()=>{const f=J.querySelector(".dimensions");f&&(f.textContent=`${l}√ó${d}`)},Et=(f,C)=>{const m=document.createElement("button");m.textContent=f.includes("+")?"+":"-",m.title=f,m.className=f.includes("+")?"plus":"minus",m.addEventListener("click",()=>{let I=!1;switch(f){case"col+left":case"col+right":l<50&&(l++,I=!0);break;case"col-left":case"col-right":l>5&&(l--,I=!0);break;case"row+top":case"row+bottom":d<30&&(d++,I=!0);break;case"row-top":case"row-bottom":d>5&&(d--,I=!0);break}I&&(Tt(),v=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3))),D(f))}),C.appendChild(m)};Et("row-top",Z),Et("row+top",Z),Et("col-left",J),Et("col+left",J);const Wt=document.createElement("div");Wt.className="dimensions",Wt.textContent=`${l}√ó${d}`,J.appendChild(Wt),Et("col-right",J),Et("col+right",J),Et("row-bottom",ut),Et("row+bottom",ut),ft.appendChild(Z),ft.appendChild(J),ft.appendChild(ut),t.appendChild(ft),R.appendChild(u.getElement()),R.appendChild(x.getElement()),R.appendChild(O.createExportButtons()),E.insertBefore(R,t)}function Rt(E,t){let s=!1;for(let e=0,i=t.length-1;e<t.length;i=e++){const n=t[e].x,o=t[e].y,r=t[i].x,c=t[i].y;o>E.y!=c>E.y&&E.x<(r-n)*(E.y-o)/(c-o)+n&&(s=!s)}return s}function zt(E){const t=E.coord.q,s=E.coord.r,e=t%2===1;return[{q:t,r:s-1},{q:t+1,r:e?s:s-1},{q:t+1,r:e?s+1:s},{q:t,r:s+1},{q:t-1,r:e?s+1:s},{q:t-1,r:e?s:s-1}]}document.addEventListener("DOMContentLoaded",Vt);
