var Ht=Object.defineProperty;var $t=(S,t,n)=>t in S?Ht(S,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):S[t]=n;var W=(S,t,n)=>($t(S,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var a=(S=>(S.NONE="NONE",S.WATER="WATER",S.GRASS="GRASS",S.FOREST="FOREST",S.BOG="BOG",S.HILLS="HILLS",S.MOUNTAIN="MOUNTAIN",S.IMPASSABLE="IMPASSABLE",S.CLOUD="CLOUD",S.TOWN1="TOWN1",S.TOWN2="TOWN2",S.TOWN3="TOWN3",S.HARBOR="HARBOR",S.SHIPS="SHIPS",S.LIGHTTOWER="LIGHTTOWER",S.TREE="TREE",S.MINE="MINE",S.CUSTOM="CUSTOM",S))(a||{});const Dt=new Set(["TOWN1","TOWN2","TOWN3","HARBOR","SHIPS","LIGHTTOWER","TREE","MINE"]),kt=new Set(["TOWN1","TOWN2","TOWN3","LIGHTTOWER","TREE"]);class Ot{constructor(t,n,e){W(this,"hexSize");W(this,"width");W(this,"height");this.hexSize=t,this.width=n,this.height=e}calculateHexVertices(t){const n=[];for(let e=0;e<6;e++){const i=Math.PI/3*e;n.push({x:t.x+this.hexSize*Math.cos(i),y:t.y+this.hexSize*Math.sin(i)})}return n}generateGrid(t=0){const n=[],e=this.hexSize*2,i=this.hexSize*Math.sqrt(3),s=e*3/4,o=i,r=Math.floor(this.width/(this.hexSize*2*3/4)),c=Math.floor(this.height/(this.hexSize*Math.sqrt(3))),h=r*s,l=c*o,d=-h/2,g=-l/2;for(let x=0;x<r;x++){const p=(t%2===1?x+1:x)%2*(o/2);for(let u=0;u<c;u++){const b={x:d+x*s,y:g+u*o+p};n.push({coord:{q:x,r:u},terrain:a.NONE,center:b,vertices:this.calculateHexVertices(b)})}}return n}pixelToAxial(t,n){const e=(Math.sqrt(3)/3*t-n/3)/this.hexSize,i=n*2/3/this.hexSize;return{q:e,r:i}}axialToPixel(t){const n=this.hexSize*(Math.sqrt(3)*t.q+Math.sqrt(3)/2*t.r),e=this.hexSize*(3/2*t.r);return{x:n,y:e}}roundAxial(t){let n=Math.round(t.q),e=Math.round(t.r);const i=Math.abs(n-t.q),s=Math.abs(e-t.r);return i>s&&(n=-e),{q:n,r:e}}hexDistance(t,n){return Math.max(Math.abs(t.q-n.q),Math.abs(t.r-n.r))}lerpAxial(t,n,e){return{q:t.q*(1-e)+n.q*e,r:t.r*(1-e)+n.r*e}}getHexLine(t,n){const e=this.roundAxial(this.pixelToAxial(t.x,t.y)),i=this.roundAxial(this.pixelToAxial(n.x,n.y)),s=this.hexDistance(e,i),o=[];for(let r=0;r<=s;r++){const c=s===0?0:r/s,h=this.roundAxial(this.lerpAxial(e,i,c));o.push(this.axialToPixel(h))}return o}}function Ft(S,t,n=.1){if(t<1)throw new Error("Resolution must be at least 1");if(S.length<2)return S;const e=S[0],i=S[S.length-1],s={x:e.x-(S[1].x-e.x)*2,y:e.y-(S[1].y-e.y)*2},o={x:i.x+(i.x-S[S.length-2].x)*2,y:i.y+(i.y-S[S.length-2].y)*2},r=[s,...S,o],c=[];for(let h=0;h<r.length-3;h++){const l=r[h],d=r[h+1],g=r[h+2],x=r[h+3];if(h>0)for(let v=0;v<t;v++){const p=v/t,u=p*p,b=u*p,C=.5*(2*d.x+(-l.x+g.x)*n*p+(2*l.x-5*d.x+4*g.x-x.x)*n*u+(-l.x+3*d.x-3*g.x+x.x)*n*b),w=.5*(2*d.y+(-l.y+g.y)*n*p+(2*l.y-5*d.y+4*g.y-x.y)*n*u+(-l.y+3*d.y-3*g.y+x.y)*n*b);c.push({x:C,y:w})}}return c.push(S[S.length-1]),c}var St=(S=>(S.DRAG="DRAG",S.NONE="NONE",S.PATH="PATH",S.RIVER="RIVER",S.REMOVE="REMOVE",S))(St||{});class Gt{constructor(){W(this,"selectedTool","DRAG");W(this,"container");W(this,"currentPath",[]);W(this,"paths",[]);W(this,"isDrawing",!1);W(this,"onToolChange",null);W(this,"pathSize",5);W(this,"previewSize",96);W(this,"pathButton",null);W(this,"riverButton",null);this.container=document.createElement("div"),this.container.className="drawing-toolbar",this.initializeUI()}setToolChangeCallback(t){this.onToolChange=t}deselectAll(){this.selectedTool="NONE",this.updateUI()}selectDragTool(){this.selectedTool="DRAG",this.updateUI(),this.onToolChange&&this.onToolChange()}createPreviewCanvas(){const t=document.createElement("canvas");return t.width=this.previewSize,t.height=this.previewSize,t}drawRoutePreview(t,n){const e=t.getContext("2d");if(!e)return;e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";const i=this.previewSize,s=i*.45,o={x:i/2,y:i/2},r=[];for(let l=0;l<6;l++){const d=Math.PI/3*l;r.push({x:o.x+s*Math.cos(d),y:o.y+s*Math.sin(d)})}e.clearRect(0,0,i,i),e.beginPath(),e.moveTo(r[0].x,r[0].y);for(let l=1;l<r.length;l++)e.lineTo(r[l].x,r[l].y);e.closePath(),e.strokeStyle="#404040",e.lineWidth=1.5,e.stroke(),e.beginPath();const c=o.y-s*.6,h=o.y+s*.6;e.moveTo(o.x,c),e.lineTo(o.x,h),n?(e.strokeStyle="#4B9CD3",e.lineWidth=this.pathSize*1.5,e.lineCap="round",e.stroke(),e.beginPath(),e.moveTo(o.x,c),e.lineTo(o.x,h),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=this.pathSize*.8,e.stroke()):(e.strokeStyle="#8B4513",e.lineWidth=this.pathSize*1.5,e.lineCap="round",e.stroke(),e.beginPath(),e.moveTo(o.x,c),e.lineTo(o.x,h),e.strokeStyle="rgba(139, 69, 19, 0.3)",e.lineWidth=this.pathSize*.8,e.stroke())}updatePreviews(){if(this.pathButton){const t=this.createPreviewCanvas();for(this.drawRoutePreview(t,!1);this.pathButton.firstChild;)this.pathButton.removeChild(this.pathButton.firstChild);this.pathButton.appendChild(t)}if(this.riverButton){const t=this.createPreviewCanvas();for(this.drawRoutePreview(t,!0);this.riverButton.firstChild;)this.riverButton.removeChild(this.riverButton.firstChild);this.riverButton.appendChild(t)}}initializeUI(){const t=document.createElement("div");t.className="toolbar-section";const n=document.createElement("h2");n.textContent="Routes",t.appendChild(n);const e=document.createElement("div");e.className="size-control";const i=document.createElement("label");i.textContent="Size:",e.appendChild(i);const s=document.createElement("span");s.textContent=this.pathSize.toString(),s.className="size-value";const o=document.createElement("input");o.type="range",o.min="1",o.max="10",o.value=this.pathSize.toString(),o.className="size-slider",o.addEventListener("input",x=>{const v=parseInt(x.target.value);this.pathSize=v,s.textContent=v.toString(),this.updatePreviews()}),e.appendChild(o),e.appendChild(s),t.appendChild(e);const r=document.createElement("div");r.className="terrain-button-container";const c=document.createElement("button");c.className="terrain-button",c.title="Remove Route";const h=this.createPreviewCanvas(),l=new Image;l.onload=()=>{const x=h.getContext("2d");if(x){this.drawHexagonBackground(h);const v=this.previewSize,p=v*.45,u={x:v/2,y:v/2},b=[];for(let M=0;M<6;M++){const G=Math.PI/3*M;b.push({x:u.x+p*Math.cos(G),y:u.y+p*Math.sin(G)})}const C=Math.min(...b.map(M=>M.x)),w=Math.min(...b.map(M=>M.y)),et=Math.max(...b.map(M=>M.x)),U=Math.max(...b.map(M=>M.y)),B=et-C,Q=U-w,y=Math.min(B/l.width,Q/l.height),q=l.width*y,$=l.height*y;x.drawImage(l,u.x-q/2,u.y-$/2,q,$)}},l.onerror=()=>{l.src.startsWith("/src/")&&(l.src="./src/assets/noroute.png")},l.src="/src/assets/noroute.png",c.appendChild(h),c.addEventListener("click",()=>this.selectTool("REMOVE")),r.appendChild(c),this.pathButton=document.createElement("button"),this.pathButton.className="terrain-button",this.pathButton.title="Path";const d=this.createPreviewCanvas();this.drawRoutePreview(d,!1),this.pathButton.appendChild(d),this.pathButton.addEventListener("click",()=>this.selectTool("PATH")),r.appendChild(this.pathButton),this.riverButton=document.createElement("button"),this.riverButton.className="terrain-button",this.riverButton.title="River";const g=this.createPreviewCanvas();this.drawRoutePreview(g,!0),this.riverButton.appendChild(g),this.riverButton.addEventListener("click",()=>this.selectTool("RIVER")),r.appendChild(this.riverButton),t.appendChild(r),this.container.appendChild(t)}drawHexagonBackground(t){const n=t.getContext("2d");if(!n)return;const e=this.previewSize,i=e*.45,s={x:e/2,y:e/2},o=[];for(let r=0;r<6;r++){const c=Math.PI/3*r;o.push({x:s.x+i*Math.cos(c),y:s.y+i*Math.sin(c)})}n.clearRect(0,0,e,e),n.beginPath(),n.moveTo(o[0].x,o[0].y);for(let r=1;r<o.length;r++)n.lineTo(o[r].x,o[r].y);n.closePath(),n.strokeStyle="#404040",n.lineWidth=1.5,n.stroke()}selectTool(t){t!==this.selectedTool&&(this.selectedTool=t,this.updateUI(),this.onToolChange&&this.onToolChange())}updateUI(){this.container.querySelectorAll(".terrain-button").forEach(n=>{const e=n;e.classList.remove("selected"),(e.title==="Path"&&this.selectedTool==="PATH"||e.title==="River"&&this.selectedTool==="RIVER"||e.title==="Remove Route"&&this.selectedTool==="REMOVE")&&e.classList.add("selected")})}startPath(t){this.selectedTool!=="NONE"&&(this.isDrawing=!0,this.currentPath=[t])}updatePath(t){if(!this.isDrawing)return;const n=this.currentPath[this.currentPath.length-1];(!n||Math.hypot(n.x-t.x,n.y-t.y)>1)&&this.currentPath.push(t)}endPath(){if(!this.isDrawing||this.currentPath.length<2)return;const t=this.selectedTool==="RIVER",n={points:[...this.currentPath],type:this.selectedTool==="RIVER"?"RIVER":"PATH",width:this.pathSize,strokeStyle:t?"#4B9CD3":"#8B4513"};if(this.currentPath.length>=3){const e=Ft(this.currentPath,20,1);e[0]=this.currentPath[0],n.smoothPoints=e}this.paths.push(n),this.isDrawing=!1,this.currentPath=[]}getPaths(){return this.paths}getCurrentPath(){return this.currentPath}getCurrentTool(){return this.selectedTool}isDrawingMode(){return this.selectedTool==="PATH"||this.selectedTool==="RIVER"}isDragMode(){return this.selectedTool==="DRAG"}getPathSize(){return this.pathSize}getElement(){return this.container}setPaths(t){this.paths=t}}class Yt{constructor(t,n){W(this,"canvas");W(this,"ctx");W(this,"tiles",[]);W(this,"paths",[]);W(this,"currentPath",[]);W(this,"hoveredTile",null);W(this,"zoom",1);W(this,"minZoom",.5);W(this,"maxZoom",3);W(this,"panX",0);W(this,"panY",0);W(this,"drawingTools");W(this,"terrainTextures",new Map);W(this,"treeOverlayTextures",new Map);W(this,"onTextureLoadCallbacks",[]);W(this,"customTerrainImages",new Map);W(this,"showGridNumbers",!0);this.canvas=t,this.drawingTools=n;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D rendering context");this.ctx=e,this.centerMap(),this.loadTerrainTextures()}centerMap(){this.panX=this.canvas.width/2,this.panY=this.canvas.height/2,this.zoom=1}updateZoom(t,n,e){const i=this.zoom,s=t>0?1.1:1/1.1,o=Math.min(Math.max(i*s,this.minZoom),this.maxZoom);if(o!==i){const r=(n-this.panX)/i,c=(e-this.panY)/i;this.zoom=o,this.panX=n-r*o,this.panY=e-c*o,this.render()}}applyTransform(){this.ctx.save(),this.ctx.translate(this.panX,this.panY),this.ctx.scale(this.zoom,this.zoom)}setTiles(t){this.tiles=t,this.render()}addTextureLoadCallback(t){this.onTextureLoadCallbacks.push(t)}loadTerrainTextures(){const t={[a.GRASS]:"grass.png",[a.WATER]:"water.png",[a.FOREST]:"forest.png",[a.HILLS]:"hills.png",[a.MOUNTAIN]:"mountain.png",[a.IMPASSABLE]:"impassable.png",[a.CLOUD]:"cloud.png",[a.BOG]:"bog.png",[a.TOWN1]:"town1.png",[a.TOWN2]:"town2.png",[a.TOWN3]:"town3.png",[a.HARBOR]:"harbor.png",[a.SHIPS]:"ships.png",[a.LIGHTTOWER]:"lighttower.png",[a.TREE]:"tree.png",[a.MINE]:"mine.png"},n={forest:"foresttrees.png",bog:"bogtrees.png"},e=[],i=o=>`/src/assets/${o}`,s=o=>new Promise((r,c)=>{const h=new Image;h.onload=()=>r(h),h.onerror=()=>{o.startsWith("/src/")?h.src=`./src/assets/${o.split("/").pop()}`:c(new Error(`Failed to load image: ${o}`))},h.src=o});Object.entries(t).forEach(([o,r])=>{const c=s(i(r)).then(h=>{this.terrainTextures.set(o,h)}).catch(()=>{});e.push(c)}),Object.entries(n).forEach(([o,r])=>{const c=s(i(r)).then(h=>{this.treeOverlayTextures.set(o,h)}).catch(()=>{});e.push(c)}),Promise.all(e).then(()=>{this.onTextureLoadCallbacks.forEach(o=>o()),this.render()}).catch(()=>{this.onTextureLoadCallbacks.forEach(o=>o()),this.render()})}getTerrainColor(t){switch(t){case a.WATER:return"#4B9CD3";case a.GRASS:return"#90EE90";case a.FOREST:return"#228B22";case a.BOG:return"#006400";case a.HILLS:return"#D2B48C";case a.MOUNTAIN:return"#808080";case a.IMPASSABLE:return"#4A4A4A";case a.CLOUD:return"rgba(200, 200, 200, 0.5)";case a.TOWN1:return"#DEB887";case a.TOWN2:return"#8B4513";case a.TOWN3:return"#A0522D";case a.HARBOR:return"#5DADE2";case a.SHIPS:return"#4682B4";case a.LIGHTTOWER:return"#F5DEB3";case a.TREE:return"#2E8B57";case a.MINE:return"#696969";case a.CUSTOM:return"#FFFFFF";default:return"#FFFFFF"}}renderPaths(t=!1){if(this.paths.forEach(n=>{if(n.points.length<2)return;const e=n.type==="RIVER",i=t?n.width:n.width/this.zoom;if(this.ctx.save(),e){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(41, 98, 155, 0.3)",this.ctx.lineWidth=i*1.8,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#3178b9",this.ctx.lineWidth=i*1.4,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#4B9CD3",this.ctx.lineWidth=i,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.2)",this.ctx.lineWidth=i*.6;const s=n.points.map((o,r)=>({x:o.x+Math.sin(r*.3)*(i*.1),y:o.y+Math.cos(r*.3)*(i*.1)}));this.drawPathWithPoints(s),this.ctx.stroke();for(let o=0;o<3;o++){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=i*.1;const r=n.points.map((c,h)=>({x:c.x+Math.sin((h+o)*.5)*(i*.3),y:c.y+Math.cos((h+o)*.5)*(i*.3)}));this.drawPathWithPoints(r),this.ctx.stroke()}}else{this.ctx.beginPath(),this.ctx.strokeStyle="rgba(84, 48, 18, 0.2)",this.ctx.lineWidth=i*1.6,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.6)",this.ctx.lineWidth=i*1.2,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=i*.9,this.drawPathWithPoints(n.points),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(159, 99, 43, 0.5)",this.ctx.lineWidth=i*.4,this.drawPathWithPoints(n.points),this.ctx.stroke();const s=8;for(let o=0;o<s;o++){const r=o/s;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.2)",this.ctx.lineWidth=i*.1;const c=n.points.map((h,l)=>({x:h.x+Math.sin((l+r)*2)*(i*.2),y:h.y+Math.cos((l+r)*2)*(i*.2)}));this.drawPathWithPoints(c),this.ctx.stroke()}}this.ctx.restore()}),!t&&this.currentPath.length>=2){const n=this.drawingTools.getCurrentTool()===St.RIVER,e=this.drawingTools.getPathSize()/this.zoom;if(this.ctx.save(),n){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(41, 98, 155, 0.3)",this.ctx.lineWidth=e*1.8,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#3178b9",this.ctx.lineWidth=e*1.4,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#4B9CD3",this.ctx.lineWidth=e,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.2)",this.ctx.lineWidth=e*.6;const i=this.currentPath.map((s,o)=>({x:s.x+Math.sin(o*.3)*(e*.1),y:s.y+Math.cos(o*.3)*(e*.1)}));this.drawPathWithPoints(i),this.ctx.stroke();for(let s=0;s<3;s++){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=e*.1;const o=this.currentPath.map((r,c)=>({x:r.x+Math.sin((c+s)*.5)*(e*.3),y:r.y+Math.cos((c+s)*.5)*(e*.3)}));this.drawPathWithPoints(o),this.ctx.stroke()}}else{this.ctx.beginPath(),this.ctx.strokeStyle="rgba(84, 48, 18, 0.2)",this.ctx.lineWidth=e*1.6,this.ctx.lineCap="butt",this.ctx.lineJoin="round",this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.6)",this.ctx.lineWidth=e*1.2,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=e*.9,this.drawPathWithPoints(this.currentPath),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(159, 99, 43, 0.5)",this.ctx.lineWidth=e*.4,this.drawPathWithPoints(this.currentPath),this.ctx.stroke();const i=8;for(let s=0;s<i;s++){const o=s/i;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(101, 67, 33, 0.2)",this.ctx.lineWidth=e*.1;const r=this.currentPath.map((c,h)=>({x:c.x+Math.sin((h+o)*2)*(e*.2),y:c.y+Math.cos((h+o)*2)*(e*.2)}));this.drawPathWithPoints(r),this.ctx.stroke()}}this.ctx.restore()}}drawPathWithPoints(t){if(this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y),t.length>=3){const n=Ft(t,20,1);for(let e=1;e<n.length;e++)this.ctx.lineTo(n[e].x,n[e].y)}else this.ctx.lineTo(t[1].x,t[1].y)}setPaths(t){this.paths=t,this.render()}setCurrentPath(t){this.currentPath=t,t.length>0&&this.render()}render(){this.ctx.fillStyle="#1e1e1e",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.strokeStyle="#252525",this.ctx.lineWidth=1;const t=60,n=t*2,e=t*Math.sqrt(3),i=n*3/4,s=e,o=Math.ceil(this.canvas.width/i)+1,r=Math.ceil(this.canvas.height/s)+1;for(let c=-1;c<o;c++){const h=c%2*(s/2);for(let l=-1;l<r;l++){const d={x:c*i,y:l*s+h};this.ctx.beginPath();for(let g=0;g<6;g++){const x=Math.PI/3*g,v=d.x+t*Math.cos(x),p=d.y+t*Math.sin(x);g===0?this.ctx.moveTo(v,p):this.ctx.lineTo(v,p)}this.ctx.closePath(),this.ctx.stroke()}}this.ctx.strokeStyle="#191919",this.ctx.lineWidth=6,this.ctx.strokeRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.applyTransform();for(const c of this.tiles)c.terrain!==a.CUSTOM&&c.terrain!==a.WATER&&c.terrain!==a.CLOUD&&this.renderTileBase(c);this.renderPaths();for(const c of this.tiles)(c.terrain===a.WATER||c.terrain===a.CLOUD)&&this.renderTileBase(c);for(const c of this.tiles)c.specialTerrain&&!c.abovePaths&&!kt.has(c.specialTerrain)&&this.renderSpecialTerrain(c);for(const c of this.tiles)c.treeOverlay&&!c.treeOverlay.abovePaths&&this.renderTreeOverlay(c);for(const c of this.tiles)c.specialTerrain&&c.abovePaths&&!kt.has(c.specialTerrain)&&this.renderSpecialTerrain(c);for(const c of this.tiles)c.treeOverlay&&c.treeOverlay.abovePaths&&this.renderTreeOverlay(c);for(const c of this.tiles)c.specialTerrain&&kt.has(c.specialTerrain)&&this.renderSpecialTerrain(c,!0),c.terrain===a.CUSTOM&&c.customTerrain&&this.renderCustomTerrain(c);this.renderGridNumbers(),this.ctx.restore()}renderCustomTerrain(t){if(!t.customTerrain)return;const{vertices:n}=t;this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++)this.ctx.lineTo(n[e].x,n[e].y);if(this.ctx.closePath(),t.customTerrain.type==="color")this.ctx.fillStyle=t.customTerrain.value,this.ctx.fill();else if(t.customTerrain.type==="image"){let e=this.customTerrainImages.get(t.customTerrain.value);if(!e){e=new Image,e.src=t.customTerrain.value,this.customTerrainImages.set(t.customTerrain.value,e),e.onload=()=>{this.render()},this.ctx.restore();return}if(e.complete){const i=Math.min(...n.map(x=>x.x)),s=Math.min(...n.map(x=>x.y)),o=Math.max(...n.map(x=>x.x)),r=Math.max(...n.map(x=>x.y)),c=o-i,h=r-s,l=i+c/2,d=s+h/2,g=Math.min(c,h)/2*1.9;this.ctx.clip();try{const x=e.width/e.height;let v,p;x>1?(v=g*2,p=v/x):(p=g*2,v=p*x),this.ctx.drawImage(e,l-v/2,d-p/2,v,p)}catch(x){console.error("Error drawing custom image terrain:",x)}}}t===this.hoveredTile&&(this.ctx.fillStyle="rgba(100, 149, 237, 0.3)",this.ctx.fill()),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1/this.zoom,this.ctx.stroke(),this.ctx.restore()}renderTileBase(t){if(t.terrain===a.CUSTOM)return;const{vertices:n}=t;this.ctx.beginPath(),this.ctx.moveTo(n[0].x,n[0].y);for(let i=1;i<n.length;i++)this.ctx.lineTo(n[i].x,n[i].y);this.ctx.closePath();const e=this.terrainTextures.get(t.terrain);if(e&&e.complete){this.ctx.save(),this.ctx.clip();const i=Math.min(...n.map(g=>g.x)),s=Math.min(...n.map(g=>g.y)),o=Math.max(...n.map(g=>g.x)),r=Math.max(...n.map(g=>g.y)),c=o-i,h=r-s,l=c/e.width,d=h/e.height;this.ctx.translate(i,s),this.ctx.scale(l,d),this.ctx.drawImage(e,0,0),this.ctx.restore()}else this.ctx.fillStyle=this.getTerrainColor(t.terrain),this.ctx.fill();t===this.hoveredTile&&(this.ctx.fillStyle="rgba(100, 149, 237, 0.3)",this.ctx.fill()),this.ctx.strokeStyle="#404040",this.ctx.lineWidth=1/this.zoom,this.ctx.stroke()}renderTreeOverlay(t){const{vertices:n}=t;if(!t.treeOverlay)return;const e=this.treeOverlayTextures.get(t.treeOverlay.type);if(e&&e.complete){this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(n[0].x,n[0].y);for(let g=1;g<n.length;g++)this.ctx.lineTo(n[g].x,n[g].y);this.ctx.closePath(),this.ctx.clip();const i=Math.min(...n.map(g=>g.x)),s=Math.min(...n.map(g=>g.y)),o=Math.max(...n.map(g=>g.x)),r=Math.max(...n.map(g=>g.y)),c=o-i,h=r-s,l=c/e.width,d=h/e.height;this.ctx.translate(i,s),this.ctx.scale(l,d),this.ctx.drawImage(e,0,0),this.ctx.restore()}}renderSpecialTerrain(t,n=!1){if(!t.specialTerrain)return;const e=this.terrainTextures.get(t.specialTerrain);if(!e||!e.complete)return;this.ctx.save();const{vertices:i}=t;if(!n){this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let x=1;x<i.length;x++)this.ctx.lineTo(i[x].x,i[x].y);this.ctx.closePath(),this.ctx.clip()}const s=Math.min(...i.map(x=>x.x)),o=Math.min(...i.map(x=>x.y)),r=Math.max(...i.map(x=>x.x)),c=Math.max(...i.map(x=>x.y)),h=r-s,l=c-o,d=h/e.width,g=l/e.height;this.ctx.translate(s,o),this.ctx.scale(d,g),this.ctx.drawImage(e,0,0),this.ctx.restore()}screenToMapCoordinates(t,n){return{x:(t-this.panX)/this.zoom,y:(n-this.panY)/this.zoom}}getZoom(){return this.zoom}getPanX(){return this.panX}getPanY(){return this.panY}getTiles(){return this.tiles}setZoom(t){this.zoom=t}setPanPosition(t,n){this.panX=t,this.panY=n}pan(t,n){this.panX+=t,this.panY+=n,this.render()}setHoveredTile(t){this.hoveredTile!==t&&(this.hoveredTile=t,this.render())}getPaths(){return this.paths}getTerrainTexture(t){return this.terrainTextures.get(t)}setTileTerrain(t,n,e){if(n===a.NONE){t.terrain=a.NONE,t.specialTerrain=void 0,t.customTerrain=void 0,delete t.treeOverlay,this.render();return}if(n===a.CUSTOM){t.terrain=n,t.customTerrain=e||{type:"color",value:"#FFFFFF"},t.specialTerrain=void 0,delete t.treeOverlay,this.render();return}if(Dt.has(n)){t.specialTerrain=n,delete t.treeOverlay,this.render();return}t.terrain=n,t.customTerrain=void 0,t.specialTerrain?delete t.treeOverlay:n===a.FOREST?t.treeOverlay={type:"forest",abovePaths:t.abovePaths??!1}:n===a.BOG?t.treeOverlay={type:"bog",abovePaths:t.abovePaths??!1}:delete t.treeOverlay,this.render()}getTreeOverlayTexture(t){return this.treeOverlayTextures.get(t)}preloadCustomTerrainImage(t){return new Promise((n,e)=>{if(this.customTerrainImages.has(t)){n();return}const i=new Image;i.onload=()=>{this.customTerrainImages.set(t,i),n()},i.onerror=s=>{console.error("Failed to load custom terrain image:",s),e(new Error("Failed to load custom terrain image"))},i.src=t})}setShowGridNumbers(t){this.showGridNumbers=t}renderGridNumbers(){if(!this.showGridNumbers)return;this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.font="14px Arial",this.ctx.fillStyle="#808080",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=this.tiles.map(r=>r.coord),n=Math.min(...t.map(r=>r.q)),e=Math.max(...t.map(r=>r.q)),i=Math.min(...t.map(r=>r.r)),s=Math.max(...t.map(r=>r.r)),o=this.tiles.filter(r=>r.coord.r===s);if(o.length>0){const c=(Math.max(...o.map(h=>h.center.y))+50)*this.zoom+this.panY;for(let h=n;h<=e;h++){const l=o.find(d=>d.coord.q===h);if(l){this.hoveredTile&&this.hoveredTile.coord.q===h?this.ctx.fillStyle="#ffffff":this.ctx.fillStyle="#808080";const d=l.center.x*this.zoom+this.panX;this.ctx.fillText(String(h+1),d,c)}}}for(let r=i;r<=s;r++){const c=this.tiles.find(h=>h.coord.r===r&&h.coord.q===n);if(c){this.hoveredTile&&this.hoveredTile.coord.r===r?this.ctx.fillStyle="#ffffff":this.ctx.fillStyle="#808080";const h=(c.center.x-60)*this.zoom+this.panX,l=c.center.y*this.zoom+this.panY;this.ctx.fillText(String(r+1),h,l)}}this.ctx.restore()}renderToContext(t,n=!1,e){const i=this.ctx;try{this.ctx=t,n||(this.ctx.fillStyle="#1e1e1e",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)),n||this.applyTransform();for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.terrain!==a.CUSTOM&&s.terrain!==a.WATER&&s.terrain!==a.CLOUD&&this.renderTileBase(s);this.renderPaths(n);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&(s.terrain===a.WATER||s.terrain===a.CLOUD)&&this.renderTileBase(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.specialTerrain&&!s.abovePaths&&!kt.has(s.specialTerrain)&&this.renderSpecialTerrain(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.treeOverlay&&!s.treeOverlay.abovePaths&&this.renderTreeOverlay(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.specialTerrain&&s.abovePaths&&!kt.has(s.specialTerrain)&&this.renderSpecialTerrain(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&s.treeOverlay&&s.treeOverlay.abovePaths&&this.renderTreeOverlay(s);for(const s of this.tiles)(!e||e.has(`${s.coord.q},${s.coord.r}`))&&(s.specialTerrain&&kt.has(s.specialTerrain)&&this.renderSpecialTerrain(s,!0),s.terrain===a.CUSTOM&&s.customTerrain&&this.renderCustomTerrain(s));n||this.renderGridNumbers(),n||this.ctx.restore()}finally{this.ctx=i}}getHoveredTile(){return this.hoveredTile}}class Xt{constructor(t){W(this,"selectedTerrain",a.NONE);W(this,"container");W(this,"onTerrainSelect",null);W(this,"drawMode","DRAW");W(this,"hasActiveSelection",!1);W(this,"drawAbovePaths",!1);W(this,"terrainPreviews",new Map);W(this,"previewSize",96);W(this,"mapRenderer");W(this,"customTerrainData",null);W(this,"customTerrainModal",null);W(this,"customPreviewCanvas");W(this,"onGridSizeChange",null);W(this,"cachedOverlays",new Map);this.mapRenderer=t,this.container=document.createElement("div"),this.container.className="toolbar-section",this.customPreviewCanvas=this.createPreviewCanvas(),this.drawHexagonPreview(this.customPreviewCanvas,"#ffffff"),this.loadTerrainTextures(),this.initializeUI(),this.preloadTreeOverlays(),this.mapRenderer.addTextureLoadCallback(()=>{this.updatePreviews()})}loadTerrainTextures(){const t=new Image;t.onload=()=>{const e=this.createPreviewCanvas();this.drawHexagonPreview(e,void 0,t),this.terrainPreviews.set(a.NONE,e);const i=this.findButtonForTerrain(a.NONE);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}},t.onerror=()=>{const e=this.createPreviewCanvas();this.drawHexagonPreview(e,"#FFFFFF"),this.terrainPreviews.set(a.NONE,e);const i=this.findButtonForTerrain(a.NONE);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}t.src.startsWith("/src/")&&(t.src="./src/assets/noterrain.png")},t.src="/src/assets/noterrain.png";const n={[a.GRASS]:"grass.png",[a.WATER]:"water.png",[a.FOREST]:"forest.png",[a.HILLS]:"hills.png",[a.MOUNTAIN]:"mountain.png",[a.IMPASSABLE]:"impassable.png",[a.CLOUD]:"cloud.png",[a.BOG]:"bog.png",[a.TOWN1]:"town1.png",[a.TOWN2]:"town2.png",[a.TOWN3]:"town3.png",[a.HARBOR]:"harbor.png",[a.SHIPS]:"ships.png",[a.LIGHTTOWER]:"lighttower.png",[a.TREE]:"tree.png",[a.MINE]:"mine.png"};Object.entries(n).forEach(([e,i])=>{const s=new Image;s.onload=()=>{const o=this.createPreviewCanvas();this.drawHexagonPreview(o,void 0,s),this.terrainPreviews.set(e,o);const r=this.findButtonForTerrain(e);if(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(o)}},s.onerror=()=>{const o=this.createPreviewCanvas();this.drawHexagonPreview(o,this.getTerrainColor(e)),this.terrainPreviews.set(e,o);const r=this.findButtonForTerrain(e);if(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(o)}s.src.startsWith("/src/")&&(s.src=`./src/assets/${i}`)},s.src=`/src/assets/${i}`})}updatePreviews(){[a.GRASS,a.WATER,a.HILLS,a.MOUNTAIN,a.IMPASSABLE,a.CLOUD].forEach(t=>{const n=this.mapRenderer.getTerrainTexture(t);if(n&&n.complete){const e=this.createPreviewCanvas();this.drawHexagonPreview(e,void 0,n);const i=this.findButtonForTerrain(t);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.appendChild(e)}this.terrainPreviews.set(t,e)}}),this.updateTerrainWithOverlay(a.FOREST,"forest"),this.updateTerrainWithOverlay(a.BOG,"bog")}preloadTreeOverlays(){const t=i=>{if(window.location.hostname.includes("github.io")){const o=window.location.pathname.split("/");return`/${o.length>1?o[1]:""}/src/assets/${i}`}else return`/src/assets/${i}`},n=new Image;n.onload=()=>{this.cachedOverlays.set("forest",n),this.updateTerrainWithOverlay(a.FOREST,"forest")},n.onerror=()=>{n.src.startsWith("/src/")&&(n.src="./src/assets/foresttrees.png")},n.src=t("foresttrees.png");const e=new Image;e.onload=()=>{this.cachedOverlays.set("bog",e),this.updateTerrainWithOverlay(a.BOG,"bog")},e.onerror=()=>{e.src.startsWith("/src/")&&(e.src="./src/assets/bogtrees.png")},e.src=t("bogtrees.png")}updateTerrainWithOverlay(t,n){const e=this.mapRenderer.getTerrainTexture(t);let i=this.cachedOverlays.get(n)||this.mapRenderer.getTreeOverlayTexture(n);if(e&&e.complete&&i&&i.complete){const s=this.createPreviewCanvas();this.drawHexagonPreview(s,void 0,e,i);const o=this.findButtonForTerrain(t);if(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(s)}this.terrainPreviews.set(t,s)}else if(e&&e.complete){const s=this.createPreviewCanvas();this.drawHexagonPreview(s,void 0,e);const o=this.findButtonForTerrain(t);o&&(o.firstChild||o.appendChild(s))}}findButtonForTerrain(t){const n=this.container.querySelectorAll(".terrain-button");for(const e of n){const i=e;if(i.title===this.getTerrainLabel(t))return i}return null}createPreviewCanvas(){const t=document.createElement("canvas");return t.width=this.previewSize,t.height=this.previewSize,t}drawHexagonPreview(t,n,e,i){const s=t.getContext("2d");if(!s)return;s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";const o=this.previewSize,r=o*.45,c={x:o/2,y:o/2},h=[];for(let l=0;l<6;l++){const d=Math.PI/3*l;h.push({x:c.x+r*Math.cos(d),y:c.y+r*Math.sin(d)})}s.beginPath(),s.moveTo(h[0].x,h[0].y);for(let l=1;l<h.length;l++)s.lineTo(h[l].x,h[l].y);if(s.closePath(),e){s.save(),s.clip();const l=Math.min(...h.map(w=>w.x)),d=Math.min(...h.map(w=>w.y)),g=Math.max(...h.map(w=>w.x)),x=Math.max(...h.map(w=>w.y)),v=g-l,p=x-d,u=Math.min(v/e.width,p/e.height),b=e.width*u,C=e.height*u;if(s.drawImage(e,c.x-b/2,c.y-C/2,b,C),i){const w=Math.min(v/i.width,p/i.height),et=i.width*w,U=i.height*w;s.drawImage(i,c.x-et/2,c.y-U/2,et,U)}s.restore()}else n&&(s.fillStyle=n,s.fill());s.strokeStyle="#404040",s.lineWidth=1.5,s.stroke()}getElement(){return this.container}setTerrainSelectCallback(t){this.onTerrainSelect=t}deselectAll(){this.hasActiveSelection=!1,this.container.querySelectorAll(".terrain-button").forEach(n=>{n.classList.remove("selected")})}setGridSizeChangeCallback(t){this.onGridSizeChange=t}initializeUI(){const t=document.createElement("h2");t.textContent="Grid Size",this.container.appendChild(t);const n=document.createElement("div");n.className="toolbar-section";const e=document.createElement("div");e.style.display="grid",e.style.gridTemplateRows="auto auto auto",e.style.gap="4px",e.style.justifyContent="center";const i=G=>{const k=document.createElement("button");return k.style.width="24px",k.style.height="24px",k.style.padding="0",k.style.display="flex",k.style.alignItems="center",k.style.justifyContent="center",k.style.background="#2d2d2d",k.style.border="1px solid #404040",k.style.color=G.includes("+")?"#4CAF50":"#f44336",k.style.cursor="pointer",k.style.borderRadius="4px",k.style.fontSize="16px",k.style.lineHeight="1",k.style.transition="background-color 0.2s ease",k.addEventListener("mouseover",()=>{k.style.background="#3d3d3d"}),k.addEventListener("mouseout",()=>{k.style.background="#2d2d2d"}),k.innerHTML=G.includes("+")?"+":"-",k.addEventListener("click",()=>{this.onGridSizeChange&&this.onGridSizeChange(G)}),k},s=document.createElement("div");s.className="grid-size-info",s.style.color="#e0e0e0",s.style.fontSize="14px",s.style.margin="0 4px",s.style.textAlign="center",s.textContent="35x20";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="center",o.style.gap="4px";const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="4px";const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="center",c.style.gap="4px",o.appendChild(i("row-top")),o.appendChild(i("row+top")),r.appendChild(i("col-left")),r.appendChild(i("col+left")),r.appendChild(s),r.appendChild(i("col-right")),r.appendChild(i("col+right")),c.appendChild(i("row-bottom")),c.appendChild(i("row+bottom")),e.appendChild(o),e.appendChild(r),e.appendChild(c),n.appendChild(e),this.container.appendChild(n);const h=document.createElement("h2");h.textContent="Terrain",this.container.appendChild(h);const l=document.createElement("div");l.className="mode-selector";const d=document.createElement("button");d.textContent="Draw",d.className="mode-button selected",d.addEventListener("click",()=>this.setDrawMode("DRAW",d,g));const g=document.createElement("button");g.textContent="Fill",g.className="mode-button",g.addEventListener("click",()=>this.setDrawMode("FILL",d,g)),l.appendChild(d),l.appendChild(g),this.container.appendChild(l);const x=document.createElement("div");x.className="layer-control";const v=document.createElement("label");v.textContent="Above Routes",v.htmlFor="layer-toggle";const p=document.createElement("div");p.className="toggle-switch";const u=document.createElement("input");u.type="checkbox",u.id="layer-toggle",u.checked=this.drawAbovePaths;const b=document.createElement("span");b.className="toggle-slider";const C=()=>{this.drawAbovePaths=u.checked};u.addEventListener("change",C),p.addEventListener("click",G=>{G.preventDefault(),u.checked=!u.checked,C()}),v.addEventListener("click",G=>{G.preventDefault(),u.checked=!u.checked,C()}),p.appendChild(u),p.appendChild(b),x.appendChild(v),x.appendChild(p),this.container.appendChild(x);const w=[{type:a.NONE,tooltip:"Remove Terrain"},{type:a.WATER,tooltip:"Water"},{type:a.GRASS,tooltip:"Grass"},{type:a.FOREST,tooltip:"Forest"},{type:a.BOG,tooltip:"Bog"},{type:a.HILLS,tooltip:"Hills"},{type:a.MOUNTAIN,tooltip:"Mountain"},{type:a.IMPASSABLE,tooltip:"Impassable"},{type:a.CLOUD,tooltip:"Cloud"}],et=[{type:a.TOWN1,tooltip:"Town 1"},{type:a.TOWN2,tooltip:"Town 2"},{type:a.TOWN3,tooltip:"Town 3"},{type:a.HARBOR,tooltip:"Harbor"},{type:a.SHIPS,tooltip:"Ships"},{type:a.LIGHTTOWER,tooltip:"Lighttower"},{type:a.TREE,tooltip:"Tree"},{type:a.MINE,tooltip:"Cave / Mine"}],U=document.createElement("div");U.className="terrain-button-container",this.container.appendChild(U);const B=document.createElement("button");B.className="terrain-button",B.title="Remove Terrain";const Q=this.terrainPreviews.get(a.NONE);Q&&B.appendChild(Q),B.addEventListener("click",()=>this.selectTerrain(a.NONE)),U.appendChild(B);const y=document.createElement("button");y.className="terrain-button custom-terrain",y.title="Custom Terrain",y.appendChild(this.customPreviewCanvas),y.addEventListener("click",()=>{this.selectTerrain(a.CUSTOM)}),U.appendChild(y);const q=document.createElement("button");q.className="custom-terrain-edit",q.textContent="Edit Custom",q.title="Edit Custom Terrain",q.addEventListener("click",G=>{G.stopPropagation(),this.showCustomTerrainModal()}),U.appendChild(q);const $=document.createElement("div");$.className="storage-divider",$.style.gridColumn="1 / -1",U.appendChild($),w.slice(1).forEach(G=>{const k=document.createElement("button");k.className="terrain-button",k.title=G.tooltip;const gt=this.terrainPreviews.get(G.type);gt&&k.appendChild(gt),k.addEventListener("click",()=>this.selectTerrain(G.type)),U.appendChild(k)});const M=document.createElement("div");M.className="storage-divider",M.style.gridColumn="1 / -1",U.appendChild(M),et.forEach(G=>{const k=document.createElement("button");k.className="terrain-button",k.title=G.tooltip;const gt=this.terrainPreviews.get(G.type);gt&&k.appendChild(gt),k.addEventListener("click",()=>this.selectTerrain(G.type)),U.appendChild(k)})}selectTerrain(t){(t!==this.selectedTerrain||!this.hasActiveSelection)&&(this.selectedTerrain=t,this.hasActiveSelection=!0,this.onTerrainSelect&&this.onTerrainSelect(),this.updateUI())}updateUI(){this.container.querySelectorAll(".terrain-button").forEach(n=>{const e=n;n.classList.toggle("selected",this.hasActiveSelection&&e.title===this.getTerrainLabel(this.selectedTerrain))})}getSelectedTerrain(){return this.selectedTerrain}getCustomTerrainData(){return this.selectedTerrain===a.CUSTOM?this.customTerrainData:null}isTerrainSelected(){return this.hasActiveSelection}getTerrainLabel(t){return{[a.NONE]:"Remove Terrain",[a.WATER]:"Water",[a.GRASS]:"Grass",[a.FOREST]:"Forest",[a.BOG]:"Bog",[a.HILLS]:"Hills",[a.MOUNTAIN]:"Mountain",[a.IMPASSABLE]:"Impassable",[a.CLOUD]:"Cloud",[a.TOWN1]:"Town 1",[a.TOWN2]:"Town 2",[a.TOWN3]:"Town 3",[a.HARBOR]:"Harbor",[a.SHIPS]:"Ships",[a.LIGHTTOWER]:"Lighttower",[a.TREE]:"Tree",[a.MINE]:"Cave / Mine",[a.CUSTOM]:"Custom Terrain"}[t]||t}setDrawMode(t,n,e){this.drawMode=t,n.classList.toggle("selected",t==="DRAW"),e.classList.toggle("selected",t==="FILL")}getDrawMode(){return this.drawMode}isDrawAbovePaths(){return this.drawAbovePaths}getTerrainColor(t){switch(t){case a.WATER:return"#4B9CD3";case a.GRASS:return"#90EE90";case a.FOREST:return"#228B22";case a.BOG:return"#006400";case a.HILLS:return"#D2B48C";case a.MOUNTAIN:return"#808080";case a.IMPASSABLE:return"#4A4A4A";case a.CLOUD:return"rgba(200, 200, 200, 0.5)";case a.TOWN1:return"#DEB887";case a.TOWN2:return"#8B4513";case a.TOWN3:return"#A0522D";case a.HARBOR:return"#5DADE2";case a.SHIPS:return"#4682B4";case a.LIGHTTOWER:return"#F5DEB3";case a.TREE:return"#2E8B57";case a.MINE:return"#696969";default:return"#FFFFFF"}}showCustomTerrainModal(){var mt;this.customTerrainModal&&(document.body.removeChild(this.customTerrainModal),this.customTerrainModal=null);const t=document.createElement("div");t.className="modal-backdrop",document.body.appendChild(t);const n=document.createElement("div");n.className="custom-terrain-modal";const e=document.createElement("button");e.className="modal-close-button",e.innerHTML="×",n.appendChild(e);const i=document.createElement("h3");i.textContent="Custom Terrain",n.appendChild(i);const s=document.createElement("div");s.className="custom-terrain-tabs";const o=document.createElement("button");o.className="custom-terrain-tab active",o.textContent="Image";const r=document.createElement("button");r.className="custom-terrain-tab",r.textContent="Color",s.appendChild(o),s.appendChild(r),n.appendChild(s);const c=document.createElement("div");c.className="custom-terrain-content";const h=document.createElement("div");h.className="color-picker-section",h.style.display="none";const l=document.createElement("div");l.className="color-picker-container";const d=document.createElement("input");d.type="color",d.className="color-picker-input",d.value=((mt=this.customTerrainData)==null?void 0:mt.type)==="color"?this.customTerrainData.value:"#ffffff";const g=document.createElement("canvas");g.className="color-hex-preview",g.width=200,g.height=200;const x=()=>{const T=g.getContext("2d");if(!T)return;T.clearRect(0,0,g.width,g.height);const F=g.width/2,Y=g.height/2,rt=Math.min(g.width,g.height)*.45;T.beginPath();for(let st=0;st<6;st++){const it=Math.PI/3*st,V=F+rt*Math.cos(it),j=Y+rt*Math.sin(it);st===0?T.moveTo(V,j):T.lineTo(V,j)}T.closePath(),T.fillStyle=d.value,T.fill(),T.strokeStyle="#404040",T.lineWidth=2,T.stroke()};d.addEventListener("input",x),x();const v=document.createElement("div");v.className="color-picker-tooltip",v.textContent="Click on the hexagon to change color",l.appendChild(g),l.appendChild(v),l.appendChild(d),h.appendChild(l);const p=document.createElement("div");p.className="image-upload-section",p.style.display="flex";const u=document.createElement("div");u.className="image-upload-area",u.innerHTML=`
            <div class="upload-icon">📁</div>
            <div class="upload-text">Click or drag an image here</div>
            <input type="file" accept="image/*" style="display: none;">
        `;const b=document.createElement("div");b.className="image-preview-container",b.style.display="none";const C=document.createElement("img");C.className="preview-image";const w=document.createElement("canvas");w.className="preview-hexagon-overlay",w.width=b.clientWidth||400,w.height=b.clientHeight||240,b.appendChild(C),b.appendChild(w);const et=document.createElement("div");et.className="image-controls",et.style.display="none";const U=document.createElement("button");U.className="image-control-button",U.textContent="Zoom In";const B=document.createElement("button");B.className="image-control-button",B.textContent="Zoom Out";const Q=document.createElement("button");Q.className="image-control-button",Q.textContent="Reset",et.appendChild(U),et.appendChild(B),et.appendChild(Q);let y={x:0,y:0,scale:1};u.addEventListener("click",()=>{q==null||q.click()}),u.addEventListener("dragover",T=>{T.preventDefault(),T.stopPropagation(),u.classList.add("drag-over")}),u.addEventListener("dragleave",T=>{T.preventDefault(),T.stopPropagation(),u.classList.remove("drag-over")}),u.addEventListener("drop",T=>{var F;if(T.preventDefault(),T.stopPropagation(),u.classList.remove("drag-over"),(F=T.dataTransfer)!=null&&F.files&&T.dataTransfer.files.length>0){const Y=T.dataTransfer.files[0];if(Y.type.startsWith("image/")){const rt=new FileReader;rt.onload=st=>{var it;(it=st.target)!=null&&it.result&&(C.src=st.target.result,C.onload=()=>{y={x:0,y:0,scale:1},xt()},b.style.display="block",et.style.display="flex")},rt.readAsDataURL(Y)}}});const q=u.querySelector("input");q&&q.addEventListener("change",T=>{const F=T.target;if(F.files&&F.files[0]){const Y=new FileReader;Y.onload=rt=>{var st;(st=rt.target)!=null&&st.result&&(C.src=rt.target.result,C.onload=()=>{y={x:0,y:0,scale:1},xt()},b.style.display="block",et.style.display="flex")},Y.readAsDataURL(F.files[0])}}),p.appendChild(u),p.appendChild(b),p.appendChild(et),c.appendChild(h),c.appendChild(p),n.appendChild(c);const $=document.createElement("div");$.className="modal-buttons";const M=document.createElement("button");M.className="modal-button primary",M.textContent="Apply";const G=document.createElement("button");G.className="modal-button secondary",G.textContent="Cancel",$.appendChild(M),$.appendChild(G),n.appendChild($),o.addEventListener("click",()=>{o.classList.add("active"),r.classList.remove("active"),p.style.display="flex",h.style.display="none"}),r.addEventListener("click",()=>{r.classList.add("active"),o.classList.remove("active"),h.style.display="flex",p.style.display="none"});let k=!1,gt=0,bt=0;b.addEventListener("mousedown",T=>{k=!0,gt=T.clientX-y.x,bt=T.clientY-y.y,b.style.cursor="grabbing"}),document.addEventListener("mousemove",T=>{k&&(y.x=T.clientX-gt,y.y=T.clientY-bt,xt())}),document.addEventListener("mouseup",()=>{k=!1,b.style.cursor="grab"}),U.addEventListener("click",()=>{y.scale*=1.1,xt()}),B.addEventListener("click",()=>{y.scale*=.9,xt()}),Q.addEventListener("click",()=>{y={x:0,y:0,scale:1},xt()});function xt(){const T=w.getContext("2d");if(!T)return;const F=b.getBoundingClientRect();(w.width!==F.width||w.height!==F.height)&&(w.width=F.width,w.height=F.height),T.clearRect(0,0,w.width,w.height);const Y=w.width/2,rt=w.height/2,st=Math.min(w.width,w.height)*.45,it=document.createElement("canvas");it.width=w.width,it.height=w.height;const V=it.getContext("2d");if(V){V.beginPath();for(let j=0;j<6;j++){const ht=Math.PI/3*j,dt=Y+st*Math.cos(ht),ct=rt+st*Math.sin(ht);j===0?V.moveTo(dt,ct):V.lineTo(dt,ct)}if(V.closePath(),V.save(),V.clip(),C.complete){const j=y.scale,ht=y.x,dt=y.y,ct=C.naturalWidth/C.naturalHeight;let ft,at;const yt=st*1.6;ct>1?(ft=yt*2,at=ft/ct):(at=yt*2,ft=at*ct),V.translate(Y,rt),V.scale(j,j),V.translate(ht/j,dt/j),V.drawImage(C,-ft/2,-at/2,ft,at),V.restore()}T.drawImage(it,0,0),T.beginPath();for(let j=0;j<6;j++){const ht=Math.PI/3*j,dt=Y+st*Math.cos(ht),ct=rt+st*Math.sin(ht);j===0?T.moveTo(dt,ct):T.lineTo(dt,ct)}T.closePath(),T.strokeStyle="rgba(255, 255, 255, 0.8)",T.lineWidth=2,T.stroke()}}const pt=()=>{document.body.removeChild(t),document.body.removeChild(n),this.customTerrainModal=null};G.addEventListener("click",pt),e.addEventListener("click",pt),t.addEventListener("click",T=>{T.target===t&&pt()}),b.addEventListener("wheel",T=>{T.preventDefault();const F=T.deltaY>0?.9:1.1;y.scale*=F,xt()}),M.addEventListener("click",()=>{if(r.classList.contains("active"))this.customTerrainData={type:"color",value:d.value};else if(C.src){const T=document.createElement("canvas"),F=b.getBoundingClientRect();T.width=F.width,T.height=F.height;const Y=T.getContext("2d");if(!Y)return;const rt=T.width/2,st=T.height/2,it=Math.min(T.width,T.height)*.45;Y.beginPath();for(let ct=0;ct<6;ct++){const ft=Math.PI/3*ct,at=rt+it*Math.cos(ft),yt=st+it*Math.sin(ft);ct===0?Y.moveTo(at,yt):Y.lineTo(at,yt)}Y.closePath(),Y.clip();const V=C.naturalWidth/C.naturalHeight;let j,ht;const dt=it*1.6;V>1?(j=dt*2,ht=j/V):(ht=dt*2,j=ht*V),Y.translate(rt,st),Y.scale(y.scale,y.scale),Y.translate(y.x/y.scale,y.y/y.scale),Y.drawImage(C,-j/2,-ht/2,j,ht),this.customTerrainData={type:"image",value:T.toDataURL(),imagePosition:{x:0,y:0,scale:1}}}this.updateCustomPreview(),pt(),this.selectedTerrain=a.CUSTOM,this.hasActiveSelection=!0,this.updateUI(),this.onTerrainSelect&&this.onTerrainSelect()}),document.body.appendChild(n),this.customTerrainModal=n}updateCustomPreview(){if(!this.customTerrainData)return;const t=this.createPreviewCanvas(),n=t.getContext("2d");if(!n)return;n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high";const e=t.width/2,i=t.height/2,s=t.width*.45;n.beginPath();for(let r=0;r<6;r++){const c=Math.PI/3*r,h=e+s*Math.cos(c),l=i+s*Math.sin(c);r===0?n.moveTo(h,l):n.lineTo(h,l)}if(n.closePath(),this.customTerrainData.type==="color")n.fillStyle=this.customTerrainData.value,n.fill();else if(this.customTerrainData.type==="image"){n.save(),n.clip();const r=new Image;r.onload=()=>{try{const c=r.width/r.height;let h,l;const d=s*1.6;c>1?(h=d*2,l=h/c):(l=d*2,h=l*c),n.drawImage(r,e-h/2,i-l/2,h,l),n.restore(),n.strokeStyle="#404040",n.lineWidth=1.5,n.stroke();const g=this.findButtonForTerrain(a.CUSTOM);if(g){for(;g.firstChild;)g.removeChild(g.firstChild);g.appendChild(t)}this.terrainPreviews.set(a.CUSTOM,t),this.customPreviewCanvas=t}catch(c){console.error("Error drawing custom image preview:",c),n.restore()}},r.src=this.customTerrainData.value;return}n.strokeStyle="#404040",n.lineWidth=1.5,n.stroke();const o=this.findButtonForTerrain(a.CUSTOM);if(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.appendChild(t)}this.terrainPreviews.set(a.CUSTOM,t),this.customPreviewCanvas=t}updateGridDimensions(t,n){const e=this.container.querySelector(".grid-size-info");e&&(e.textContent=`${t}x${n}`)}}const Bt={MAJOR:1,MINOR:0},qt="RQM2";class jt{constructor(t){W(this,"renderer");this.renderer=t}createExportCanvas(){let t=1/0,n=-1/0,e=1/0,i=-1/0;const s=new Set;if(this.renderer.getTiles().forEach(b=>{(b.terrain!==a.NONE||b.specialTerrain!==void 0)&&s.add(`${b.coord.q},${b.coord.r}`)}),this.renderer.getPaths().forEach(b=>{b.points.forEach(C=>{const w=this.renderer.getTiles().find(et=>{const U=et.vertices;let B=!1;for(let Q=0,y=U.length-1;Q<U.length;y=Q++){const q=U[Q].x,$=U[Q].y,M=U[y].x,G=U[y].y;$>C.y!=G>C.y&&C.x<(M-q)*(C.y-$)/(G-$)+q&&(B=!B)}return B});w&&s.add(`${w.coord.q},${w.coord.r}`)})}),s.forEach(b=>{const[C,w]=b.split(",").map(Number);t=Math.min(t,C),n=Math.max(n,C),e=Math.min(e,w),i=Math.max(i,w)}),t===1/0||s.size===0)throw new Error("No content to export!");this.renderer.getTiles().forEach(b=>{b.coord.q>=t&&b.coord.q<=n&&b.coord.r>=e&&b.coord.r<=i&&s.add(`${b.coord.q},${b.coord.r}`)});let r=1/0,c=1/0,h=-1/0,l=-1/0;this.renderer.getTiles().forEach(b=>{s.has(`${b.coord.q},${b.coord.r}`)&&b.vertices.forEach(C=>{r=Math.min(r,C.x),c=Math.min(c,C.y),h=Math.max(h,C.x),l=Math.max(l,C.y)})});const d=document.createElement("canvas"),g=4;d.width=(h-r)*g,d.height=(l-c)*g;const x=d.getContext("2d",{alpha:!0});if(!x)throw new Error("Failed to get export canvas context");x.imageSmoothingEnabled=!0,x.imageSmoothingQuality="high",x.clearRect(0,0,d.width,d.height);const v=this.renderer.getZoom(),p=this.renderer.getPanX(),u=this.renderer.getPanY();try{x.scale(g,g),x.translate(-r,-c),this.renderer.setZoom(1),this.renderer.setPanPosition(0,0),this.renderer.renderToContext(x,!0,s)}finally{this.renderer.setZoom(v),this.renderer.setPanPosition(p,u)}return d}createExportButtons(){const t=document.createElement("div");t.className="export-buttons-container";const n=document.createElement("h2");n.textContent="Map Data",t.appendChild(n);const e=document.createElement("div");e.className="button-group storage-buttons";const i=document.createElement("div");i.className="export-buttons-row storage-buttons-row";const s=document.createElement("button");s.className="export-button png-export-button",s.textContent="Save PNG",s.addEventListener("click",()=>this.exportToPNG()),i.appendChild(s);const o=document.createElement("button");o.className="export-button dat-export-button",o.textContent="Save DAT",o.addEventListener("click",()=>this.saveToBinary()),i.appendChild(o);const r=document.createElement("button");r.className="export-button",r.textContent="Load DAT",r.addEventListener("click",()=>this.loadFromBinary()),i.appendChild(r),e.appendChild(i);const c=document.createElement("div");c.className="storage-divider";const h=document.createElement("div");h.className="export-buttons-row storage-buttons-row";const l=document.createElement("button");return l.className="export-button reset-button",l.textContent="Reset Map",l.addEventListener("click",()=>this.showResetConfirmation()),h.appendChild(l),e.appendChild(c),e.appendChild(h),t.appendChild(e),t}showExportPreview(t){const n=document.createElement("div");n.className="modal-backdrop",document.body.appendChild(n);const e=document.createElement("div");e.className="export-preview-modal";const i=document.createElement("button");i.className="modal-close-button",i.innerHTML="×",e.appendChild(i);const s=document.createElement("h3");s.textContent="Preview",e.appendChild(s);const o=document.createElement("div");o.className="export-preview-container";const r=document.createElement("canvas"),c=800,h=600,l=c/t.width,d=h/t.height,g=Math.min(l,d,1);r.width=t.width*g,r.height=t.height*g;const x=r.getContext("2d");x&&(x.imageSmoothingEnabled=!0,x.imageSmoothingQuality="high",x.drawImage(t,0,0,r.width,r.height)),o.appendChild(r),e.appendChild(o);const v=document.createElement("div");v.className="export-controls-container";const p=document.createElement("div");p.className="compass-control";const u=document.createElement("label");u.textContent="Add Compass",u.htmlFor="compass-toggle",u.style.cursor="pointer";const b=document.createElement("div");b.className="toggle-switch",b.style.cursor="pointer";const C=document.createElement("input");C.type="checkbox",C.id="compass-toggle";const w=document.createElement("span");w.className="toggle-slider",b.appendChild(C),b.appendChild(w);const et=document.createElement("div");et.className="compass-size-control",et.style.display="none";const U=document.createElement("label");U.textContent="Change Size",U.style.marginLeft="24px",U.style.marginRight="8px";const B=document.createElement("input");B.type="range",B.min="5",B.max="50",B.value="25",B.className="size-slider",B.style.width="100px",et.appendChild(U),et.appendChild(B);const Q=document.createElement("div");Q.className="compass-tooltip",Q.textContent="Click and drag to move the compass";const y=document.createElement("div");y.className="timer";const q=document.createElementNS("http://www.w3.org/2000/svg","svg");q.setAttribute("class","timer-circle"),q.setAttribute("viewBox","0 0 24 24");const $=document.createElementNS("http://www.w3.org/2000/svg","circle");$.setAttribute("cx","12"),$.setAttribute("cy","12"),$.setAttribute("r","10");const M=document.createElementNS("http://www.w3.org/2000/svg","circle");M.setAttribute("class","progress"),M.setAttribute("cx","12"),M.setAttribute("cy","12"),M.setAttribute("r","10"),q.appendChild($),q.appendChild(M);const G=document.createElement("div");G.className="timer-text",y.appendChild(q),y.appendChild(G);const k=document.createElement("button");k.className="close-tooltip",k.innerHTML="×",k.addEventListener("click",D=>{D.stopPropagation(),gt()}),Q.appendChild(y),Q.appendChild(k);function gt(){Q.parentNode&&Q.parentNode.removeChild(Q)}function bt(D,Z){const J=2*Math.PI*10,ut=J-D/Z*J;M.style.strokeDashoffset=`${ut}`,G.textContent=`${D}`}function xt(D){let Z=D;y.style.display="flex",bt(Z,D);const J=setInterval(()=>{Z--,bt(Z,D),Z<=0&&(clearInterval(J),gt())},1e3);return J}[u,b,w].forEach(D=>{D.addEventListener("click",Z=>{Z.stopPropagation(),C.checked=!C.checked,C.dispatchEvent(new Event("change"))})}),p.appendChild(u),p.appendChild(b),p.appendChild(et);const pt=document.createElement("div");pt.className="export-dimensions-info",pt.textContent=`Image dimensions: ${t.width}×${t.height} pixels | Calculating size...`,t.toBlob(D=>{if(D){const Z=D.size;let J;Z>1048576?J=(Z/1048576).toFixed(2)+" MB":Z>1024?J=(Z/1024).toFixed(1)+" KB":J=Z+" bytes",pt.textContent=`Image dimensions: ${t.width}×${t.height} pixels | Estimated size: ${J}`}else pt.textContent=`Image dimensions: ${t.width}×${t.height} pixels`},"image/png"),v.appendChild(p),v.appendChild(pt),e.appendChild(v);const mt=new Image;mt.src="./src/assets/compass.png";let T=0,F=0,Y=!1,rt=0,st=0;mt.onload=()=>{C.disabled=!1},mt.onerror=()=>{mt.src="/src/assets/compass.png"};let it=!1,V=null;C.addEventListener("change",()=>{if(it=C.checked,et.style.display=it?"flex":"none",r.classList.toggle("compass-active",it),it){if(T===0&&F===0){const D=Math.min(r.width,r.height)*(parseInt(B.value)/100);T=r.width-D-r.width*.2,F=r.height*.2}o.appendChild(Q),Q.classList.add("visible"),V&&clearInterval(V),V=xt(5)}else gt(),V&&(clearInterval(V),V=null);dt(),ht()});let j=null;B.addEventListener("input",()=>{dt(),j!==null&&clearTimeout(j),j=window.setTimeout(()=>{ht(),j=null},300)}),B.addEventListener("change",()=>{j!==null&&(clearTimeout(j),j=null),ht()});function ht(){const D=document.createElement("canvas");D.width=t.width,D.height=t.height;const Z=D.getContext("2d");if(Z){if(Z.drawImage(t,0,0),it&&mt.complete){const J=t.width/r.width,ut=Math.min(D.width,D.height)*(parseInt(B.value)/100);Z.drawImage(mt,T*J,F*J,ut,ut)}D.toBlob(J=>{if(J){const ut=J.size;let Tt;ut>1048576?Tt=(ut/1048576).toFixed(2)+" MB":ut>1024?Tt=(ut/1024).toFixed(1)+" KB":Tt=ut+" bytes",pt.textContent=`Image dimensions: ${t.width}×${t.height} pixels | Estimated size: ${Tt}`}},"image/png")}}pt.textContent=`Image dimensions: ${t.width}×${t.height} pixels | Calculating size...`,ht(),r.addEventListener("mousedown",D=>{if(!it)return;const Z=r.getBoundingClientRect(),J=D.clientX-Z.left,ut=D.clientY-Z.top,Tt=Math.min(r.width,r.height)*(parseInt(B.value)/100);J>=T&&J<=T+Tt&&ut>=F&&ut<=F+Tt&&(Y=!0,rt=J-T,st=ut-F,r.style.cursor="grabbing")}),r.addEventListener("mousemove",D=>{if(!Y)return;const Z=r.getBoundingClientRect(),J=D.clientX-Z.left,ut=D.clientY-Z.top;T=J-rt,F=ut-st;const Tt=Math.min(r.width,r.height)*(parseInt(B.value)/100);T=Math.max(0,Math.min(r.width-Tt,T)),F=Math.max(0,Math.min(r.height-Tt,F)),dt()}),r.addEventListener("mouseup",()=>{Y=!1,r.style.cursor=it?"grab":"default"}),r.addEventListener("mouseleave",()=>{Y=!1,r.style.cursor=it?"grab":"default"});function dt(){const D=r.getContext("2d");if(D&&(D.clearRect(0,0,r.width,r.height),D.drawImage(t,0,0,r.width,r.height),it&&mt.complete)){const Z=Math.min(r.width,r.height)*(parseInt(B.value)/100);D.drawImage(mt,T,F,Z,Z)}}const ct=document.createElement("div");ct.className="modal-buttons";const ft=document.createElement("button");ft.className="modal-button primary",ft.textContent="Save PNG";const at=document.createElement("button");at.className="modal-button secondary",at.textContent="Cancel",ct.appendChild(ft),ct.appendChild(at),e.appendChild(ct);const yt=()=>{document.body.removeChild(n),document.body.removeChild(e)};at.addEventListener("click",yt),i.addEventListener("click",yt),n.addEventListener("click",D=>{D.target===n&&yt()}),ft.addEventListener("click",()=>{yt();const D=document.createElement("canvas");D.width=t.width,D.height=t.height;const Z=D.getContext("2d");if(!Z)return;if(Z.drawImage(t,0,0),it&&mt.complete){const ut=t.width/r.width,Tt=Math.min(D.width,D.height)*(parseInt(B.value)/100);Z.drawImage(mt,T*ut,F*ut,Tt,Tt)}const J=document.createElement("a");J.download="map.png",J.href=D.toDataURL("image/png",1),J.click()}),document.body.appendChild(e)}showResetConfirmation(){const t=document.createElement("div");t.className="modal-backdrop",document.body.appendChild(t);const n=document.createElement("div");n.className="custom-terrain-modal";const e=document.createElement("button");e.className="modal-close-button",e.innerHTML="×",n.appendChild(e);const i=document.createElement("h3");i.textContent="Reset Map",n.appendChild(i);const s=document.createElement("div");s.style.textAlign="center",s.style.marginTop="20px",s.style.marginBottom="30px",s.textContent="Are you sure you want to reset the map?",s.style.whiteSpace="pre-line",n.appendChild(s);const o=document.createElement("div");o.className="modal-buttons";const r=document.createElement("button");r.className="modal-button reset-button",r.textContent="Reset";const c=document.createElement("button");c.className="modal-button secondary",c.textContent="Cancel",o.appendChild(r),o.appendChild(c),n.appendChild(o);const h=()=>{document.body.removeChild(t),document.body.removeChild(n)};c.addEventListener("click",h),e.addEventListener("click",h),t.addEventListener("click",l=>{l.target===t&&h()}),r.addEventListener("click",()=>{const l=new CustomEvent("maploaded",{detail:{dimensions:{columns:35,rows:20},totalLeftOperations:0,tiles:[],paths:[]}});document.dispatchEvent(l),h()}),document.body.appendChild(n)}exportToPNG(){const t=this.renderer.getHoveredTile();this.renderer.setHoveredTile(null);const n=this.createExportCanvas();this.showExportPreview(n),this.renderer.setHoveredTile(t)}async saveToBinary(){try{const t=this.renderer.getTiles(),n=this.renderer.getPaths(),e=this.serializeMapToBinary(t,n),i=new Blob([e],{type:"application/octet-stream"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download="map-data.dat",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}catch(t){console.error("Failed to save binary map:",t),alert("Failed to save map. See console for details.")}}async loadFromBinary(){try{const t=document.createElement("input");t.type="file",t.accept=".dat",t.onchange=async n=>{var s;const e=(s=n.target.files)==null?void 0:s[0];if(!e)return;const i=await e.arrayBuffer();try{console.log("Starting map load process...");const o=this.deserializeMapFromBinary(i);console.log("Loaded map data:",{dimensions:o.dimensions,totalLeftOperations:o.totalLeftOperations,tileCount:o.tiles.length,pathCount:o.paths.length});const r=30;console.log("Using hex size:",r);const c=r*2*3/4,h=r*Math.sqrt(3),l=Math.ceil(o.dimensions.columns*c),d=Math.ceil(o.dimensions.rows*h);console.log("Calculated grid dimensions:",{width:l,height:d});const g=new Ot(r,l,d);console.log("Generating base grid with totalLeftOperations:",o.totalLeftOperations);const x=g.generateGrid(o.totalLeftOperations);console.log("Base grid generated:",{tileCount:x.length,sampleTile:x[0],bounds:this.calculateGridBounds(x)});const v=new Map,p=new Map;o.tiles.forEach(y=>{v.set(`${y.coord.q},${y.coord.r}`,y)}),x.forEach(y=>{p.set(`${y.coord.q},${y.coord.r}`,y)}),console.log("Created lookup maps:",{loadedTiles:v.size,baseGridTiles:p.size}),console.log("Starting tile reconstruction...");const u=x.map(y=>{const q=`${y.coord.q},${y.coord.r}`,$=v.get(q);if(!$)return y;const M={...y,terrain:$.terrain,specialTerrain:$.specialTerrain,customTerrain:$.customTerrain,treeOverlay:$.treeOverlay,abovePaths:$.abovePaths};return y.coord.q<2&&y.coord.r<2&&console.log(`Tile at (${y.coord.q}, ${y.coord.r}):`,{baseGeometry:{center:y.center,vertexCount:y.vertices.length},newGeometry:{center:M.center,vertexCount:M.vertices.length},terrain:M.terrain,specialTerrain:M.specialTerrain}),M});console.log("Tiles reconstructed:",{count:u.length,bounds:this.calculateGridBounds(u)});const b=-l/2,C=l/2,w=-d/2,et=d/2,U=new Map;u.forEach(y=>{U.set(`${Math.round(y.center.x)},${Math.round(y.center.y)}`,y.center)}),console.log("Starting path adjustment...");const B=o.paths.map((y,q)=>{const $={...y,points:y.points.map((M,G)=>{let k=M,gt=Number.MAX_VALUE;const bt=r*2,xt=Math.round(M.x-bt),pt=Math.round(M.x+bt),mt=Math.round(M.y-bt),T=Math.round(M.y+bt);for(let rt=xt;rt<=pt;rt+=r)for(let st=mt;st<=T;st+=r){const it=`${rt},${st}`,V=U.get(it);if(V){const j=V.x-M.x,ht=V.y-M.y,dt=j*j+ht*ht;dt<gt&&(gt=dt,k=V)}}let F=.5;G===0||G===y.points.length-1?F=.75:gt>r*r/4&&(F=.65);const Y={x:M.x+(k.x-M.x)*F,y:M.y+(k.y-M.y)*F};return Y.x=Math.max(b,Math.min(C,Y.x)),Y.y=Math.max(w,Math.min(et,Y.y)),q===0&&console.log(`Path point ${G} adjustment:`,{original:M,closest:k,adjusted:Y,distance:Math.sqrt(gt),factor:F}),Y}),smoothPoints:void 0};return q===0&&console.log("First path adjustment:",{originalPoints:y.points.length,adjustedPoints:$.points.length,type:y.type,width:y.width}),$});console.log("Paths adjusted:",{count:B.length,totalPoints:B.reduce((y,q)=>y+q.points.length,0)}),console.log("Updating renderer..."),this.renderer.setTiles(u),this.renderer.setPaths(B),console.log("Forcing render..."),this.renderer.render(),console.log("Dispatching maploaded event...");const Q=new CustomEvent("maploaded",{detail:{dimensions:o.dimensions,totalLeftOperations:o.totalLeftOperations,tiles:u,paths:B}});document.dispatchEvent(Q),console.log("Map load process completed.")}catch(o){console.error("Failed to parse binary map:",o),alert("Invalid or corrupted map file. See console for details.")}},t.click()}catch(t){console.error("Failed to load binary map:",t),alert("Failed to load map. See console for details.")}}createUniqueImageMap(t){var s;const n=new Set,e=new Map;for(const o of t)((s=o.customTerrain)==null?void 0:s.type)==="image"&&n.add(o.customTerrain.value);const i=Array.from(n);return i.forEach((o,r)=>{e.set(o,r)}),{imageMap:i,imageToIndex:e}}serializeMapToBinary(t,n){const{imageMap:e,imageToIndex:i}=this.createUniqueImageMap(t),s=new Map;t.forEach(u=>{if(u.customTerrain){const b={type:u.customTerrain.type,value:u.customTerrain.value};s.set(`${u.coord.q},${u.coord.r}`,b)}});let o=12+8+4,r=4;for(const u of e)r+=4+u.length;o+=r;let c=4;for(const u of t)c+=8+1+1,u.specialTerrain!==void 0&&(c+=1),u.customTerrain&&(c+=1,u.customTerrain.type==="color"?c+=4+u.customTerrain.value.length:c+=4),u.treeOverlay&&(c+=2);o+=c+this.calculatePathsSize(n);const h=new ArrayBuffer(o),l=new DataView(h);let d=0;const g=new TextEncoder,x=g.encode(qt);for(let u=0;u<4;u++)l.setUint8(d++,x[u]);l.setUint16(d,Bt.MAJOR),d+=2,l.setUint16(d,Bt.MINOR),d+=2,l.setUint32(d,o),d+=4;const v=this.calculateGridDimensions(t);l.setUint32(d,v.rows),d+=4,l.setUint32(d,v.columns),d+=4;const p=this.calculateTotalLeftOperations(t);l.setUint32(d,p),d+=4,l.setUint32(d,e.length),d+=4;for(const u of e){const b=g.encode(u);l.setUint32(d,b.length),d+=4,new Uint8Array(h,d,b.length).set(b),d+=b.length}l.setUint32(d,t.length),d+=4;for(const u of t){l.setInt32(d,u.coord.q),d+=4,l.setInt32(d,u.coord.r),d+=4,l.setUint8(d,this.terrainTypeToNumber(u.terrain)),d+=1;const b=(u.specialTerrain!==void 0?1:0)|(u.customTerrain!==void 0?2:0)|(u.treeOverlay!==void 0?4:0)|(u.abovePaths?8:0);if(l.setUint8(d,b),d+=1,u.specialTerrain!==void 0&&(l.setUint8(d,this.terrainTypeToNumber(u.specialTerrain)),d+=1),u.customTerrain)if(l.setUint8(d,u.customTerrain.type==="color"?0:1),d+=1,u.customTerrain.type==="color"){const C=g.encode(u.customTerrain.value);l.setUint32(d,C.length),d+=4,new Uint8Array(h,d,C.length).set(C),d+=C.length}else{const C=i.get(u.customTerrain.value)??0;l.setUint32(d,C),d+=4}u.treeOverlay&&(l.setUint8(d,u.treeOverlay.type==="forest"?0:1),d+=1,l.setUint8(d,u.treeOverlay.abovePaths?1:0),d+=1)}return this.writePathsToBuffer(l,d,n),h}deserializeMapFromBinary(t){const n=new DataView(t);let e=0;const i=new TextDecoder,s=new Uint8Array(t,0,4);if(i.decode(s)!==qt)throw new Error("Invalid map file format");e+=4;const r=n.getUint16(e);e+=2;const c=n.getUint16(e);if(e+=2,r>Bt.MAJOR||r===Bt.MAJOR&&c>Bt.MINOR)throw new Error("Unsupported map file version");const h=n.getUint32(e);if(e+=4,h!==t.byteLength)throw new Error("Corrupted map file");const l=n.getUint32(e);e+=4;const d=n.getUint32(e);e+=4;const g=n.getUint32(e);e+=4;const x=n.getUint32(e);e+=4;const v=[];for(let C=0;C<x;C++){const w=n.getUint32(e);e+=4;const et=new Uint8Array(t,e,w);v.push(i.decode(et)),e+=w}const p=[],u=n.getUint32(e);e+=4;for(let C=0;C<u;C++){const w=n.getInt32(e);e+=4;const et=n.getInt32(e);e+=4;const U=this.numberToTerrainType(n.getUint8(e));e+=1;const B=n.getUint8(e);e+=1;const Q={coord:{q:w,r:et},terrain:U,center:{x:0,y:0},vertices:[]};if(B&1&&(Q.specialTerrain=this.numberToTerrainType(n.getUint8(e)),e+=1),B&2){const y=n.getUint8(e)===0?"color":"image";if(e+=1,y==="color"){const q=n.getUint32(e);e+=4;const $=new Uint8Array(t,e,q);Q.customTerrain={type:"color",value:i.decode($)},e+=q}else{const q=n.getUint32(e);e+=4,Q.customTerrain={type:"image",value:v[q]}}}B&4&&(Q.treeOverlay={type:n.getUint8(e)===0?"forest":"bog",abovePaths:n.getUint8(e+1)===1},e+=2),B&8&&(Q.abovePaths=!0),p.push(Q)}const b=this.readPathsFromBuffer(n,e);return{tiles:p,paths:b,dimensions:{rows:l,columns:d},totalLeftOperations:g}}calculatePathsSize(t){let n=4;for(const e of t)n+=1+4+4+4+e.points.length*8;return n}writePathsToBuffer(t,n,e){let i=n;t.setUint32(i,e.length),i+=4;for(const s of e){t.setUint8(i,s.type==="PATH"?0:1),i+=1,t.setFloat32(i,s.width),i+=4,t.setUint32(i,this.parseColor(s.strokeStyle)),i+=4,t.setUint32(i,s.points.length),i+=4;for(const o of s.points)t.setFloat32(i,o.x),i+=4,t.setFloat32(i,o.y),i+=4}}readPathsFromBuffer(t,n){let e=n;const i=[],s=t.getUint32(e);e+=4;for(let o=0;o<s;o++){const r=t.getUint8(e)===0?"PATH":"RIVER";e+=1;const c=t.getFloat32(e);e+=4;const h=this.formatColor(t.getUint32(e));e+=4;const l=t.getUint32(e);e+=4;const d=[];for(let g=0;g<l;g++)d.push({x:t.getFloat32(e),y:t.getFloat32(e+4)}),e+=8;i.push({type:r,width:c,strokeStyle:h,points:d})}return i}calculateTotalLeftOperations(t){const n=t.filter(i=>i.coord.q===0),e=t.filter(i=>i.coord.q===1);if(n.length>0&&e.length>0){const i=n[0].center.y,s=e[0].center.y;return i>s?1:0}return 0}calculateGridDimensions(t){let n=1/0,e=-1/0,i=1/0,s=-1/0;for(const o of t)n=Math.min(n,o.coord.q),e=Math.max(e,o.coord.q),i=Math.min(i,o.coord.r),s=Math.max(s,o.coord.r);return{rows:s-i+1,columns:e-n+1}}terrainTypeToNumber(t){return Object.values(a).indexOf(t)}numberToTerrainType(t){return Object.values(a)[t]}parseColor(t){let n=0,e=0,i=0,s=255;if(t.startsWith("#")){const o=t.substring(1);n=parseInt(o.substring(0,2),16),e=parseInt(o.substring(2,4),16),i=parseInt(o.substring(4,6),16),o.length===8&&(s=parseInt(o.substring(6,8),16))}else if(t.startsWith("rgba")){const o=t.substring(5,t.length-1).split(",");n=parseInt(o[0]),e=parseInt(o[1]),i=parseInt(o[2]),s=Math.round(parseFloat(o[3])*255)}else if(t.startsWith("rgb")){const o=t.substring(4,t.length-1).split(",");n=parseInt(o[0]),e=parseInt(o[1]),i=parseInt(o[2])}return n<<24|e<<16|i<<8|s}formatColor(t){const n=t>>24&255,e=t>>16&255,i=t>>8&255,s=(t&255)/255;return`rgba(${n},${e},${i},${s})`}calculateGridBounds(t){const n={x:{min:1/0,max:-1/0},y:{min:1/0,max:-1/0},q:{min:1/0,max:-1/0},r:{min:1/0,max:-1/0}};return t.forEach(e=>{n.x.min=Math.min(n.x.min,e.center.x),n.x.max=Math.max(n.x.max,e.center.x),n.y.min=Math.min(n.y.min,e.center.y),n.y.max=Math.max(n.y.max,e.center.y),n.q.min=Math.min(n.q.min,e.coord.q),n.q.max=Math.max(n.q.max,e.coord.q),n.r.min=Math.min(n.r.min,e.coord.r),n.r.max=Math.max(n.r.max,e.coord.r)}),n}}function Vt(){const S=document.getElementById("app"),t=document.querySelector(".map-container");if(!S||!t)return;const n=document.createElement("canvas");function e(){if(!t)return{width:0,height:0};const f=t.getBoundingClientRect(),P=window.devicePixelRatio||1;n.style.width=`${f.width}px`,n.style.height=`${f.height}px`,n.width=f.width*P,n.height=f.height*P;const m=n.getContext("2d");return m&&m.scale(P,P),{width:f.width,height:f.height}}const i=e();t.appendChild(n);const s=document.createElement("button");s.className="map-control-button",s.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1v22M8 18l4 4 4-4M8 6l4-4 4 4"/>
        <path d="M1 12h22M18 8l4 4-4 4M6 8l-4 4 4 4"/>
    </svg>`,s.title="Drag Mode",s.addEventListener("click",()=>v.selectDragTool()),s.style.outline="2px solid #4B9CD3",s.style.outlineOffset="-2px",t.appendChild(s);const o=document.createElement("button");o.className="map-control-button",o.style.left="60px",o.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="11" y1="8" x2="11" y2="14"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
    </svg>`,o.title="Zoom In",o.addEventListener("click",()=>p.updateZoom(100,n.width/2,n.height/2)),t.appendChild(o);const r=document.createElement("button");r.className="map-control-button",r.style.left="110px",r.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
    </svg>`,r.title="Zoom Out",r.addEventListener("click",()=>p.updateZoom(-100,n.width/2,n.height/2)),t.appendChild(r);const c=document.createElement("button");c.className="map-control-button",c.style.left="160px",c.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v4M12 18v4M4 12H2M22 12h-4"/>
        <circle cx="12" cy="12" r="6"/>
    </svg>`,c.title="Recenter Map",c.addEventListener("click",()=>{const{zoom:f,centerX:P,centerY:m}=U();p.setZoom(f),p.setPanPosition(P,m),p.render()}),t.appendChild(c);const h=30;let l=35,d=20,g=0,x=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3)));const v=new Gt,p=new Yt(n,v),u=new Xt(p),b=new jt(p);p.setZoom(.7);const C=250;p.setPanPosition((i.width-C)/2,i.height/2),document.addEventListener("maploaded",f=>{const{dimensions:P,totalLeftOperations:m,tiles:R,paths:H}=f.detail;l=P.columns,d=P.rows,g=m;const O=h*2*3/4,_=h*Math.sqrt(3),I=Math.ceil(l*O),X=Math.ceil(d*_);x=new Ot(h,I,X);const z=x.generateGrid(g),A=new Map;R.forEach(E=>{A.set(`${E.coord.q},${E.coord.r}`,E)});const N=z.map(E=>{const lt=`${E.coord.q},${E.coord.r}`,tt=A.get(lt);return tt?{...E,terrain:tt.terrain,specialTerrain:tt.specialTerrain,customTerrain:tt.customTerrain,treeOverlay:tt.treeOverlay,abovePaths:tt.abovePaths}:E}),L=document.querySelector(".dimensions");L&&(L.textContent=`${l}×${d}`),w=N,p.setTiles(N),p.setPaths(H),v.setPaths(H),v.deselectAll(),v.selectDragTool(),u.updateGridDimensions(l,d),u.deselectAll(),p.render();const{zoom:nt,centerX:ot,centerY:K}=U();p.setZoom(nt),p.setPanPosition(ot,K)}),u.setTerrainSelectCallback(()=>{v.deselectAll(),s.style.outline="none",s.style.outlineOffset="0"}),u.setGridSizeChangeCallback(f=>{let P=!1;switch(f){case"col+left":case"col+right":P=l<50;break;case"col-left":case"col-right":P=l>5;break;case"row+top":case"row+bottom":P=d<30;break;case"row-top":case"row-bottom":P=d>5;break}if(!P)return;switch(M(),f){case"col+left":l++,g++;break;case"col+right":l++;break;case"col-left":l--,g++;break;case"col-right":l--;break;case"row+top":case"row+bottom":d++;break;case"row-top":case"row-bottom":d--;break}let m=0,R=0;(f==="col+left"||f==="col-left")&&(m=f==="col+left"?1:-1),(f==="row+top"||f==="row-top")&&(R=f==="row+top"?1:-1);const H=h*2*3/4,O=h*Math.sqrt(3),_=Math.ceil(l*H),I=Math.ceil(d*O);x=new Ot(h,_,I);const X=x.generateGrid(g),z=new Map;w.forEach(L=>{z.set(`${L.coord.q},${L.coord.r}`,L)});for(const L of X){const nt=L.coord.q-m,ot=L.coord.r-R,K=`${nt},${ot}`,E=z.get(K);E&&(L.terrain=E.terrain,L.specialTerrain=E.specialTerrain,L.customTerrain=E.customTerrain,L.treeOverlay=E.treeOverlay,L.abovePaths=E.abovePaths)}let A=0,N=0;switch(f){case"col+left":case"col-left":A=f==="col+left"?1:-1;break;case"col+right":case"col-right":A=f==="col+right"?-1:1;break;case"row+top":case"row-top":N=f==="row+top"?1:-1;break;case"row+bottom":case"row-bottom":N=f==="row+bottom"?-1:1;break}if(A!==0||N!==0){const L=p.getPaths(),nt=h*2*3/4,ot=h*Math.sqrt(3),K=L.map(Mt=>{var Ct;return{...Mt,points:Mt.points.map(Pt=>({x:Pt.x+A*nt/2,y:Pt.y+N*ot/2})),smoothPoints:(Ct=Mt.smoothPoints)==null?void 0:Ct.map(Pt=>({x:Pt.x+A*nt/2,y:Pt.y+N*ot/2}))}}),E=l*nt,lt=d*ot,tt=h*2,vt=-E/2-tt/4,wt=E/2-tt/4,Nt=-lt/2,At=lt/2,Lt=[];K.forEach(Mt=>{let Ct=[],Pt=!1;Mt.points.forEach(Rt=>{const Ut=Rt.x>=vt&&Rt.x<=wt&&Rt.y>=Nt&&Rt.y<=At;Ut?(Ct.push(Rt),!Pt&&Ct.length>1&&(Ct=[Rt])):Pt&&Ct.length>=2&&(Lt.push({...Mt,points:[...Ct],smoothPoints:void 0}),Ct=[]),Pt=Ut}),Ct.length>=2&&Lt.push({...Mt,points:Ct,smoothPoints:void 0})}),v.setPaths(Lt),p.setPaths(Lt)}w=X,p.setTiles(w),u.updateGridDimensions(l,d),p.render()}),v.setToolChangeCallback(()=>{u.deselectAll(),v.isDragMode()?(s.style.outline="2px solid #4B9CD3",s.style.outlineOffset="-2px"):(s.style.outline="none",s.style.outlineOffset="0")});let w=x.generateGrid();p.setTiles(w);let et=null;const U=()=>{const f=t.getBoundingClientRect(),P=250,m=60,R=h*2*3/4,H=h*Math.sqrt(3),O=l*R+m*2,_=d*H+50,I=(f.width-P)/O,X=f.height/_,z=Math.min(I,X)*.9;return{zoom:Math.max(.5,Math.min(z,3)),centerX:(f.width-P)/2,centerY:f.height/2}};window.addEventListener("resize",()=>{et&&window.clearTimeout(et),et=window.setTimeout(()=>{e();const{zoom:f,centerX:P,centerY:m}=U();p.setZoom(f),p.setPanPosition(P,m),p.render()},250)});const B=document.createElement("div");B.className="toolbar";const Q=document.createElement("div");Q.className="undo-redo-container";const y=[],q=[];let $=!1;function M(){const f={tiles:w.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0})),paths:p.getPaths().map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0})),cols:l,rows:d,leftOperations:g},P=y[y.length-1];(!P||!G(P,f))&&(y.push(f),q.length=0)}function G(f,P){if(f.cols!==P.cols||f.rows!==P.rows||f.leftOperations!==P.leftOperations||f.paths.length!==P.paths.length||f.tiles.length!==P.tiles.length)return!1;for(let m=0;m<f.tiles.length;m++){const R=f.tiles[m],H=P.tiles[m];if(R.terrain!==H.terrain||R.specialTerrain!==H.specialTerrain||R.abovePaths!==H.abovePaths||JSON.stringify(R.customTerrain)!==JSON.stringify(H.customTerrain)||JSON.stringify(R.treeOverlay)!==JSON.stringify(H.treeOverlay))return!1}for(let m=0;m<f.paths.length;m++){const R=f.paths[m],H=P.paths[m];if(R.type!==H.type||R.width!==H.width||R.points.length!==H.points.length)return!1;for(let O=0;O<R.points.length;O++)if(R.points[O].x!==H.points[O].x||R.points[O].y!==H.points[O].y)return!1}return!0}const k=()=>{if(!($||y.length===0)){$=!0;try{const f=y.pop();if(f){const P={tiles:w.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0})),paths:v.getPaths().map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0})),cols:l,rows:d,leftOperations:g};q.push(P),bt(f)}}finally{$=!1}}},gt=()=>{if(!($||q.length===0)){$=!0;try{const f=q.pop();if(f){const P={tiles:w.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0})),paths:v.getPaths().map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0})),cols:l,rows:d,leftOperations:g};y.push(P),bt(f)}}finally{$=!1}}};function bt(f){l=f.cols,d=f.rows,g=f.leftOperations,x=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3))),w=f.tiles.map(m=>({coord:{...m.coord},terrain:m.terrain,specialTerrain:m.specialTerrain,customTerrain:m.customTerrain?{...m.customTerrain}:void 0,center:{...m.center},vertices:[...m.vertices],abovePaths:m.abovePaths,treeOverlay:m.treeOverlay?{...m.treeOverlay}:void 0}));const P=f.paths.map(m=>({...m,points:[...m.points],smoothPoints:m.smoothPoints?[...m.smoothPoints]:void 0}));p.setTiles(w),p.setPaths(P),v.setPaths(P),u.updateGridDimensions(l,d),p.render()}n.addEventListener("wheel",f=>{if(V){f.preventDefault();return}f.preventDefault();const P=n.getBoundingClientRect(),m=f.clientX-P.left,R=f.clientY-P.top;p.updateZoom(-f.deltaY,m,R)},{passive:!1});let xt=!1,pt=!1,mt=!1,T=null,F=0,Y=0,rt=0,st=0;function it(f,P,m,R){const H=[],O=Math.hypot(m-f,R-P);if(O<5){const I=p.screenToMapCoordinates(m,R),X=w.find(z=>It(I,z.vertices));return X&&H.push(X),H}const _=Math.max(2,Math.ceil(O/10));for(let I=0;I<=_;I++){const X=I/_,z=f+(m-f)*X,A=P+(R-P)*X,N=p.screenToMapCoordinates(z,A),L=w.find(nt=>It(N,nt.vertices));L&&!H.some(nt=>nt.coord.q===L.coord.q&&nt.coord.r===L.coord.r)&&H.push(L)}return H}n.addEventListener("mousedown",f=>{if(V)return;const P=n.getBoundingClientRect(),m=f.clientX-P.left,R=f.clientY-P.top;if(rt=m,st=R,v.isDragMode())mt=!0,n.style.cursor="grabbing",F=m,Y=R;else if(v.getCurrentTool()===St.PATH||v.getCurrentTool()===St.RIVER){const H=p.screenToMapCoordinates(m,R),O=w.find(_=>It(H,_.vertices));O&&(M(),xt=!0,v.startPath(O.center),p.setCurrentPath(v.getCurrentPath()))}else if(u.isTerrainSelected()){const H=p.screenToMapCoordinates(m,R),O=w.find(_=>It(H,_.vertices));if(O){const _=u.getSelectedTerrain();if(u.getDrawMode()==="FILL"){pt=!0;return}if(M(),pt=!0,_===a.NONE){if(u.getDrawMode()==="FILL")if(M(),O.terrain===a.NONE&&O.specialTerrain!==void 0){const X=O.specialTerrain,z=new Set,A=[O];for(;A.length>0;){const N=A.shift(),L=`${N.coord.q},${N.coord.r}`;if(!z.has(L)&&(z.add(L),N.terrain===a.NONE&&N.specialTerrain===X)){p.setTileTerrain(N,a.NONE),N.abovePaths=u.isDrawAbovePaths();const nt=zt(N);for(const ot of nt){const K=w.find(E=>E.coord.q===ot.q&&E.coord.r===ot.r);K&&A.push(K)}}}p.render()}else ht(O,O.terrain,_);else p.setTileTerrain(O,a.NONE),O.abovePaths=u.isDrawAbovePaths(),p.render();return}const I=u.getCustomTerrainData();p.setTileTerrain(O,_,I||void 0),O.abovePaths=u.isDrawAbovePaths(),T=`${O.coord.q},${O.coord.r}`,p.render()}}else v.getCurrentTool()===St.REMOVE&&(M(),pt=!0)}),n.addEventListener("mousemove",f=>{const P=n.getBoundingClientRect(),m=f.clientX-P.left,R=f.clientY-P.top,H=p.screenToMapCoordinates(m,R),O=w.find(_=>It(H,_.vertices));if(mt||p.setHoveredTile(O||null),mt){const _=m-F,I=R-Y;p.pan(_,I),F=m,Y=R}else if(xt&&O)it(rt,st,m,R).forEach(I=>{v.updatePath(I.center)}),p.setCurrentPath(v.getCurrentPath());else if(pt&&O&&u.getDrawMode()==="DRAW"&&u.isTerrainSelected()){const _=it(rt,st,m,R);_.forEach(I=>{const X=`${I.coord.q},${I.coord.r}`;if(X!==T){const z=u.getSelectedTerrain();if(z===a.NONE){p.setTileTerrain(I,a.NONE),I.abovePaths=u.isDrawAbovePaths(),T=X;return}const A=u.getCustomTerrainData();p.setTileTerrain(I,z,A||void 0),I.abovePaths=u.isDrawAbovePaths(),T=X}}),_.length>0&&p.render()}else if(pt&&O&&v.getCurrentTool()===St.REMOVE){const _=it(rt,st,m,R);if(_.length>0){const I=[];let X=!1;v.getPaths().forEach(z=>{let A=[],N=!0;z.points.forEach(L=>{const nt=_.some(ot=>{let K=!1;const E=ot.vertices;for(let lt=0,tt=E.length-1;lt<E.length;tt=lt++){const vt=E[lt].x,wt=E[lt].y,Nt=E[tt].x,At=E[tt].y;wt>L.y!=At>L.y&&L.x<(Nt-vt)*(L.y-wt)/(At-wt)+vt&&(K=!K)}return K});nt?N&&A.length>=2&&(I.push({points:[...A],type:z.type,width:z.width,strokeStyle:z.strokeStyle}),X=!0,A=[]):(A.push(L),!N&&A.length>=2&&(I.push({points:[...A],type:z.type,width:z.width,strokeStyle:z.strokeStyle}),X=!0,A=[L])),N=!nt}),A.length>=2&&(I.push({points:[...A],type:z.type,width:z.width,strokeStyle:z.strokeStyle}),X=!0)}),X&&(v.setPaths(I),p.setPaths(I),p.render())}}rt=m,st=R}),n.addEventListener("mouseup",()=>{mt?(mt=!1,n.style.cursor="grab"):xt&&(xt=!1,v.endPath(),p.setCurrentPath([]),p.setPaths(v.getPaths())),pt=!1,T=null}),n.addEventListener("mouseover",()=>{v.isDragMode()?n.style.cursor="grab":v.isDrawingMode()||u.isTerrainSelected()||v.getCurrentTool()===St.REMOVE?n.style.cursor="crosshair":n.style.cursor="default"}),n.addEventListener("mouseleave",()=>{mt&&(mt=!1,n.style.cursor="grab"),xt&&(xt=!1,v.endPath(),p.setPaths(v.getPaths())),pt=!1,T=null});let V=!1;function j(f){V=f,n.style.cursor=f?"wait":"default",document.body.classList.toggle("app-loading",f)}function ht(f,P,m){if(P===m)return;j(!0);const R=new Set,H=[],O=[f],_=u.isDrawAbovePaths(),I=u.getCustomTerrainData(),X=Dt.has(m),z=f.specialTerrain,A=P===a.NONE&&z!==void 0,N=document.createElement("div");N.style.position="fixed",N.style.top="50%",N.style.left="50%",N.style.transform="translate(-50%, -50%)",N.style.padding="20px",N.style.backgroundColor="rgba(0, 0, 0, 0.7)",N.style.color="white",N.style.borderRadius="5px",N.style.zIndex="1000",N.textContent="Processing terrain...",document.body.appendChild(N);const L=100;function nt(E){if(m===a.NONE){if(A)return E.terrain===a.NONE&&E.specialTerrain===z;const lt=E.terrain===P,tt=z===void 0&&E.specialTerrain===void 0||z!==void 0&&E.specialTerrain===z;return lt&&tt}return X?z?E.specialTerrain===z:E.specialTerrain===void 0:E.terrain===P}function ot(){for(;O.length>0;){const E=O.shift(),lt=`${E.coord.q},${E.coord.r}`;if(R.has(lt)||(R.add(lt),!nt(E)))continue;H.push(E);const tt=zt(E);for(const vt of tt){const wt=w.find(Nt=>Nt.coord.q===vt.q&&Nt.coord.r===vt.r);wt&&O.push(wt)}}K(0)}function K(E){const lt=Math.min(100,Math.round(E/H.length*100));if(N.textContent=`Processing terrain... ${lt}%`,E>=H.length){document.body.removeChild(N),j(!1),p.render();return}const tt=Math.min(E+L,H.length);for(let vt=E;vt<tt;vt++){const wt=H[vt];m===a.NONE?p.setTileTerrain(wt,a.NONE):X?(wt.specialTerrain=m,delete wt.treeOverlay):m===a.CUSTOM&&I?p.setTileTerrain(wt,m,I):p.setTileTerrain(wt,m),wt.abovePaths=_}requestAnimationFrame(()=>K(tt))}ot()}n.addEventListener("click",f=>{if(!V&&!v.isDrawingMode()){const P=n.getBoundingClientRect(),m=f.clientX-P.left,R=f.clientY-P.top,H=p.screenToMapCoordinates(m,R),O=w.find(_=>It(H,_.vertices));if(O){if(v.getCurrentTool()===St.REMOVE){M();const I=O.vertices,X=A=>{let N=!1;for(let L=0,nt=I.length-1;L<I.length;nt=L++){const ot=I[L].x,K=I[L].y,E=I[nt].x,lt=I[nt].y;K>A.y!=lt>A.y&&A.x<(E-ot)*(A.y-K)/(lt-K)+ot&&(N=!N)}return N},z=[];v.getPaths().forEach(A=>{const N=[];let L=[];A.points.forEach((nt,ot)=>{X(nt)?L.length>0&&(N.push([...L]),L=[]):L.push(nt),ot===A.points.length-1&&L.length>0&&N.push([...L])}),N.forEach(nt=>{if(nt.length>=2){const ot={points:nt,type:A.type,width:A.width,strokeStyle:A.strokeStyle};z.push(ot)}})}),v.setPaths(z),p.setPaths(z),p.render()}else if(u.isTerrainSelected()){const I=u.getSelectedTerrain();if(I===a.NONE){if(u.getDrawMode()==="FILL")if(M(),O.terrain===a.NONE&&O.specialTerrain!==void 0){const X=O.specialTerrain,z=new Set,A=[O];for(;A.length>0;){const N=A.shift(),L=`${N.coord.q},${N.coord.r}`;if(!z.has(L)&&(z.add(L),N.terrain===a.NONE&&N.specialTerrain===X)){p.setTileTerrain(N,a.NONE),N.abovePaths=u.isDrawAbovePaths();const nt=zt(N);for(const ot of nt){const K=w.find(E=>E.coord.q===ot.q&&E.coord.r===ot.r);K&&A.push(K)}}}p.render()}else ht(O,O.terrain,I);else p.setTileTerrain(O,a.NONE),O.abovePaths=u.isDrawAbovePaths(),p.render();return}if(u.getDrawMode()==="FILL"){const X=O.terrain;(Dt.has(I)||X!==I)&&(M(),ht(O,X,I))}else{const X=u.getCustomTerrainData();p.setTileTerrain(O,I,X||void 0),O.abovePaths=u.isDrawAbovePaths(),p.render()}}}}});const dt=document.createElement("button");dt.className="map-control-button",dt.style.left="210px",dt.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7v6h6"/>
        <path d="M3 13c0-4.97 4.03-9 9-9 4.97 0 9 4.03 9 9s-4.03 9-9 9c-2.49 0-4.74-1.01-6.36-2.64"/>
    </svg>`,dt.title="Undo",dt.addEventListener("click",k),t.appendChild(dt);const ct=document.createElement("button");ct.className="map-control-button",ct.style.left="260px",ct.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 7v6h-6"/>
        <path d="M21 13c0-4.97-4.03-9-9-9-4.97 0-9 4.03-9 9s4.03 9 9 9c2.49 0 4.74-1.01 6.36-2.64"/>
    </svg>`,ct.title="Redo",ct.addEventListener("click",gt),t.appendChild(ct);const ft=document.createElement("div");ft.className="grid-size-controls";const at=document.createElement("button");at.className="map-control-button",at.style.cssText=`
        position: absolute;
        left: 310px;
        top: 10px;
        padding: 6px 12px;
        background: rgba(32, 32, 32, 0.8);
        border: 1px solid rgba(64, 64, 64, 0.6);
        border-radius: 6px;
        color: currentColor;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
        min-width: 130px;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    `,at.textContent="Grid Numbers: On",at.title="Toggle Grid Numbers";let yt=!0;at.addEventListener("mouseover",()=>{at.style.background="rgba(42, 42, 42, 0.9)",at.style.borderColor="rgba(80, 80, 80, 0.8)"}),at.addEventListener("mouseout",()=>{at.style.background="rgba(32, 32, 32, 0.8)",at.style.borderColor="rgba(64, 64, 64, 0.6)"}),at.addEventListener("click",()=>{yt=!yt,at.textContent=`Grid Numbers: ${yt?"On":"Off"}`,p.setShowGridNumbers(yt),p.render()}),t.appendChild(at);const D=f=>{M();let P=0,m=0;switch(f){case"col+left":P=1;break;case"col-left":P=-1;break;case"row+top":m=1;break;case"row-top":m=-1;break}x=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3)));const R=x.generateGrid(g);for(const K of R){let E=K.coord.q,lt=K.coord.r;f.includes("col")&&(E-=P),f.includes("row")&&(lt-=m);const tt=w.find(vt=>vt.coord.q===E&&vt.coord.r===lt);tt&&(K.terrain=tt.terrain,K.specialTerrain=tt.specialTerrain,K.customTerrain=tt.customTerrain,K.abovePaths=tt.abovePaths,K.treeOverlay=tt.treeOverlay)}const H=h*2*3/4,O=h*Math.sqrt(3),_=l*H,I=d*O,X=h*2,z=-_/2-X/4,A=_/2-X/4,N=-I/2,L=I/2,nt=v.getPaths(),ot=[];nt.forEach(K=>{let E=[],lt=!1;K.points.forEach(tt=>{const vt=tt.x>=z&&tt.x<=A&&tt.y>=N&&tt.y<=L;vt?(E.push(tt),!lt&&E.length>1&&(E=[tt])):lt&&E.length>=2&&(ot.push({...K,points:[...E],smoothPoints:void 0}),E=[]),lt=vt}),E.length>=2&&ot.push({...K,points:E,smoothPoints:void 0})}),v.setPaths(ot),p.setPaths(ot),w=R,p.setTiles(w),p.render()},Z=document.createElement("div");Z.className="grid-control top";const J=document.createElement("div");J.className="middle-controls";const ut=document.createElement("div");ut.className="grid-control bottom";const Tt=()=>{const f=J.querySelector(".dimensions");f&&(f.textContent=`${l}×${d}`)},Et=(f,P)=>{const m=document.createElement("button");m.textContent=f.includes("+")?"+":"-",m.title=f,m.className=f.includes("+")?"plus":"minus",m.addEventListener("click",()=>{let R=!1;switch(f){case"col+left":case"col+right":l<50&&(l++,R=!0);break;case"col-left":case"col-right":l>5&&(l--,R=!0);break;case"row+top":case"row+bottom":d<30&&(d++,R=!0);break;case"row-top":case"row-bottom":d>5&&(d--,R=!0);break}R&&(Tt(),x=new Ot(h,Math.ceil(l*h*2*3/4),Math.ceil(d*h*Math.sqrt(3))),D(f))}),P.appendChild(m)};Et("row-top",Z),Et("row+top",Z),Et("col-left",J),Et("col+left",J);const Wt=document.createElement("div");Wt.className="dimensions",Wt.textContent=`${l}×${d}`,J.appendChild(Wt),Et("col-right",J),Et("col+right",J),Et("row-bottom",ut),Et("row+bottom",ut),ft.appendChild(Z),ft.appendChild(J),ft.appendChild(ut),t.appendChild(ft),B.appendChild(u.getElement()),B.appendChild(v.getElement()),B.appendChild(b.createExportButtons()),S.insertBefore(B,t)}function It(S,t){let n=!1;for(let e=0,i=t.length-1;e<t.length;i=e++){const s=t[e].x,o=t[e].y,r=t[i].x,c=t[i].y;o>S.y!=c>S.y&&S.x<(r-s)*(S.y-o)/(c-o)+s&&(n=!n)}return n}function zt(S){const t=S.coord.q,n=S.coord.r,e=t%2===1;return[{q:t,r:n-1},{q:t+1,r:e?n:n-1},{q:t+1,r:e?n+1:n},{q:t,r:n+1},{q:t-1,r:e?n+1:n},{q:t-1,r:e?n:n-1}]}document.addEventListener("DOMContentLoaded",Vt);
